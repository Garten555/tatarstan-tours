# üìö –î–∏–ø–ª–æ–º–Ω—ã–π –ø—Ä–æ–µ–∫—Ç: –ü–ª–∞—Ç—Ñ–æ—Ä–º–∞ —Ç—É—Ä–æ–≤ –ø–æ –¢–∞—Ç–∞—Ä—Å—Ç–∞–Ω—É

## üìã –û–≥–ª–∞–≤–ª–µ–Ω–∏–µ
1. [–û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞](#–æ–ø–∏—Å–∞–Ω–∏–µ-–ø—Ä–æ–µ–∫—Ç–∞)
2. [–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å–∏—Å—Ç–µ–º—ã](#–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞-—Å–∏—Å—Ç–µ–º—ã)
3. [–¢–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π —Å—Ç–µ–∫](#—Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π-—Å—Ç–µ–∫)
4. [–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö](#—Å—Ç—Ä—É–∫—Ç—É—Ä–∞-–±–∞–∑—ã-–¥–∞–Ω–Ω—ã—Ö)
5. [–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏](#—Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ-–≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏)
6. [API Endpoints](#api-endpoints)
7. [–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏](#–∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏)
8. [–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å](#–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å)
9. [–†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ](#—Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ)

---

## üìù –û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞

**–ù–∞–∑–≤–∞–Ω–∏–µ:** –ü–ª–∞—Ç—Ñ–æ—Ä–º–∞ —Ç—É—Ä–æ–≤ –ø–æ –¢–∞—Ç–∞—Ä—Å—Ç–∞–Ω—É  
**–¢–∏–ø:** Web-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ç—É—Ä–∏—Å—Ç–∏—á–µ—Å–∫–∏–º–∏ —Ç—É—Ä–∞–º–∏  
**–¶–µ–ª—å:** –°–æ–∑–¥–∞–Ω–∏–µ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–π –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã –¥–ª—è –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ –∏ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è —Ç—É—Ä–æ–≤ –ø–æ –¥–æ—Å—Ç–æ–ø—Ä–∏–º–µ—á–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—è–º –¢–∞—Ç–∞—Ä—Å—Ç–∞–Ω–∞ —Å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–µ–π –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã—Ö –∫–∞—Ä—Ç, —Å–∏—Å—Ç–µ–º–æ–π –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –∏ AI-–ø–æ–¥–¥–µ—Ä–∂–∫–æ–π.

### –û—Å–Ω–æ–≤–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:
- ‚úÖ –ö–∞—Ç–∞–ª–æ–≥ —Ç—É—Ä–æ–≤ —Å –¥–µ—Ç–∞–ª—å–Ω—ã–º –æ–ø–∏—Å–∞–Ω–∏–µ–º
- ‚úÖ –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–µ –∫–∞—Ä—Ç—ã –º–∞—Ä—à—Ä—É—Ç–æ–≤ (–Ø–Ω–¥–µ–∫—Å.–ö–∞—Ä—Ç—ã)
- ‚úÖ –°–∏—Å—Ç–µ–º–∞ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –±–∏–ª–µ—Ç–æ–≤ (PDF)
- ‚úÖ Email-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
- ‚úÖ –ß–∞—Ç –ø–æ–¥–¥–µ—Ä–∂–∫–∏ —Å AI-–∞–≥–µ–Ω—Ç–æ–º
- ‚úÖ –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω—ã–µ –ø–∞–Ω–µ–ª–∏ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ä–æ–ª–µ–π
- ‚úÖ –û–±–ª–∞—á–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –º–µ–¥–∏–∞ (Timeweb S3)
- ‚úÖ CDN –¥–ª—è –±—ã—Å—Ç—Ä–æ–π –¥–æ—Å—Ç–∞–≤–∫–∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞

---

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å–∏—Å—Ç–µ–º—ã

### –ö–ª–∏–µ–Ω—Ç-—Å–µ—Ä–≤–µ—Ä–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                     CLIENT (Browser)                         ‚îÇ
‚îÇ                                                              ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê        ‚îÇ
‚îÇ  ‚îÇ   React/    ‚îÇ  ‚îÇ  Yandex     ‚îÇ  ‚îÇ  WebSocket  ‚îÇ        ‚îÇ
‚îÇ  ‚îÇ  Next.js    ‚îÇ  ‚îÇ   Maps      ‚îÇ  ‚îÇ   Client    ‚îÇ        ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò        ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                            ‚îÇ HTTPS
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    SERVER (Next.js 15)                       ‚îÇ
‚îÇ                                                              ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê           ‚îÇ
‚îÇ  ‚îÇ    API     ‚îÇ  ‚îÇ  Server    ‚îÇ  ‚îÇ  WebSocket ‚îÇ           ‚îÇ
‚îÇ  ‚îÇ   Routes   ‚îÇ  ‚îÇ  Actions   ‚îÇ  ‚îÇ   Server   ‚îÇ           ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò           ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                            ‚îÇ
        ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
        ‚îÇ                   ‚îÇ                   ‚îÇ
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   Supabase     ‚îÇ  ‚îÇ  OpenRouter ‚îÇ  ‚îÇ   File System   ‚îÇ
‚îÇ   (PostgreSQL) ‚îÇ  ‚îÇ     AI      ‚îÇ  ‚îÇ  (Media Store)  ‚îÇ
‚îÇ                ‚îÇ  ‚îÇ             ‚îÇ  ‚îÇ                 ‚îÇ
‚îÇ  ‚Ä¢ Database    ‚îÇ  ‚îÇ  ‚Ä¢ GPT-4    ‚îÇ  ‚îÇ  ‚Ä¢ Images       ‚îÇ
‚îÇ  ‚Ä¢ Auth        ‚îÇ  ‚îÇ  ‚Ä¢ Claude   ‚îÇ  ‚îÇ  ‚Ä¢ Videos       ‚îÇ
‚îÇ  ‚Ä¢ Storage     ‚îÇ  ‚îÇ  ‚Ä¢ Llama    ‚îÇ  ‚îÇ  ‚Ä¢ PDFs         ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### –ö–æ–º–ø–æ–Ω–µ–Ω—Ç–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

```
app/
‚îú‚îÄ‚îÄ (public)/              # –ü—É–±–ª–∏—á–Ω—ã–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
‚îÇ   ‚îú‚îÄ‚îÄ page.tsx          # –ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞
‚îÇ   ‚îú‚îÄ‚îÄ tours/            # –ö–∞—Ç–∞–ª–æ–≥ —Ç—É—Ä–æ–≤
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ [slug]/page.tsx  # –°—Ç—Ä–∞–Ω–∏—Ü–∞ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Ç—É—Ä–∞
‚îÇ   ‚îú‚îÄ‚îÄ booking/          # –ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ page.tsx      # –§–æ—Ä–º–∞ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ success/page.tsx  # –°—Ç—Ä–∞–Ω–∏—Ü–∞ —É—Å–ø–µ—à–Ω–æ–≥–æ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
‚îÇ   ‚îú‚îÄ‚îÄ auth/             # –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è
‚îÇ   ‚îú‚îÄ‚îÄ about/            # –û –Ω–∞—Å
‚îÇ   ‚îî‚îÄ‚îÄ contacts/         # –ö–æ–Ω—Ç–∞–∫—Ç—ã
‚îú‚îÄ‚îÄ (protected)/          # –ó–∞—â–∏—â—ë–Ω–Ω—ã–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
‚îÇ   ‚îî‚îÄ‚îÄ profile/          # –ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
‚îÇ       ‚îî‚îÄ‚îÄ page.tsx      # –°—Ç—Ä–∞–Ω–∏—Ü–∞ –ø—Ä–æ—Ñ–∏–ª—è —Å –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è–º–∏
‚îú‚îÄ‚îÄ admin/                # –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏
‚îÇ   ‚îú‚îÄ‚îÄ layout.tsx        # Layout –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏ —Å —Å–∞–π–¥–±–∞—Ä–æ–º
‚îÇ   ‚îú‚îÄ‚îÄ page.tsx          # –ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏
‚îÇ   ‚îú‚îÄ‚îÄ tours/            # –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç—É—Ä–∞–º–∏
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ page.tsx      # –°–ø–∏—Å–æ–∫ —Ç—É—Ä–æ–≤
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ create/page.tsx  # –°–æ–∑–¥–∞–Ω–∏–µ —Ç—É—Ä–∞
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ [id]/edit/page.tsx  # –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç—É—Ä–∞
‚îÇ   ‚îú‚îÄ‚îÄ bookings/         # –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è–º–∏ ‚ú® NEW
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ page.tsx      # –°–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ [id]/page.tsx # –î–µ—Ç–∞–ª—å–Ω—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
‚îÇ   ‚îú‚îÄ‚îÄ users/            # –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏
‚îÇ   ‚îî‚îÄ‚îÄ chat/             # –ß–∞—Ç –ø–æ–¥–¥–µ—Ä–∂–∫–∏
‚îî‚îÄ‚îÄ api/                  # API Routes
    ‚îú‚îÄ‚îÄ tours/            # CRUD —Ç—É—Ä–æ–≤
    ‚îú‚îÄ‚îÄ bookings/         # –ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è ‚ú® NEW
    ‚îÇ   ‚îî‚îÄ‚îÄ route.ts      # POST - —Å–æ–∑–¥–∞–Ω–∏–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
    ‚îú‚îÄ‚îÄ user/             # API –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π ‚ú® NEW
    ‚îÇ   ‚îú‚îÄ‚îÄ bookings/route.ts  # GET - –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    ‚îÇ   ‚îî‚îÄ‚îÄ cards/        # –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–∞—Ä—Ç–∞–º–∏ ‚ú® NEW
    ‚îÇ       ‚îú‚îÄ‚îÄ route.ts   # GET, POST - —Å–ø–∏—Å–æ–∫ –∏ —Å–æ–∑–¥–∞–Ω–∏–µ
    ‚îÇ       ‚îî‚îÄ‚îÄ [id]/route.ts  # DELETE, PATCH - —É–¥–∞–ª–µ–Ω–∏–µ –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
    ‚îú‚îÄ‚îÄ admin/            # –ê–¥–º–∏–Ω API
    ‚îÇ   ‚îú‚îÄ‚îÄ bookings/     # –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è–º–∏ ‚ú® NEW
    ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ route.ts  # GET - —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π
    ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ [id]/route.ts  # PATCH - –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–æ–≤
    ‚îÇ   ‚îî‚îÄ‚îÄ cities/       # –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≥–æ—Ä–æ–¥–∞–º–∏ ‚ú® NEW
    ‚îÇ       ‚îú‚îÄ‚îÄ route.ts  # GET - –ø–æ–∏—Å–∫ –≥–æ—Ä–æ–¥–æ–≤
    ‚îÇ       ‚îî‚îÄ‚îÄ [id]/route.ts  # GET - –≥–æ—Ä–æ–¥ –ø–æ ID
    ‚îú‚îÄ‚îÄ chat/             # WebSocket —á–∞—Ç
    ‚îî‚îÄ‚îÄ upload/           # –ó–∞–≥—Ä—É–∑–∫–∞ –º–µ–¥–∏–∞
```

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤

```
components/
‚îú‚îÄ‚îÄ layout/               # –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –º–∞–∫–µ—Ç–∞
‚îÇ   ‚îú‚îÄ‚îÄ Header.tsx       # –®–∞–ø–∫–∞ —Å–∞–π—Ç–∞ —Å –Ω–∞–≤–∏–≥–∞—Ü–∏–µ–π
‚îÇ   ‚îú‚îÄ‚îÄ Footer.tsx       # –ü–æ–¥–≤–∞–ª —Å–∞–π—Ç–∞
‚îÇ   ‚îî‚îÄ‚îÄ UserMenu.tsx     # –ú–µ–Ω—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —à–∞–ø–∫–µ
‚îú‚îÄ‚îÄ booking/             # –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è ‚ú® NEW
‚îÇ   ‚îî‚îÄ‚îÄ BookingForm.tsx  # –§–æ—Ä–º–∞ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è —Å –≤—ã–±–æ—Ä–æ–º –æ–ø–ª–∞—Ç—ã
‚îú‚îÄ‚îÄ profile/             # –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –ø—Ä–æ—Ñ–∏–ª—è
‚îÇ   ‚îú‚îÄ‚îÄ ProfileContent.tsx  # –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç –ø—Ä–æ—Ñ–∏–ª—è
‚îÇ   ‚îî‚îÄ‚îÄ UserBookings.tsx # –°–ø–∏—Å–æ–∫ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ‚ú® NEW
‚îú‚îÄ‚îÄ admin/               # –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏
‚îÇ   ‚îú‚îÄ‚îÄ AdminSidebar.tsx # –ë–æ–∫–æ–≤–æ–µ –º–µ–Ω—é –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏
‚îÇ   ‚îú‚îÄ‚îÄ TourForm.tsx     # –§–æ—Ä–º–∞ —Å–æ–∑–¥–∞–Ω–∏—è/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ç—É—Ä–∞
‚îÇ   ‚îú‚îÄ‚îÄ BookingsList.tsx # –°–ø–∏—Å–æ–∫ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π (–∞–¥–º–∏–Ω) ‚ú® NEW
‚îÇ   ‚îî‚îÄ‚îÄ BookingDetails.tsx  # –î–µ—Ç–∞–ª–∏ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è (–∞–¥–º–∏–Ω) ‚ú® NEW
‚îú‚îÄ‚îÄ tours/               # –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Ç—É—Ä–æ–≤
‚îÇ   ‚îú‚îÄ‚îÄ TourCard.tsx     # –ö–∞—Ä—Ç–æ—á–∫–∞ —Ç—É—Ä–∞ –≤ —Å–ø–∏—Å–∫–µ
‚îÇ   ‚îú‚îÄ‚îÄ TourShortDescription.tsx  # –ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ
‚îÇ   ‚îî‚îÄ‚îÄ VideoPlayer.tsx  # –í–∏–¥–µ–æ–ø–ª–µ–µ—Ä Plyr ‚ú® NEW
‚îî‚îÄ‚îÄ ui/                  # UI –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
    ‚îî‚îÄ‚îÄ Logo.tsx         # –õ–æ–≥–æ—Ç–∏–ø —Å–∞–π—Ç–∞
```

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –±–∏–±–ª–∏–æ—Ç–µ–∫ –∏ —É—Ç–∏–ª–∏—Ç

```
lib/
‚îú‚îÄ‚îÄ supabase/            # –†–∞–±–æ—Ç–∞ —Å Supabase
‚îÇ   ‚îú‚îÄ‚îÄ client.ts       # –ö–ª–∏–µ–Ω—Ç –¥–ª—è –±—Ä–∞—É–∑–µ—Ä–∞
‚îÇ   ‚îî‚îÄ‚îÄ server.ts       # –ö–ª–∏–µ–Ω—Ç –¥–ª—è —Å–µ—Ä–≤–µ—Ä–∞
‚îú‚îÄ‚îÄ s3/                  # –†–∞–±–æ—Ç–∞ —Å S3
‚îÇ   ‚îî‚îÄ‚îÄ upload.ts       # –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤ –≤ S3
‚îî‚îÄ‚îÄ pdf/                 # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è PDF ‚ú® NEW
    ‚îî‚îÄ‚îÄ ticket.ts       # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –±–∏–ª–µ—Ç–æ–≤
```

### –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ –∫–ª—é—á–µ–≤—ã—Ö —Ñ–∞–π–ª–æ–≤

#### –°—Ç—Ä–∞–Ω–∏—Ü—ã (app/)

| –§–∞–π–ª | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ | –ß—Ç–æ –¥–µ–ª–∞–µ—Ç |
|------|------------|------------|
| `app/booking/page.tsx` | –°—Ç—Ä–∞–Ω–∏—Ü–∞ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è | –ó–∞–≥—Ä—É–∂–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ —Ç—É—Ä–∞ –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –∫–∞—Ä—Ç—ã, –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç —Ñ–æ—Ä–º—É –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è |
| `app/booking/success/page.tsx` | –°—Ç—Ä–∞–Ω–∏—Ü–∞ —É—Å–ø–µ—Ö–∞ | –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –¥–µ—Ç–∞–ª–∏ —É—Å–ø–µ—à–Ω–æ–≥–æ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è |
| `app/profile/page.tsx` | –ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è | –û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –ø—Ä–æ—Ñ–∏–ª—è, –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è, —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –∫–∞—Ä—Ç—ã |
| `app/admin/bookings/page.tsx` | –°–ø–∏—Å–æ–∫ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π (–∞–¥–º–∏–Ω) | –ó–∞–≥—Ä—É–∂–∞–µ—Ç –≤—Å–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è, –ø–µ—Ä–µ–¥–∞–µ—Ç –≤ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç —Å–ø–∏—Å–∫–∞ |
| `app/admin/bookings/[id]/page.tsx` | –î–µ—Ç–∞–ª–∏ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è (–∞–¥–º–∏–Ω) | –ó–∞–≥—Ä—É–∂–∞–µ—Ç –¥–µ—Ç–∞–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–∏ –∏ —É—á–∞—Å—Ç–Ω–∏–∫–∞—Ö |

#### –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã (components/)

| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ | –ö–ª—é—á–µ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ |
|-----------|------------|------------------|
| `BookingForm.tsx` | –§–æ—Ä–º–∞ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è | –í—ã–±–æ—Ä —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤, —Å–ø–æ—Å–æ–±–∞ –æ–ø–ª–∞—Ç—ã, –≤–≤–æ–¥ –¥–∞–Ω–Ω—ã—Ö –∫–∞—Ä—Ç—ã, –≤–∞–ª–∏–¥–∞—Ü–∏—è |
| `UserBookings.tsx` | –ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è | –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞, —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ –±–∏–ª–µ—Ç–æ–≤, —Å—Ç–∞—Ç—É—Å—ã |
| `BookingsList.tsx` | –°–ø–∏—Å–æ–∫ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π (–∞–¥–º–∏–Ω) | –¢–∞–±–ª–∏—Ü–∞ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π, –ø–æ–∏—Å–∫, —Ñ–∏–ª—å—Ç—Ä—ã, —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ |
| `BookingDetails.tsx` | –î–µ—Ç–∞–ª–∏ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è (–∞–¥–º–∏–Ω) | –ü–æ–ª–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è, —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞–º–∏, –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ API |
| `VideoPlayer.tsx` | –í–∏–¥–µ–æ–ø–ª–µ–µ—Ä | –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Plyr, –ø–æ–¥–¥–µ—Ä–∂–∫–∞ —Ä—É—Å—Å–∫–æ–≥–æ —è–∑—ã–∫–∞, –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ |

#### API Routes (app/api/)

| Endpoint | –ú–µ—Ç–æ–¥ | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ | –ß—Ç–æ –¥–µ–ª–∞–µ—Ç |
|----------|-------|------------|------------|
| `/api/bookings` | POST | –°–æ–∑–¥–∞–Ω–∏–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è | –í–∞–ª–∏–¥–∞—Ü–∏—è, –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏, —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–∞—Ä—Ç—ã, —Å–æ–∑–¥–∞–Ω–∏–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è |
| `/api/user/bookings` | GET | –ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è | –ó–∞–≥—Ä—É–∂–∞–µ—Ç –≤—Å–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å –¥–∞–Ω–Ω—ã–º–∏ —Ç—É—Ä–æ–≤ |
| `/api/user/cards` | GET, POST | –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–∞—Ä—Ç–∞–º–∏ | –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞, —Å–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–π –∫–∞—Ä—Ç—ã |
| `/api/user/cards/[id]` | DELETE, PATCH | –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–∞—Ä—Ç–æ–π | –£–¥–∞–ª–µ–Ω–∏–µ –∫–∞—Ä—Ç—ã, —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é |
| `/api/admin/bookings` | GET | –°–ø–∏—Å–æ–∫ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π (–∞–¥–º–∏–Ω) | –ó–∞–≥—Ä—É–∂–∞–µ—Ç –≤—Å–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è —Å –¥–∞–Ω–Ω—ã–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏ —Ç—É—Ä–æ–≤ |
| `/api/admin/bookings/[id]` | PATCH | –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–æ–≤ | –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –∏–ª–∏ –æ–ø–ª–∞—Ç—ã |
| `/api/admin/cities` | GET | –ü–æ–∏—Å–∫ –≥–æ—Ä–æ–¥–æ–≤ | –ü–æ–∏—Å–∫ –≥–æ—Ä–æ–¥–æ–≤ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é (–º–∏–Ω–∏–º—É–º 2 —Å–∏–º–≤–æ–ª–∞) |
| `/api/admin/cities/[id]` | GET | –ì–æ—Ä–æ–¥ –ø–æ ID | –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–º –≥–æ—Ä–æ–¥–µ |

#### –£—Ç–∏–ª–∏—Ç—ã (lib/)

| –§–∞–π–ª | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ | –ö–ª—é—á–µ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ |
|------|------------|------------------|
| `lib/pdf/ticket.ts` | –ì–µ–Ω–µ—Ä–∞—Ü–∏—è PDF –±–∏–ª–µ—Ç–æ–≤ | –°–æ–∑–¥–∞–Ω–∏–µ HTML, –∑–∞–≥—Ä—É–∑–∫–∞ –ª–æ–≥–æ—Ç–∏–ø–∞, —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥ –≤ Canvas, –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –≤ PDF |
| `lib/supabase/client.ts` | Supabase –∫–ª–∏–µ–Ω—Ç (–±—Ä–∞—É–∑–µ—Ä) | –°–æ–∑–¥–∞–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞ –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞—Ö |
| `lib/supabase/server.ts` | Supabase –∫–ª–∏–µ–Ω—Ç (—Å–µ—Ä–≤–µ—Ä) | –°–æ–∑–¥–∞–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞ –¥–ª—è API routes –∏ Server Components |
| `lib/s3/upload.ts` | –ó–∞–≥—Ä—É–∑–∫–∞ –≤ S3 | –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤, –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –ø—É—Ç–µ–π, —É–¥–∞–ª–µ–Ω–∏–µ —Ñ–∞–π–ª–æ–≤ |

#### –ú–∏–≥—Ä–∞—Ü–∏–∏ (supabase/migrations/)

| –§–∞–π–ª | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ | –ß—Ç–æ —Å–æ–∑–¥–∞–µ—Ç/–∏–∑–º–µ–Ω—è–µ—Ç |
|------|------------|----------------------|
| `010_add_cities.sql` | –¢–∞–±–ª–∏—Ü–∞ –≥–æ—Ä–æ–¥–æ–≤ | –°–æ–∑–¥–∞–µ—Ç —Ç–∞–±–ª–∏—Ü—É `cities`, –¥–æ–±–∞–≤–ª—è–µ—Ç `city_id` –≤ `tours`, –∑–∞–ø–æ–ª–Ω—è–µ—Ç –≥–æ—Ä–æ–¥–∞–º–∏ –¢–∞—Ç–∞—Ä—Å—Ç–∞–Ω–∞ |
| `011_booking_payment_system.sql` | –°–∏—Å—Ç–µ–º–∞ –æ–ø–ª–∞—Ç—ã | –°–æ–∑–¥–∞–µ—Ç enum —Ç–∏–ø—ã, —Ç–∞–±–ª–∏—Ü—É `user_cards`, –¥–æ–±–∞–≤–ª—è–µ—Ç –ø–æ–ª—è –æ–ø–ª–∞—Ç—ã –≤ `bookings`, —Ç—Ä–∏–≥–≥–µ—Ä—ã |

---

## üõ†Ô∏è –¢–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π —Å—Ç–µ–∫

### Frontend
| –¢–µ—Ö–Ω–æ–ª–æ–≥–∏—è | –í–µ—Ä—Å–∏—è | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ |
|------------|--------|------------|
| **Next.js** | 15.x | React framework —Å Server Components |
| **React** | 19.x | UI –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ |
| **TypeScript** | 5.x | –°—Ç–∞—Ç–∏—á–µ—Å–∫–∞—è —Ç–∏–ø–∏–∑–∞—Ü–∏—è |
| **Tailwind CSS** | 3.x | Utility-first CSS framework |
| **Zustand** | 4.x | State management |
| **React Hook Form** | 7.x | –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ñ–æ—Ä–º–∞–º–∏ |
| **date-fns** | 3.x | –†–∞–±–æ—Ç–∞ —Å –¥–∞—Ç–∞–º–∏ |

### Backend
| –¢–µ—Ö–Ω–æ–ª–æ–≥–∏—è | –í–µ—Ä—Å–∏—è | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ |
|------------|--------|------------|
| **Next.js API Routes** | 15.x | RESTful API |
| **Server Actions** | - | Server-side –º—É—Ç–∞—Ü–∏–∏ |
| **Node.js** | 20.x | Runtime –æ–∫—Ä—É–∂–µ–Ω–∏–µ |
| **Socket.io** | 4.x | WebSocket –¥–ª—è —á–∞—Ç–∞ |

### –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö
| –¢–µ—Ö–Ω–æ–ª–æ–≥–∏—è | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ |
|------------|------------|
| **Supabase** | Backend-as-a-Service |
| **PostgreSQL** | –†–µ–ª—è—Ü–∏–æ–Ω–Ω–∞—è –ë–î |
| **Row Level Security (RLS)** | –ó–∞—â–∏—Ç–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–∞ —É—Ä–æ–≤–Ω–µ —Å—Ç—Ä–æ–∫ |

### –•—Ä–∞–Ω–∏–ª–∏—â–µ —Ñ–∞–π–ª–æ–≤
| –¢–µ—Ö–Ω–æ–ª–æ–≥–∏—è | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ |
|------------|------------|
| **Timeweb S3** | –û–±–ª–∞—á–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –º–µ–¥–∏–∞-—Ñ–∞–π–ª–æ–≤ |
| **AWS SDK (@aws-sdk/client-s3)** | –†–∞–±–æ—Ç–∞ —Å S3 API |
| **CDN** | –ë—ã—Å—Ç—Ä–∞—è –¥–æ—Å—Ç–∞–≤–∫–∞ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ |

### –í–Ω–µ—à–Ω–∏–µ API
| –°–µ—Ä–≤–∏—Å | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ |
|--------|------------|
| **–Ø–Ω–¥–µ–∫—Å.–ö–∞—Ä—Ç—ã API** | –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–µ –∫–∞—Ä—Ç—ã –º–∞—Ä—à—Ä—É—Ç–æ–≤ |
| **OpenRouter** | AI-–∞–≥–µ–Ω—Ç –¥–ª—è —á–∞—Ç–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ |
| **Nodemailer** | –û—Ç–ø—Ä–∞–≤–∫–∞ email-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π |
| **Timeweb S3** | –•—Ä–∞–Ω–µ–Ω–∏–µ –∏ –¥–æ—Å—Ç–∞–≤–∫–∞ –º–µ–¥–∏–∞ |

### DevOps
| –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ |
|------------|------------|
| **Git** | –ö–æ–Ω—Ç—Ä–æ–ª—å –≤–µ—Ä—Å–∏–π |
| **GitHub** | –•–æ—Å—Ç–∏–Ω–≥ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è |
| **PM2** | Process manager –¥–ª—è Node.js |
| **Nginx** | Reverse proxy —Å–µ—Ä–≤–µ—Ä |

---

## üóÑÔ∏è –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

### ER-–¥–∏–∞–≥—Ä–∞–º–º–∞

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ     profiles    ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ id (PK)         ‚îÇ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ email           ‚îÇ   ‚îÇ
‚îÇ full_name       ‚îÇ   ‚îÇ
‚îÇ phone           ‚îÇ   ‚îÇ
‚îÇ role            ‚îÇ   ‚îÇ
‚îÇ avatar_url      ‚îÇ   ‚îÇ
‚îÇ created_at      ‚îÇ   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îÇ
                      ‚îÇ
                      ‚îÇ
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îÇ    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ      tours      ‚îÇ   ‚îÇ    ‚îÇ    bookings     ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§   ‚îÇ    ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ id (PK)         ‚îÇ   ‚îÇ    ‚îÇ id (PK)         ‚îÇ
‚îÇ title           ‚îÇ   ‚îÇ    ‚îÇ user_id (FK)    ‚îÇ‚îÄ‚îÄ‚îÄ‚îò
‚îÇ description     ‚îÇ   ‚îÇ    ‚îÇ tour_id (FK)    ‚îÇ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ short_desc      ‚îÇ   ‚îÇ‚óÑ‚îÄ‚îÄ‚îÄ‚îÇ booking_date    ‚îÇ   ‚îÇ
‚îÇ full_desc       ‚îÇ   ‚îÇ    ‚îÇ num_people      ‚îÇ   ‚îÇ
‚îÇ cover_image     ‚îÇ   ‚îÇ    ‚îÇ total_price     ‚îÇ   ‚îÇ
‚îÇ price_per_person‚îÇ   ‚îÇ    ‚îÇ status          ‚îÇ   ‚îÇ
‚îÇ start_date      ‚îÇ   ‚îÇ    ‚îÇ created_at      ‚îÇ   ‚îÇ
‚îÇ end_date        ‚îÇ   ‚îÇ    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îÇ
‚îÇ max_participants‚îÇ   ‚îÇ                           ‚îÇ
‚îÇ current_bookings‚îÇ   ‚îÇ                           ‚îÇ
‚îÇ yandex_map_data ‚îÇ   ‚îÇ                           ‚îÇ
‚îÇ status          ‚îÇ   ‚îÇ    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îÇ
‚îÇ created_by      ‚îÇ   ‚îÇ    ‚îÇbooking_attendees‚îÇ   ‚îÇ
‚îÇ created_at      ‚îÇ   ‚îÇ    ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îÇ    ‚îÇ id (PK)         ‚îÇ   ‚îÇ
                      ‚îÇ    ‚îÇ booking_id (FK) ‚îÇ‚îÄ‚îÄ‚îÄ‚îò
                      ‚îÇ    ‚îÇ full_name       ‚îÇ
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îÇ    ‚îÇ email           ‚îÇ
‚îÇ   tour_media    ‚îÇ   ‚îÇ    ‚îÇ phone           ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§   ‚îÇ    ‚îÇ passport_data   ‚îÇ
‚îÇ id (PK)         ‚îÇ   ‚îÇ    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
‚îÇ tour_id (FK)    ‚îÇ‚îÄ‚îÄ‚îÄ‚îò
‚îÇ media_type      ‚îÇ
‚îÇ media_url       ‚îÇ        ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ order           ‚îÇ        ‚îÇ  chat_messages  ‚îÇ
‚îÇ created_at      ‚îÇ        ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò        ‚îÇ id (PK)         ‚îÇ
                           ‚îÇ user_id (FK)    ‚îÇ
                           ‚îÇ message         ‚îÇ
                           ‚îÇ is_ai           ‚îÇ
                           ‚îÇ is_support      ‚îÇ
                           ‚îÇ session_id      ‚îÇ
                           ‚îÇ created_at      ‚îÇ
                           ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### SQL –°—Ö–µ–º—ã

#### 1. –¢–∞–±–ª–∏—Ü–∞ profiles (–ü—Ä–æ—Ñ–∏–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π)

```sql
CREATE TYPE user_role AS ENUM ('user', 'tour_admin', 'support_admin', 'super_admin');

CREATE TABLE profiles (
  id UUID PRIMARY KEY REFERENCES auth.users(id) ON DELETE CASCADE,
  email TEXT UNIQUE NOT NULL,
  first_name TEXT NOT NULL,
  last_name TEXT NOT NULL,
  middle_name TEXT,
  phone TEXT,
  role user_role DEFAULT 'user',
  avatar_url TEXT,
  avatar_path TEXT, -- –ü—É—Ç—å –∫ –∞–≤–∞—Ç–∞—Ä–∫–µ –≤ S3 (–¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –ø—Ä–∏ –∑–∞–º–µ–Ω–µ)
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- –ò–Ω–¥–µ–∫—Å—ã –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
CREATE INDEX idx_profiles_first_name ON profiles(first_name);
CREATE INDEX idx_profiles_last_name ON profiles(last_name);
CREATE INDEX idx_profiles_role ON profiles(role);
CREATE INDEX idx_profiles_email ON profiles(email);

-- Row Level Security
ALTER TABLE profiles ENABLE ROW LEVEL SECURITY;

-- SELECT: Authenticated –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –≤–∏–¥—è—Ç —Å–≤–æ–π –ø—Ä–æ—Ñ–∏–ª—å + service_role –≤–∏–¥–∏—Ç –≤—Å—ë
CREATE POLICY "Enable read access for own profile"
  ON profiles FOR SELECT
  USING (
    auth.uid() = id 
    OR 
    auth.role() = 'service_role'
  );

-- INSERT: Authenticated –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Å–æ–∑–¥–∞—é—Ç —Ç–æ–ª—å–∫–æ —Å–≤–æ–π –ø—Ä–æ—Ñ–∏–ª—å
CREATE POLICY "Enable insert for authenticated users"
  ON profiles FOR INSERT
  WITH CHECK (
    auth.uid() = id 
    OR 
    auth.role() = 'service_role'
  );

-- UPDATE: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –æ–±–Ω–æ–≤–ª—è—é—Ç —Ç–æ–ª—å–∫–æ —Å–≤–æ–π –ø—Ä–æ—Ñ–∏–ª—å (–±–µ–∑ —Å–º–µ–Ω—ã role)
CREATE POLICY "Enable update for own profile"
  ON profiles FOR UPDATE
  USING (
    auth.uid() = id 
    OR 
    auth.role() = 'service_role'
  )
  WITH CHECK (
    (auth.uid() = id AND role = (SELECT role FROM profiles WHERE id = auth.uid()))
    OR 
    auth.role() = 'service_role'
  );

-- –¢—Ä–∏–≥–≥–µ—Ä –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Å–æ–∑–¥–∞–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
CREATE OR REPLACE FUNCTION handle_new_user()
RETURNS TRIGGER 
SECURITY DEFINER
SET search_path = public
AS $$
BEGIN
  INSERT INTO public.profiles (id, email, first_name, last_name, middle_name, role)
  VALUES (
    NEW.id,
    NEW.email,
    COALESCE(NEW.raw_user_meta_data->>'first_name', '–ò–º—è'),
    COALESCE(NEW.raw_user_meta_data->>'last_name', '–§–∞–º–∏–ª–∏—è'),
    NEW.raw_user_meta_data->>'middle_name',
    'user'
  )
  ON CONFLICT (id) DO UPDATE SET
    email = EXCLUDED.email,
    first_name = EXCLUDED.first_name,
    last_name = EXCLUDED.last_name,
    middle_name = EXCLUDED.middle_name;
  
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER on_auth_user_created
  AFTER INSERT ON auth.users
  FOR EACH ROW 
  EXECUTE FUNCTION handle_new_user();

-- –¢—Ä–∏–≥–≥–µ—Ä –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è updated_at
CREATE OR REPLACE FUNCTION handle_updated_at()
RETURNS TRIGGER AS $$
BEGIN
  NEW.updated_at = NOW();
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER set_updated_at
  BEFORE UPDATE ON profiles
  FOR EACH ROW
  EXECUTE FUNCTION handle_updated_at();

-- –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –¥–ª—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏
COMMENT ON TABLE profiles IS '–ü—Ä–æ—Ñ–∏–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å –§–ò–û –∏ –∞–≤–∞—Ç–∞—Ä–∫–∞–º–∏';
COMMENT ON COLUMN profiles.first_name IS '–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ)';
COMMENT ON COLUMN profiles.last_name IS '–§–∞–º–∏–ª–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ)';
COMMENT ON COLUMN profiles.middle_name IS '–û—Ç—á–µ—Å—Ç–≤–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)';
COMMENT ON COLUMN profiles.avatar_url IS '–ü—É–±–ª–∏—á–Ω—ã–π URL –∞–≤–∞—Ç–∞—Ä–∫–∏ (S3)';
COMMENT ON COLUMN profiles.avatar_path IS '–ü—É—Ç—å –∫ –∞–≤–∞—Ç–∞—Ä–∫–µ –≤ S3 (–¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –ø—Ä–∏ –∑–∞–º–µ–Ω–µ)';
COMMENT ON COLUMN profiles.role IS '–†–æ–ª—å: user, tour_admin, support_admin, super_admin';
```

#### 2. –¢–∞–±–ª–∏—Ü–∞ tours (–¢—É—Ä—ã)

```sql
CREATE TYPE tour_status AS ENUM ('draft', 'published', 'archived');

CREATE TABLE tours (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  title TEXT NOT NULL,
  slug TEXT UNIQUE NOT NULL,
  description TEXT NOT NULL,
  short_desc TEXT,
  full_desc TEXT,
  cover_image TEXT,
  cover_path TEXT, -- –ü—É—Ç—å –∫ –æ–±–ª–æ–∂–∫–µ –≤ S3 (–¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –ø—Ä–∏ –∑–∞–º–µ–Ω–µ)
  price_per_person DECIMAL(10, 2) NOT NULL,
  start_date TIMESTAMP WITH TIME ZONE NOT NULL,
  end_date TIMESTAMP WITH TIME ZONE NOT NULL,
  max_participants INTEGER NOT NULL DEFAULT 20,
  current_bookings INTEGER DEFAULT 0,
  yandex_map_data JSONB, -- JSON —Å –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º–∏ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏ –∫–∞—Ä—Ç—ã
  status tour_status DEFAULT 'draft',
  created_by UUID REFERENCES profiles(id),
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  
  CONSTRAINT valid_dates CHECK (end_date > start_date),
  CONSTRAINT valid_participants CHECK (max_participants > 0),
  CONSTRAINT valid_bookings CHECK (current_bookings >= 0 AND current_bookings <= max_participants)
);

-- –ò–Ω–¥–µ–∫—Å—ã –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
CREATE INDEX idx_tours_status ON tours(status);
CREATE INDEX idx_tours_dates ON tours(start_date, end_date);
CREATE INDEX idx_tours_slug ON tours(slug);

-- Row Level Security
ALTER TABLE tours ENABLE ROW LEVEL SECURITY;

-- –í—Å–µ –º–æ–≥—É—Ç –≤–∏–¥–µ—Ç—å –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–Ω—ã–µ —Ç—É—Ä—ã
CREATE POLICY "Anyone can view published tours"
  ON tours FOR SELECT
  USING (status = 'published');

-- –ê–¥–º–∏–Ω—ã —Ç—É—Ä–æ–≤ –º–æ–≥—É—Ç —É–ø—Ä–∞–≤–ª—è—Ç—å —Ç—É—Ä–∞–º–∏
CREATE POLICY "Tour admins can manage tours"
  ON tours FOR ALL
  USING (
    EXISTS (
      SELECT 1 FROM profiles
      WHERE id = auth.uid()
      AND role IN ('tour_admin', 'super_admin')
    )
  );
```

#### 3. –¢–∞–±–ª–∏—Ü–∞ tour_media (–ú–µ–¥–∏–∞ —Ñ–∞–π–ª—ã —Ç—É—Ä–æ–≤)

```sql
CREATE TYPE media_type AS ENUM ('image', 'video');

CREATE TABLE tour_media (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  tour_id UUID NOT NULL REFERENCES tours(id) ON DELETE CASCADE,
  media_type media_type NOT NULL,
  media_url TEXT NOT NULL,
  media_path TEXT, -- –ü—É—Ç—å –∫ –º–µ–¥–∏–∞ –≤ S3 (–¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è)
  thumbnail_url TEXT,
  order_index INTEGER DEFAULT 0,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- –ò–Ω–¥–µ–∫—Å –¥–ª—è –±—ã—Å—Ç—Ä–æ–π –≤—ã–±–æ—Ä–∫–∏ –º–µ–¥–∏–∞ –ø–æ —Ç—É—Ä—É
CREATE INDEX idx_tour_media_tour_id ON tour_media(tour_id, order_index);

-- RLS
ALTER TABLE tour_media ENABLE ROW LEVEL SECURITY;

-- –í—Å–µ –º–æ–≥—É—Ç –≤–∏–¥–µ—Ç—å –º–µ–¥–∏–∞ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–Ω—ã—Ö —Ç—É—Ä–æ–≤
CREATE POLICY "Anyone can view media of published tours"
  ON tour_media FOR SELECT
  USING (
    EXISTS (
      SELECT 1 FROM tours
      WHERE tours.id = tour_media.tour_id
      AND tours.status = 'published'
    )
  );

-- –ê–¥–º–∏–Ω—ã –º–æ–≥—É—Ç —É–ø—Ä–∞–≤–ª—è—Ç—å –º–µ–¥–∏–∞
CREATE POLICY "Tour admins can manage media"
  ON tour_media FOR ALL
  USING (
    EXISTS (
      SELECT 1 FROM profiles
      WHERE id = auth.uid()
      AND role IN ('tour_admin', 'super_admin')
    )
  );
```

#### 4. –¢–∞–±–ª–∏—Ü–∞ bookings (–ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è)

```sql
CREATE TYPE booking_status AS ENUM ('pending', 'confirmed', 'cancelled', 'completed');

CREATE TABLE bookings (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES profiles(id),
  tour_id UUID NOT NULL REFERENCES tours(id),
  booking_date TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  num_people INTEGER NOT NULL CHECK (num_people > 0),
  total_price DECIMAL(10, 2) NOT NULL,
  status booking_status DEFAULT 'pending',
  ticket_url TEXT, -- –°—Å—ã–ª–∫–∞ –Ω–∞ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π PDF –±–∏–ª–µ—Ç
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- –ò–Ω–¥–µ–∫—Å—ã
CREATE INDEX idx_bookings_user_id ON bookings(user_id);
CREATE INDEX idx_bookings_tour_id ON bookings(tour_id);
CREATE INDEX idx_bookings_status ON bookings(status);

-- RLS
ALTER TABLE bookings ENABLE ROW LEVEL SECURITY;

-- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –≤–∏–¥–µ—Ç—å —Å–≤–æ–∏ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
CREATE POLICY "Users can view own bookings"
  ON bookings FOR SELECT
  USING (auth.uid() = user_id);

-- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç —Å–æ–∑–¥–∞–≤–∞—Ç—å –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
CREATE POLICY "Users can create bookings"
  ON bookings FOR INSERT
  WITH CHECK (auth.uid() = user_id);

-- –ê–¥–º–∏–Ω—ã –º–æ–≥—É—Ç –≤–∏–¥–µ—Ç—å –≤—Å–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
CREATE POLICY "Admins can view all bookings"
  ON bookings FOR SELECT
  USING (
    EXISTS (
      SELECT 1 FROM profiles
      WHERE id = auth.uid()
      AND role IN ('tour_admin', 'support_admin', 'super_admin')
    )
  );

-- –¢—Ä–∏–≥–≥–µ—Ä –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è current_bookings –≤ tours
CREATE OR REPLACE FUNCTION update_tour_bookings()
RETURNS TRIGGER AS $$
BEGIN
  IF (TG_OP = 'INSERT' AND NEW.status = 'confirmed') THEN
    UPDATE tours
    SET current_bookings = current_bookings + NEW.num_people
    WHERE id = NEW.tour_id;
  ELSIF (TG_OP = 'UPDATE' AND OLD.status != 'confirmed' AND NEW.status = 'confirmed') THEN
    UPDATE tours
    SET current_bookings = current_bookings + NEW.num_people
    WHERE id = NEW.tour_id;
  ELSIF (TG_OP = 'UPDATE' AND OLD.status = 'confirmed' AND NEW.status = 'cancelled') THEN
    UPDATE tours
    SET current_bookings = current_bookings - OLD.num_people
    WHERE id = OLD.tour_id;
  END IF;
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER booking_status_change
AFTER INSERT OR UPDATE ON bookings
FOR EACH ROW
EXECUTE FUNCTION update_tour_bookings();
```

#### 5. –¢–∞–±–ª–∏—Ü–∞ booking_attendees (–£—á–∞—Å—Ç–Ω–∏–∫–∏ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è)

```sql
CREATE TABLE booking_attendees (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  booking_id UUID NOT NULL REFERENCES bookings(id) ON DELETE CASCADE,
  first_name TEXT NOT NULL,
  last_name TEXT NOT NULL,
  middle_name TEXT,
  email TEXT,
  phone TEXT,
  passport_data TEXT, -- –î–ª—è —Ç—É—Ä–æ–≤, —Ç—Ä–µ–±—É—é—â–∏—Ö –ø–∞—Å–ø–æ—Ä—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- –ò–Ω–¥–µ–∫—Å
CREATE INDEX idx_booking_attendees_booking_id ON booking_attendees(booking_id);

-- RLS
ALTER TABLE booking_attendees ENABLE ROW LEVEL SECURITY;

-- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –≤–∏–¥–µ—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ —Å–≤–æ–∏—Ö –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π
CREATE POLICY "Users can view own booking attendees"
  ON booking_attendees FOR SELECT
  USING (
    EXISTS (
      SELECT 1 FROM bookings
      WHERE bookings.id = booking_attendees.booking_id
      AND bookings.user_id = auth.uid()
    )
  );

-- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –¥–æ–±–∞–≤–ª—è—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –∫ —Å–≤–æ–∏–º –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è–º
CREATE POLICY "Users can add attendees to own bookings"
  ON booking_attendees FOR INSERT
  WITH CHECK (
    EXISTS (
      SELECT 1 FROM bookings
      WHERE bookings.id = booking_attendees.booking_id
      AND bookings.user_id = auth.uid()
    )
  );
```

#### 6. –¢–∞–±–ª–∏—Ü–∞ chat_messages (–°–æ–æ–±—â–µ–Ω–∏—è —á–∞—Ç–∞)

```sql
CREATE TABLE chat_messages (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES profiles(id),
  session_id TEXT NOT NULL, -- –î–ª—è –∞–Ω–æ–Ω–∏–º–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
  message TEXT NOT NULL,
  is_ai BOOLEAN DEFAULT FALSE,
  is_support BOOLEAN DEFAULT FALSE, -- –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –∂–∏–≤–æ–≥–æ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞
  support_admin_id UUID REFERENCES profiles(id),
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- –ò–Ω–¥–µ–∫—Å—ã
CREATE INDEX idx_chat_messages_user_id ON chat_messages(user_id);
CREATE INDEX idx_chat_messages_session_id ON chat_messages(session_id);
CREATE INDEX idx_chat_messages_created_at ON chat_messages(created_at DESC);

-- RLS
ALTER TABLE chat_messages ENABLE ROW LEVEL SECURITY;

-- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –≤–∏–¥–µ—Ç—å —Å–≤–æ–∏ —Å–æ–æ–±—â–µ–Ω–∏—è
CREATE POLICY "Users can view own chat messages"
  ON chat_messages FOR SELECT
  USING (auth.uid() = user_id OR session_id = current_setting('app.session_id', true));

-- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç —Å–æ–∑–¥–∞–≤–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è
CREATE POLICY "Users can create chat messages"
  ON chat_messages FOR INSERT
  WITH CHECK (auth.uid() = user_id OR user_id IS NULL);

-- –ê–¥–º–∏–Ω—ã –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –º–æ–≥—É—Ç –≤–∏–¥–µ—Ç—å –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è
CREATE POLICY "Support admins can view all messages"
  ON chat_messages FOR SELECT
  USING (
    EXISTS (
      SELECT 1 FROM profiles
      WHERE id = auth.uid()
      AND role IN ('support_admin', 'super_admin')
    )
  );
```

---

## ‚öôÔ∏è –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

### 1. –ö–∞—Ç–∞–ª–æ–≥ —Ç—É—Ä–æ–≤

#### –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:
- –ü—Ä–æ—Å–º–æ—Ç—Ä —Å–ø–∏—Å–∫–∞ –≤—Å–µ—Ö –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Ç—É—Ä–æ–≤
- –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ –¥–∞—Ç–∞–º, —Ü–µ–Ω–µ, –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
- –ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é –∏ –æ–ø–∏—Å–∞–Ω–∏—é
- –ü—Ä–æ—Å–º–æ—Ç—Ä –¥–µ—Ç–∞–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Ç—É—Ä–µ:
  - –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∞—è –∫–∞—Ä—Ç–∞ –º–∞—Ä—à—Ä—É—Ç–∞ (–Ø–Ω–¥–µ–∫—Å.–ö–∞—Ä—Ç—ã)
  - –ì–∞–ª–µ—Ä–µ—è —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π
  - –í–∏–¥–µ–æ-–ø—Ä–µ–≤—å—é (–µ—Å–ª–∏ –µ—Å—Ç—å)
  - –ü–æ–ª–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Ç—É—Ä–∞
  - –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ
  - –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –º–µ—Å—Ç–∞—Ö

#### –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏:
```typescript
// –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö —Ç—É—Ä–∞
interface Tour {
  id: string;
  title: string;
  slug: string;
  description: string;
  shortDesc: string;
  fullDesc: string;
  coverImage: string;
  pricePerPerson: number;
  startDate: Date;
  endDate: Date;
  maxParticipants: number;
  currentBookings: number;
  yandexMapData: {
    center: [number, number]; // [latitude, longitude]
    zoom: number;
    routes: Array<{
      name: string;
      coordinates: Array<[number, number]>;
      description: string;
    }>;
    markers: Array<{
      coordinates: [number, number];
      title: string;
      description: string;
      icon: string;
    }>;
  };
  status: 'draft' | 'published' | 'archived';
  media: Array<{
    type: 'image' | 'video';
    url: string;
    thumbnailUrl?: string;
  }>;
}
```

### 2. –°–∏—Å—Ç–µ–º–∞ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è

#### Workflow –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è:

```
1. –í—ã–±–æ—Ä —Ç—É—Ä–∞ ‚Üí 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ ‚Üí 3. –í—ã–±–æ—Ä –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
   ‚Üí 4. –í—ã–±–æ—Ä —Å–ø–æ—Å–æ–±–∞ –æ–ø–ª–∞—Ç—ã ‚Üí 5. –í–≤–æ–¥ –¥–∞–Ω–Ω—ã—Ö –∫–∞—Ä—Ç—ã (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
   ‚Üí 6. –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ ‚Üí 7. –ì–µ–Ω–µ—Ä–∞—Ü–∏—è PDF –±–∏–ª–µ—Ç–∞ ‚Üí 8. Email —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
```

#### –ù–æ–≤—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ (–≤–µ—Ä—Å–∏—è 2.6.0):

**–°–∏—Å—Ç–µ–º–∞ –æ–ø–ª–∞—Ç—ã:**
- ‚úÖ –í—ã–±–æ—Ä —Å–ø–æ—Å–æ–±–∞ –æ–ø–ª–∞—Ç—ã: –±–∞–Ω–∫–æ–≤—Å–∫–∞—è –∫–∞—Ä—Ç–∞, –Ω–∞–ª–∏—á–Ω—ã–µ –ø—Ä–∏ –≤—Å—Ç—Ä–µ—á–µ, QR-–∫–æ–¥
- ‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–∞—Ä—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (—Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 4 —Ü–∏—Ñ—Ä—ã –∏ —Ç–∏–ø –∫–∞—Ä—Ç—ã)
- ‚úÖ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∫–∞—Ä—Ç—ã –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
- ‚úÖ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–º–∏ –∫–∞—Ä—Ç–∞–º–∏ –≤ –ø—Ä–æ—Ñ–∏–ª–µ
- ‚úÖ –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –æ–ø–ª–∞—Ç—ã (–æ–∂–∏–¥–∞–µ—Ç, –æ–ø–ª–∞—á–µ–Ω–æ, –æ—à–∏–±–∫–∞, –≤–æ–∑–≤—Ä–∞—Ç)

**–ì–µ–Ω–µ—Ä–∞—Ü–∏—è PDF –±–∏–ª–µ—Ç–æ–≤:**
- ‚úÖ –ö—Ä–∞—Å–∏–≤—ã–π –¥–∏–∑–∞–π–Ω –±–∏–ª–µ—Ç–∞ —Å –ª–æ–≥–æ—Ç–∏–ø–æ–º —Å–∞–π—Ç–∞
- ‚úÖ –ù–∞–∑–≤–∞–Ω–∏–µ —Å–∞–π—Ç–∞ "–¢—É—Ä—ã –ø–æ –¢–∞—Ç–∞—Ä—Å—Ç–∞–Ω—É"
- ‚úÖ –ü–æ–ª–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç—É—Ä–µ –∏ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–∏
- ‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Ä—É—Å—Å–∫–æ–≥–æ —è–∑—ã–∫–∞ —á–µ—Ä–µ–∑ HTML-—Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–∞
- ‚úÖ –î–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —Å–∫–∞—á–∏–≤–∞–Ω–∏—è –¥–ª—è –≤—Å–µ—Ö —Å—Ç–∞—Ç—É—Å–æ–≤ –∫—Ä–æ–º–µ –æ—Ç–º–µ–Ω–µ–Ω–Ω—ã—Ö

**–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è–º–∏:**
- ‚úÖ –°—Ç—Ä–∞–Ω–∏—Ü–∞ —Å–ø–∏—Å–∫–∞ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π –≤ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏
- ‚úÖ –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ —Å—Ç–∞—Ç—É—Å—É –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –∏ –æ–ø–ª–∞—Ç—ã
- ‚úÖ –ü–æ–∏—Å–∫ –ø–æ –∏–º–µ–Ω–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, email –∏–ª–∏ –Ω–∞–∑–≤–∞–Ω–∏—é —Ç—É—Ä–∞
- ‚úÖ –î–µ—Ç–∞–ª—å–Ω—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
- ‚úÖ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞–º–∏ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –∏ –æ–ø–ª–∞—Ç—ã —á–µ—Ä–µ–∑ –≤—ã–ø–∞–¥–∞—é—â–∏–µ —Å–ø–∏—Å–∫–∏
- ‚úÖ –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π –≤ –ø—Ä–æ—Ñ–∏–ª–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- ‚úÖ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è–º –≤ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏

#### –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏:
```typescript
// –õ–æ–≥–∏–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏
function checkTourAvailability(tour: Tour, numPeople: number): {
  available: boolean;
  reason?: string;
} {
  const now = new Date();
  
  // –ü—Ä–æ–≤–µ—Ä–∫–∞: —Ç—É—Ä —É–∂–µ –Ω–∞—á–∞–ª—Å—è?
  if (tour.startDate < now) {
    return { available: false, reason: '–¢—É—Ä —É–∂–µ –Ω–∞—á–∞–ª—Å—è' };
  }
  
  // –ü—Ä–æ–≤–µ—Ä–∫–∞: –µ—Å—Ç—å –ª–∏ —Å–≤–æ–±–æ–¥–Ω—ã–µ –º–µ—Å—Ç–∞?
  const availableSpots = tour.maxParticipants - tour.currentBookings;
  if (availableSpots < numPeople) {
    return { 
      available: false, 
      reason: `–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –º–µ—Å—Ç. –î–æ—Å—Ç—É–ø–Ω–æ: ${availableSpots}` 
    };
  }
  
  return { available: true };
}
```

#### –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –±–∏–ª–µ—Ç–∞ (PDF) - –í–µ—Ä—Å–∏—è 2.6.0:

**–§–∞–π–ª:** `lib/pdf/ticket.ts`

**–¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏:** `jsPDF` + `html2canvas` –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ —Ä—É—Å—Å–∫–æ–≥–æ —è–∑—ã–∫–∞

**–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç:**
1. –°–æ–∑–¥–∞–µ—Ç—Å—è –≤—Ä–µ–º–µ–Ω–Ω—ã–π HTML —ç–ª–µ–º–µ–Ω—Ç —Å –¥–∏–∑–∞–π–Ω–æ–º –±–∏–ª–µ—Ç–∞
2. HTML —Ä–µ–Ω–¥–µ—Ä–∏—Ç—Å—è –≤ Canvas —á–µ—Ä–µ–∑ `html2canvas`
3. Canvas –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç—Å—è –≤ PDF —á–µ—Ä–µ–∑ `jsPDF`
4. PDF —Å–∫–∞—á–∏–≤–∞–µ—Ç—Å—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º

**–ö–ª—é—á–µ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:**

```typescript
// lib/pdf/ticket.ts
'use client';

import jsPDF from 'jspdf';
import html2canvas from 'html2canvas';

export async function generateTicketPDF(booking: Booking) {
  // 1. –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —ç–ª–µ–º–µ–Ω—Ç –¥–ª—è —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞
  const ticketElement = document.createElement('div');
  ticketElement.style.width = '794px'; // A4 width in pixels
  ticketElement.style.padding = '40px';
  ticketElement.style.backgroundColor = '#ffffff';
  
  // 2. –ó–∞–≥—Ä—É–∂–∞–µ–º –ª–æ–≥–æ—Ç–∏–ø —Å–∞–π—Ç–∞ –∫–∞–∫ base64
  let logoBase64 = '';
  try {
    const logoResponse = await fetch('/logo.svg');
    if (logoResponse.ok) {
      const logoBlob = await logoResponse.blob();
      logoBase64 = await new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onloadend = () => resolve(reader.result as string);
        reader.onerror = reject;
        reader.readAsDataURL(logoBlob);
      });
    }
  } catch (error) {
    console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –ª–æ–≥–æ—Ç–∏–ø:', error);
  }

  // 3. –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º HTML —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –±–∏–ª–µ—Ç–∞
  ticketElement.innerHTML = `
    <div style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); padding: 40px; border-radius: 16px;">
      <!-- –®–∞–ø–∫–∞ —Å –ª–æ–≥–æ—Ç–∏–ø–æ–º –∏ –Ω–∞–∑–≤–∞–Ω–∏–µ–º -->
      <div style="text-align: center; margin-bottom: 40px;">
        ${logoBase64 ? `<img src="${logoBase64}" style="width: 80px; height: 80px;" />` : ''}
        <h1>–ë–ò–õ–ï–¢ –ù–ê –¢–£–†</h1>
        <div>–¢—É—Ä—ã –ø–æ –¢–∞—Ç–∞—Ä—Å—Ç–∞–Ω—É</div>
      </div>
      
      <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç—É—Ä–µ -->
      <div style="background: white; padding: 35px; border-radius: 12px;">
        <h2>${booking.tour.title}</h2>
        <!-- –ö–∞—Ä—Ç–æ—á–∫–∏ —Å –¥–∞–Ω–Ω—ã–º–∏ -->
        <!-- –ë–ª–æ–∫ —Å—É–º–º—ã -->
      </div>
      
      <!-- –ù–æ–º–µ—Ä –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –∏ —Å—Ç–∞—Ç—É—Å -->
      <!-- –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è -->
      <!-- –§—É—Ç–µ—Ä -->
    </div>
  `;

  document.body.appendChild(ticketElement);

  // 4. –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º HTML –≤ Canvas
  const canvas = await html2canvas(ticketElement, {
    scale: 2,
    useCORS: true,
    backgroundColor: '#ffffff',
    height: ticketElement.scrollHeight,
  });

  // 5. –°–æ–∑–¥–∞–µ–º PDF –∏–∑ Canvas
  const imgData = canvas.toDataURL('image/png');
  const pdf = new jsPDF({ orientation: 'portrait', unit: 'mm', format: 'a4' });
  
  const imgWidth = 210; // A4 width in mm
  const pageHeight = 297; // A4 height in mm
  const imgHeight = (canvas.height * imgWidth) / canvas.width;
  
  // –ï—Å–ª–∏ –∫–æ–Ω—Ç–µ–Ω—Ç –ø–æ–º–µ—â–∞–µ—Ç—Å—è –Ω–∞ –æ–¥–Ω—É —Å—Ç—Ä–∞–Ω–∏—Ü—É
  if (imgHeight <= pageHeight) {
    pdf.addImage(imgData, 'PNG', 0, 0, imgWidth, imgHeight);
  } else {
    // –†–∞–∑–±–∏–≤–∞–µ–º –Ω–∞ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å—Ç—Ä–∞–Ω–∏—Ü
    // ...
  }

  // 6. –°–æ—Ö—Ä–∞–Ω—è–µ–º PDF
  const fileName = `–ë–∏–ª–µ—Ç_${booking.tour.title.substring(0, 20)}_${booking.id.substring(0, 8)}.pdf`;
  pdf.save(fileName);
  
  // 7. –£–¥–∞–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —ç–ª–µ–º–µ–Ω—Ç
  document.body.removeChild(ticketElement);
}
```

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏:**
- ‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Ä—É—Å—Å–∫–æ–≥–æ —è–∑—ã–∫–∞ —á–µ—Ä–µ–∑ HTML-—Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥ (–Ω–µ —Ç—Ä–µ–±—É–µ—Ç –∫–∞—Å—Ç–æ–º–Ω—ã—Ö —à—Ä–∏—Ñ—Ç–æ–≤)
- ‚úÖ –õ–æ–≥–æ—Ç–∏–ø —Å–∞–π—Ç–∞ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –∏ –≤—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è –≤ –±–∏–ª–µ—Ç
- ‚úÖ –ö—Ä–∞—Å–∏–≤—ã–π –≥—Ä–∞–¥–∏–µ–Ω—Ç–Ω—ã–π –¥–∏–∑–∞–π–Ω —Å –∫–∞—Ä—Ç–æ—á–∫–∞–º–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Ä–∞–∑–±–∏–µ–Ω–∏–µ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –µ—Å–ª–∏ –∫–æ–Ω—Ç–µ–Ω—Ç –Ω–µ –ø–æ–º–µ—â–∞–µ—Ç—Å—è
- ‚úÖ –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –æ—Ç—Å—Ç—É–ø—ã —á—Ç–æ–±—ã —Ñ—É—Ç–µ—Ä –Ω–µ –ø–µ—Ä–µ–Ω–æ—Å–∏–ª—Å—è –Ω–∞ –≤—Ç–æ—Ä—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É
  
  // –£—á–∞—Å—Ç–Ω–∏–∫–∏
  doc.text('–£—á–∞—Å—Ç–Ω–∏–∫–∏:', 20, 90);
  booking.attendees.forEach((attendee, index) => {
    doc.text(`${index + 1}. ${attendee.fullName}`, 20, 100 + (index * 10));
  });
  
  // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
  const pdfBuffer = doc.output('arraybuffer');
  const filename = `ticket-${booking.id}.pdf`;
  const url = await uploadToServer(pdfBuffer, filename);
  
  return url;
}
```

### 3. Email —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è

#### –¢–∏–ø—ã —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π:
1. **–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è**
2. **–û—Ç–º–µ–Ω–∞ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è**
3. **–ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –∑–∞ 24 —á–∞—Å–∞ –¥–æ —Ç—É—Ä–∞**
4. **–ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ —Ç—É—Ä–µ**

#### –®–∞–±–ª–æ–Ω email:
```typescript
// –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è Nodemailer
import nodemailer from 'nodemailer';

const transporter = nodemailer.createTransport({
  host: process.env.EMAIL_HOST,
  port: parseInt(process.env.EMAIL_PORT!),
  secure: false,
  auth: {
    user: process.env.EMAIL_USER,
    pass: process.env.EMAIL_PASSWORD,
  },
});

async function sendBookingConfirmation(booking: Booking) {
  const mailOptions = {
    from: process.env.EMAIL_FROM,
    to: booking.user.email,
    subject: `–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è - ${booking.tour.title}`,
    html: `
      <h1>–í–∞—à–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ!</h1>
      <p>–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ, ${booking.user.fullName}!</p>
      <p>–í–∞—à–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ —Ç—É—Ä "${booking.tour.title}" —É—Å–ø–µ—à–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ.</p>
      
      <h2>–î–µ—Ç–∞–ª–∏ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è:</h2>
      <ul>
        <li>–ù–æ–º–µ—Ä –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è: ${booking.id}</li>
        <li>–î–∞—Ç–∞ —Ç—É—Ä–∞: ${formatDate(booking.tour.startDate)}</li>
        <li>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —á–µ–ª–æ–≤–µ–∫: ${booking.numPeople}</li>
        <li>–û–±—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å: ${booking.totalPrice} ‚ÇΩ</li>
      </ul>
      
      <p>–í–∞—à –±–∏–ª–µ—Ç –ø—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω –∫ —ç—Ç–æ–º—É –ø–∏—Å—å–º—É.</p>
      <p>–î–æ –≤—Å—Ç—Ä–µ—á–∏ –Ω–∞ —Ç—É—Ä–µ! üéâ</p>
    `,
    attachments: [
      {
        filename: `ticket-${booking.id}.pdf`,
        path: booking.ticketUrl,
      },
    ],
  };
  
  await transporter.sendMail(mailOptions);
}
```

### 4. –ß–∞—Ç –ø–æ–¥–¥–µ—Ä–∂–∫–∏ —Å AI-–∞–≥–µ–Ω—Ç–æ–º

–°–º. –ø–æ–¥—Ä–æ–±–Ω—É—é –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é –≤ [CHAT_ARCHITECTURE.md](./CHAT_ARCHITECTURE.md)

**–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ:**
- WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
- AI-–∞–≥–µ–Ω—Ç –Ω–∞ –±–∞–∑–µ OpenRouter (GPT-4/Claude)
- –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –ø–µ—Ä–µ–¥–∞—á–∏ —á–∞—Ç–∞ –∂–∏–≤–æ–º—É –æ–ø–µ—Ä–∞—Ç–æ—Ä—É
- –ò—Å—Ç–æ—Ä–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –∞–Ω–æ–Ω–∏–º–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

### 5. –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω—ã–µ –ø–∞–Ω–µ–ª–∏

#### 5.1. –°—É–ø–µ—Ä-–∞–¥–º–∏–Ω
**–ü—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞:**
- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤—Å–µ–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏
- –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ —Ä–æ–ª–µ–π –∞–¥–º–∏–Ω–∞–º
- –î–æ—Å—Ç—É–ø –∫–æ –≤—Å–µ–º –¥–∞–Ω–Ω—ã–º
- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏ —Å–∏—Å—Ç–µ–º—ã

**–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª:**
```typescript
// –ö–æ–º–ø–æ–Ω–µ–Ω—Ç —Å—É–ø–µ—Ä-–∞–¥–º–∏–Ω–∞
'/admin/super'
‚îú‚îÄ‚îÄ /users          # –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏
‚îú‚îÄ‚îÄ /admins         # –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∞–¥–º–∏–Ω–∞–º–∏
‚îú‚îÄ‚îÄ /settings       # –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–∏—Å—Ç–µ–º—ã
‚îú‚îÄ‚îÄ /analytics      # –ê–Ω–∞–ª–∏—Ç–∏–∫–∞
‚îî‚îÄ‚îÄ /logs           # –õ–æ–≥–∏ —Å–∏—Å—Ç–µ–º—ã
```

#### 5.2. –ê–¥–º–∏–Ω —Ç—É—Ä–æ–≤
**–ü—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞:**
- –°–æ–∑–¥–∞–Ω–∏–µ/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ/—É–¥–∞–ª–µ–Ω–∏–µ —Ç—É—Ä–æ–≤
- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–µ–¥–∏–∞-—Ñ–∞–π–ª–∞–º–∏ —Ç—É—Ä–æ–≤
- –ü—Ä–æ—Å–º–æ—Ç—Ä –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π
- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ–º

**–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª:**
```typescript
'/admin/tours'
‚îú‚îÄ‚îÄ /list           # –°–ø–∏—Å–æ–∫ –≤—Å–µ—Ö —Ç—É—Ä–æ–≤
‚îú‚îÄ‚îÄ /create         # –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —Ç—É—Ä–∞
‚îú‚îÄ‚îÄ /[id]/edit      # –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç—É—Ä–∞
‚îú‚îÄ‚îÄ /[id]/media     # –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–µ–¥–∏–∞
‚îú‚îÄ‚îÄ /[id]/map       # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–∞—Ä—Ç—ã –º–∞—Ä—à—Ä—É—Ç–∞
‚îî‚îÄ‚îÄ /bookings       # –ü—Ä–æ—Å–º–æ—Ç—Ä –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π
```

**–§–æ—Ä–º–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ç—É—Ä–∞:**
- –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è (–Ω–∞–∑–≤–∞–Ω–∏–µ, –æ–ø–∏—Å–∞–Ω–∏–µ)
- –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ü–µ–Ω
- –î–∞—Ç—ã –∏ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ
- –ó–∞–≥—Ä—É–∑–∫–∞ –æ–±–ª–æ–∂–∫–∏
- –ó–∞–≥—Ä—É–∑–∫–∞ –≥–∞–ª–µ—Ä–µ–∏ —Ñ–æ—Ç–æ
- –ó–∞–≥—Ä—É–∑–∫–∞ –≤–∏–¥–µ–æ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
- –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–∞—Ä—Ç—ã –º–∞—Ä—à—Ä—É—Ç–∞ (–Ø–Ω–¥–µ–∫—Å.–ö–∞—Ä—Ç—ã API)
- –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ª–∏–º–∏—Ç–∞ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤

#### 5.3. –ê–¥–º–∏–Ω –ø–æ–¥–¥–µ—Ä–∂–∫–∏
**–ü—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞:**
- –ü—Ä–æ—Å–º–æ—Ç—Ä –≤—Å–µ—Ö —á–∞—Ç–æ–≤
- –û—Ç–≤–µ—Ç—ã –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- –ü–µ—Ä–µ–¥–∞—á–∞ —á–∞—Ç–∞ –æ—Ç AI-–∞–≥–µ–Ω—Ç–∞ –∫ —Å–µ–±–µ
- –ü—Ä–æ—Å–º–æ—Ç—Ä –∏—Å—Ç–æ—Ä–∏–∏ –æ–±—Ä–∞—â–µ–Ω–∏–π

**–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª:**
```typescript
'/admin/support'
‚îú‚îÄ‚îÄ /chats          # –°–ø–∏—Å–æ–∫ –∞–∫—Ç–∏–≤–Ω—ã—Ö —á–∞—Ç–æ–≤
‚îú‚îÄ‚îÄ /history        # –ò—Å—Ç–æ—Ä–∏—è –æ–±—Ä–∞—â–µ–Ω–∏–π
‚îú‚îÄ‚îÄ /chat/[id]      # –î–µ—Ç–∞–ª–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —á–∞—Ç–∞
‚îî‚îÄ‚îÄ /settings       # –ù–∞—Å—Ç—Ä–æ–π–∫–∏ AI-–∞–≥–µ–Ω—Ç–∞
```

---

## üîå API Endpoints

### Public API

#### Tours API
```typescript
// GET /api/tours - –ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ —Ç—É—Ä–æ–≤
// Query params: ?status=published&limit=10&offset=0
Response: {
  tours: Tour[];
  total: number;
  page: number;
}

// GET /api/tours/[slug] - –ü–æ–ª—É—á–∏—Ç—å —Ç—É—Ä –ø–æ slug
Response: Tour

// GET /api/tours/[id]/availability - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å
Response: {
  available: boolean;
  availableSpots: number;
  reason?: string;
}
```

#### Bookings API
```typescript
// POST /api/bookings - –°–æ–∑–¥–∞—Ç—å –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
Body: {
  tourId: string;
  numPeople: number;
  attendees: Array<{
    fullName: string;
    email?: string;
    phone?: string;
    passportData?: string;
  }>;
}
Response: {
  booking: Booking;
  ticketUrl: string;
}

// GET /api/bookings/[id] - –ü–æ–ª—É—á–∏—Ç—å –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
Response: Booking

// PUT /api/bookings/[id]/cancel - –û—Ç–º–µ–Ω–∏—Ç—å –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
Response: {
  success: boolean;
  booking: Booking;
}

// GET /api/bookings/my - –ü–æ–ª—É—á–∏—Ç—å —Å–≤–æ–∏ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
Response: Booking[]
```

#### Chat API
```typescript
// WebSocket: /api/chat/socket
Events:
  - 'message' (client ‚Üí server)
  - 'ai_response' (server ‚Üí client)
  - 'support_joined' (server ‚Üí client)
  - 'typing' (bidirectional)

// POST /api/chat/messages - –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ (fallback)
Body: {
  sessionId: string;
  message: string;
}
Response: {
  message: ChatMessage;
  aiResponse?: ChatMessage;
}

// GET /api/chat/history?sessionId=xxx - –ü–æ–ª—É—á–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é
Response: ChatMessage[]
```

### Admin API

#### –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è–º–∏ (Admin)
```typescript
// GET /api/admin/bookings - –ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
// Query params: ?status=confirmed&payment_status=paid
Response: {
  bookings: Array<{
    id: string;
    user: { first_name, last_name, email };
    tour: { title, slug, start_date };
    num_people: number;
    total_price: number;
    status: 'pending' | 'confirmed' | 'cancelled' | 'completed';
    payment_status: 'pending' | 'paid' | 'failed' | 'refunded';
    payment_method: 'card' | 'cash' | 'qr_code';
    created_at: string;
  }>;
}

// GET /api/admin/bookings/[id] - –î–µ—Ç–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–∏
Response: Booking —Å –ø–æ–ª–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, —Ç—É—Ä–∞ –∏ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤

// PATCH /api/admin/bookings/[id] - –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å—ã –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
Body: {
  status?: 'pending' | 'confirmed' | 'cancelled' | 'completed';
  payment_status?: 'pending' | 'paid' | 'failed' | 'refunded';
}
Response: { success: true, booking: {...} }
```

#### –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≥–æ—Ä–æ–¥–∞–º–∏ (Admin)
```typescript
// GET /api/admin/cities - –ü–æ–∏—Å–∫ –≥–æ—Ä–æ–¥–æ–≤
// Query params: ?search=–∫–∞–∑–∞–Ω—å (–º–∏–Ω–∏–º—É–º 2 —Å–∏–º–≤–æ–ª–∞)
Response: {
  cities: Array<{ id: string; name: string }>;
}

// GET /api/admin/cities/[id] - –ü–æ–ª—É—á–∏—Ç—å –≥–æ—Ä–æ–¥ –ø–æ ID
Response: { city: { id: string; name: string } | null }
```

#### Admin Tours API
```typescript
// POST /api/admin/tours - –°–æ–∑–¥–∞—Ç—å —Ç—É—Ä
// PUT /api/admin/tours/[id] - –û–±–Ω–æ–≤–∏—Ç—å —Ç—É—Ä
// DELETE /api/admin/tours/[id] - –£–¥–∞–ª–∏—Ç—å —Ç—É—Ä
// POST /api/admin/tours/[id]/media - –ó–∞–≥—Ä—É–∑–∏—Ç—å –º–µ–¥–∏–∞
// DELETE /api/admin/tours/[id]/media/[mediaId] - –£–¥–∞–ª–∏—Ç—å –º–µ–¥–∏–∞
```

#### Admin Users API (Super Admin only)
```typescript
// GET /api/admin/users - –°–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
// PUT /api/admin/users/[id]/role - –ò–∑–º–µ–Ω–∏—Ç—å —Ä–æ–ª—å
// DELETE /api/admin/users/[id] - –£–¥–∞–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
```

---

## üîó –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏

### 1. –Ø–Ω–¥–µ–∫—Å.–ö–∞—Ä—Ç—ã API

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–µ –∫–∞—Ä—Ç—ã –º–∞—Ä—à—Ä—É—Ç–æ–≤ —Ç—É—Ä–æ–≤

**–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è:** https://yandex.ru/dev/maps/

**–û—Å–Ω–æ–≤–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:**
- –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –º–∞—Ä—à—Ä—É—Ç–∞ —Ç—É—Ä–∞
- –ú–∞—Ä–∫–µ—Ä—ã –¥–æ—Å—Ç–æ–ø—Ä–∏–º–µ—á–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–µ–π
- –ö–∞—Å—Ç–æ–º–∏–∑–∞—Ü–∏—è –≤–Ω–µ—à–Ω–µ–≥–æ –≤–∏–¥–∞
- –†–∞—Å—á—ë—Ç —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–π –∏ –≤—Ä–µ–º–µ–Ω–∏

**–ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:**
```typescript
// components/tours/TourMap.tsx
import { YMaps, Map, Placemark, Polyline } from '@pbe/react-yandex-maps';

export function TourMap({ tour }: { tour: Tour }) {
  const { center, zoom, markers, routes } = tour.yandexMapData;
  
  return (
    <YMaps query={{ apikey: process.env.NEXT_PUBLIC_YANDEX_MAPS_API_KEY }}>
      <Map
        defaultState={{ center, zoom }}
        width="100%"
        height="400px"
      >
        {/* –ú–∞—Ä–∫–µ—Ä—ã –¥–æ—Å—Ç–æ–ø—Ä–∏–º–µ—á–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–µ–π */}
        {markers.map((marker, index) => (
          <Placemark
            key={index}
            geometry={marker.coordinates}
            properties={{
              hintContent: marker.title,
              balloonContent: marker.description,
            }}
            options={{
              iconImageHref: marker.icon,
              iconImageSize: [30, 42],
            }}
          />
        ))}
        
        {/* –ú–∞—Ä—à—Ä—É—Ç—ã */}
        {routes.map((route, index) => (
          <Polyline
            key={index}
            geometry={route.coordinates}
            options={{
              strokeColor: '#0066FF',
              strokeWidth: 4,
              strokeOpacity: 0.8,
            }}
          />
        ))}
      </Map>
    </YMaps>
  );
}
```

**–ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä –∫–∞—Ä—Ç –¥–ª—è –∞–¥–º–∏–Ω–∞:**
```typescript
// components/admin/MapEditor.tsx
// –ü–æ–∑–≤–æ–ª—è–µ—Ç –∞–¥–º–∏–Ω—É:
// - –î–æ–±–∞–≤–ª—è—Ç—å —Ç–æ—á–∫–∏ –Ω–∞ –∫–∞—Ä—Ç—É –∫–ª–∏–∫–æ–º
// - –†–∏—Å–æ–≤–∞—Ç—å –º–∞—Ä—à—Ä—É—Ç—ã
// - –î–æ–±–∞–≤–ª—è—Ç—å –æ–ø–∏—Å–∞–Ω–∏—è –∫ —Ç–æ—á–∫–∞–º
// - –í—ã–±–∏—Ä–∞—Ç—å –∏–∫–æ–Ω–∫–∏ –º–∞—Ä–∫–µ—Ä–æ–≤
// - –ù–∞—Å—Ç—Ä–∞–∏–≤–∞—Ç—å –∑—É–º –∏ —Ü–µ–Ω—Ç—Ä –∫–∞—Ä—Ç—ã
```

### 2. OpenRouter API (AI-–∞–≥–µ–Ω—Ç)

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** AI-–∞–≥–µ–Ω—Ç –¥–ª—è —á–∞—Ç–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏

**–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è:** https://openrouter.ai/docs

**–ú–æ–¥–µ–ª–∏:**
- GPT-4 (primary)
- Claude 3.5 Sonnet (fallback)
- Llama 3.1 (—ç–∫–æ–Ω–æ–º–∏—á–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç)

**–ü—Ä–∏–º–µ—Ä –∑–∞–ø—Ä–æ—Å–∞:**
```typescript
// lib/ai/openrouter.ts
export async function getAIResponse(
  message: string,
  context: ChatMessage[]
): Promise<string> {
  const response = await fetch('https://openrouter.ai/api/v1/chat/completions', {
    method: 'POST',
    headers: {
      'Authorization': `Bearer ${process.env.OPENROUTER_API_KEY}`,
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({
      model: 'openai/gpt-4',
      messages: [
        {
          role: 'system',
          content: `–¢—ã - AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã —Ç—É—Ä–æ–≤ –ø–æ –¢–∞—Ç–∞—Ä—Å—Ç–∞–Ω—É.
            –¢–≤–æ—è –∑–∞–¥–∞—á–∞ - –ø–æ–º–æ–≥–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º —Å –≤–æ–ø—Ä–æ—Å–∞–º–∏ –æ —Ç—É—Ä–∞—Ö,
            –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è—Ö –∏ –æ–±—â–µ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏. –ë—É–¥—å –≤–µ–∂–ª–∏–≤—ã–º –∏ helpful.`
        },
        ...context.map(msg => ({
          role: msg.is_ai ? 'assistant' : 'user',
          content: msg.message,
        })),
        {
          role: 'user',
          content: message,
        }
      ],
      temperature: 0.7,
      max_tokens: 500,
    }),
  });
  
  const data = await response.json();
  return data.choices[0].message.content;
}
```

### 3. Supabase

**–ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:**
- **Database:** PostgreSQL —Å Row Level Security
- **Auth:** –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è (Email/Password, OAuth)
- **Storage:** –•—Ä–∞–Ω–∏–ª–∏—â–µ —Ñ–∞–π–ª–æ–≤ (–∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞ –ª–æ–∫–∞–ª—å–Ω–æ–º—É —Ö—Ä–∞–Ω–µ–Ω–∏—é)

**–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è:**
```typescript
// lib/supabase/client.ts
import { createClient } from '@supabase/supabase-js';

export const supabase = createClient(
  process.env.NEXT_PUBLIC_SUPABASE_URL!,
  process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!
);

// lib/supabase/server.ts (–¥–ª—è Server Components)
import { createServerClient } from '@supabase/ssr';
import { cookies } from 'next/headers';

export function createClient() {
  const cookieStore = cookies();
  
  return createServerClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
    {
      cookies: {
        get(name: string) {
          return cookieStore.get(name)?.value;
        },
      },
    }
  );
}
```

---

## üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### 1. –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è

**Supabase Auth:**
- Email/Password –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è
- JWT —Ç–æ–∫–µ–Ω—ã
- Refresh tokens
- Session management

**Role-Based Access Control (RBAC):**
```typescript
// middleware.ts
import { createMiddlewareClient } from '@supabase/auth-helpers-nextjs';
import { NextResponse } from 'next/server';
import type { NextRequest } from 'next/server';

export async function middleware(req: NextRequest) {
  const res = NextResponse.next();
  const supabase = createMiddlewareClient({ req, res });
  
  const {
    data: { session },
  } = await supabase.auth.getSession();
  
  // –ó–∞—â–∏—Ç–∞ –∞–¥–º–∏–Ω—Å–∫–∏—Ö —Ä–æ—É—Ç–æ–≤
  if (req.nextUrl.pathname.startsWith('/admin')) {
    if (!session) {
      return NextResponse.redirect(new URL('/login', req.url));
    }
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–æ–ª–∏
    const { data: profile } = await supabase
      .from('profiles')
      .select('role')
      .eq('id', session.user.id)
      .single();
    
    const requiredRoles = {
      '/admin/super': ['super_admin'],
      '/admin/tours': ['tour_admin', 'super_admin'],
      '/admin/support': ['support_admin', 'super_admin'],
    };
    
    const path = req.nextUrl.pathname;
    const roles = Object.entries(requiredRoles).find(([p]) =>
      path.startsWith(p)
    )?.[1];
    
    if (roles && !roles.includes(profile?.role)) {
      return NextResponse.redirect(new URL('/unauthorized', req.url));
    }
  }
  
  return res;
}

export const config = {
  matcher: ['/admin/:path*', '/profile/:path*', '/bookings/:path*'],
};
```

### 3.1. Auth –∏ –∫—ç—à –ø—Ä–æ—Ñ–∏–ª—è (UserMenu)

–≠—Ç–æ—Ç –ø—Ä–æ–µ–∫—Ç –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –≥–∏–±—Ä–∏–¥–Ω—ã–π –ø–æ–¥—Ö–æ–¥ –∫ –ø–æ–ª—É—á–µ–Ω–∏—é —Ä–æ–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏:

- –ò—Å—Ç–æ—á–Ω–∏–∫ 1: `user_metadata` –∏–∑ Supabase Auth ‚Äî –±—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç –±–µ–∑ –∑–∞–ø—Ä–æ—Å–∞ –∫ –ë–î.
- –ò—Å—Ç–æ—á–Ω–∏–∫ 2: —Ç–∞–±–ª–∏—Ü–∞ `profiles` ‚Äî —É—Ç–æ—á–Ω–µ–Ω–∏–µ —Ä–æ–ª–∏/–ø—Ä–æ—Ñ–∏–ª—è –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏.
- –ö–ª–∏–µ–Ω—Ç—Å–∫–∏–π –∫—ç—à: `localStorage` + `sessionStorage` –∫–ª—é—á `tt_profile` –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –ø—Ä–æ–ø–∞–¥–∞–Ω–∏—è —Å—Å—ã–ª–∫–∏ ¬´–ê–¥–º–∏–Ω‚Äë–ø–∞–Ω–µ–ª—å¬ª –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ –≤–∫–ª–∞–¥–æ–∫/–º–∏–Ω–∏–º–∏–∑–∞—Ü–∏–∏ –±—Ä–∞—É–∑–µ—Ä–∞.

–ü–æ—Ç–æ–∫ –≤ `components/layout/UserMenu.tsx`:
- –ü—Ä–∏ –º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ —á–∏—Ç–∞–µ–º –∫—ç—à –∏ –º–≥–Ω–æ–≤–µ–Ω–Ω–æ –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º —Ä–æ–ª—å, –µ—Å–ª–∏ –æ–Ω–∞ –µ—Å—Ç—å.
- `supabase.auth.getUser()` ‚Äî –ø—Ä–∏–º–µ–Ω—è–µ–º `user_metadata` (role, –∏–º—è, –∞–≤–∞—Ç–∞—Ä) –∏ –∫—ç—à–∏—Ä—É–µ–º.
- –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ –ø—ã—Ç–∞–µ–º—Å—è –∑–∞–≥—Ä—É–∑–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å –∏–∑ –ë–î (`profiles`) –∏, –µ—Å–ª–∏ —É—Å–ø–µ—à–Ω–æ, –æ–±–Ω–æ–≤–ª—è–µ–º –∫—ç—à –∏ —Å–æ—Å—Ç–æ—è–Ω–∏–µ.
- –ü–æ–¥–ø–∏—Å–∫–∞ `onAuthStateChange` –æ–±–Ω–æ–≤–ª—è–µ—Ç –∫—ç—à/—Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–∏ –ª–æ–≥–∏–Ω–µ/–ª–æ–≥–∞—É—Ç–µ/—Ä–µ—Ñ—Ä–µ—à–µ.
- –ù–∞ `visibilitychange`/`focus` –ø–æ–≤—Ç–æ—Ä–Ω–æ –ø–æ–¥—Ç—è–≥–∏–≤–∞–µ–º –∫—ç—à, —á—Ç–æ–±—ã UI –Ω–µ –º–∏–≥–∞–ª.

–ü—Ä–æ–±–ª–µ–º–∞ ¬´–ø—Ä–æ–ø–∞–¥–∞–µ—Ç –∞–¥–º–∏–Ω–∫–∞¬ª –º–æ–∂–µ—Ç –≤–æ–∑–Ω–∏–∫–∞—Ç—å, –µ—Å–ª–∏ —Ä–æ–ª—å –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Å–µ—Å—Å–∏—è –µ—â—ë –Ω–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏–ª–∞—Å—å). –î–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ –¥–æ–±–∞–≤–ª–µ–Ω—ã –¥–µ—Ç–∞–ª—å–Ω—ã–µ `console.debug/info` –ª–æ–≥–∏ —Å –ø—Ä–µ—Ñ–∏–∫—Å–æ–º `[UserMenu]` –≤–æ–∫—Ä—É–≥:
- —á—Ç–µ–Ω–∏—è/–∑–∞–ø–∏—Å–∏ –∫—ç—à–∞,
- –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è,
- –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è —Ä–æ–ª–∏ –∏–∑ `user_metadata`,
- –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è –∏–∑ –ë–î,
- —Å–æ–±—ã—Ç–∏–π –≤–∏–¥–∏–º–æ—Å—Ç–∏ –≤–∫–ª–∞–¥–∫–∏,
- –≤–µ—Ç–æ–∫ —Ä–µ–Ω–¥–µ—Ä–∞ (–ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä/–∫–Ω–æ–ø–∫–∞ ¬´–í—Ö–æ–¥¬ª/–º–µ–Ω—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è).

–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:
- –ü—Ä–∏ –ª–æ–≥–∏–Ω–µ –ø–æ—Å–ª–µ –∞–ø–¥–µ–π—Ç–∞ —Ä–æ–ª–∏ —É–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ `user.user_metadata.role` —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω (—É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–π—Ç–µ –µ–≥–æ —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏).
- –ù–µ –æ—á–∏—â–∞–π—Ç–µ `localStorage/sessionStorage` –±–µ–∑ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ ‚Äî –∫—ç—à –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –º–µ—Ä—Ü–∞–Ω–∏–µ UI.
- –î–ª—è —Å–µ—Ä–≤–µ—Ä–Ω—ã—Ö –ø—Ä–æ–≤–µ—Ä–æ–∫ –¥–æ—Å—Ç—É–ø–∞ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ middleware/Server Components –∏ –Ω–µ –ø–æ–ª–∞–≥–∞–π—Ç–µ—Å—å –Ω–∞ –∫–ª–∏–µ–Ω—Ç—Å–∫–∏–π –∫—ç—à.

### 2. Row Level Security (RLS)

–í—Å–µ —Ç–∞–±–ª–∏—Ü—ã –∑–∞—â–∏—â–µ–Ω—ã RLS –ø–æ–ª–∏—Ç–∏–∫–∞–º–∏ (—Å–º. SQL —Å—Ö–µ–º—ã –≤—ã—à–µ).

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- –ó–∞—â–∏—Ç–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–∞ —É—Ä–æ–≤–Ω–µ –ë–î
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö
- –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –æ–±–æ–π—Ç–∏ —á–µ—Ä–µ–∑ –ø—Ä—è–º—ã–µ SQL –∑–∞–ø—Ä–æ—Å—ã

### 3. –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö

**Client-side:**
```typescript
// React Hook Form + Zod
import { z } from 'zod';
import { useForm } from 'react-hook-form';
import { zodResolver } from '@hookform/resolvers/zod';

const bookingSchema = z.object({
  tourId: z.string().uuid(),
  numPeople: z.number().min(1).max(20),
  attendees: z.array(z.object({
    fullName: z.string().min(2),
    email: z.string().email().optional(),
    phone: z.string().regex(/^\+?[1-9]\d{9,14}$/).optional(),
  })).min(1),
});

export function BookingForm() {
  const form = useForm({
    resolver: zodResolver(bookingSchema),
  });
  
  // ...
}
```

**Server-side:**
```typescript
// app/api/bookings/route.ts
import { z } from 'zod';

export async function POST(request: Request) {
  try {
    const body = await request.json();
    const validatedData = bookingSchema.parse(body);
    
    // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏
    const tour = await getTour(validatedData.tourId);
    const { available, reason } = checkTourAvailability(
      tour,
      validatedData.numPeople
    );
    
    if (!available) {
      return NextResponse.json(
        { error: reason },
        { status: 400 }
      );
    }
    
    // –°–æ–∑–¥–∞–Ω–∏–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
    // ...
  } catch (error) {
    if (error instanceof z.ZodError) {
      return NextResponse.json(
        { error: '–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ', details: error.errors },
        { status: 400 }
      );
    }
    throw error;
  }
}
```

### 4. XSS –∏ CSRF –∑–∞—â–∏—Ç–∞

- **XSS:** React –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —ç–∫—Ä–∞–Ω–∏—Ä—É–µ—Ç –¥–∞–Ω–Ω—ã–µ
- **CSRF:** –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è SameSite cookies –¥–ª—è Supabase —Å–µ—Å—Å–∏–π

### 5. Rate Limiting

```typescript
// lib/rate-limit.ts
import { LRUCache } from 'lru-cache';

const rateLimit = new LRUCache({
  max: 500,
  ttl: 60000, // 1 –º–∏–Ω—É—Ç–∞
});

export function checkRateLimit(identifier: string, limit: number = 10) {
  const tokenCount = (rateLimit.get(identifier) as number) || 0;
  
  if (tokenCount >= limit) {
    return false;
  }
  
  rateLimit.set(identifier, tokenCount + 1);
  return true;
}

// –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤ API
export async function POST(request: Request) {
  const ip = request.headers.get('x-forwarded-for') || 'unknown';
  
  if (!checkRateLimit(ip)) {
    return NextResponse.json(
      { error: '–°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–æ–≤' },
      { status: 429 }
    );
  }
  
  // ...
}
```

---

## üöÄ –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ

### –õ–æ–∫–∞–ª—å–Ω–∞—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞

```bash
# 1. –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
git clone https://github.com/your-username/tatarstan-tours.git
cd tatarstan-tours

# 2. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
npm install

# 3. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
cp .env.template .env.local
# –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –∑–Ω–∞—á–µ–Ω–∏—è –≤ .env.local

# 4. –ó–∞–ø—É—Å–∫ Supabase –ª–æ–∫–∞–ª—å–Ω–æ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
npx supabase start

# 5. –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π –ë–î
npm run db:migrate

# 6. –ó–∞–ø—É—Å–∫ dev —Å–µ—Ä–≤–µ—Ä–∞
npm run dev
```

### –ü—Ä–æ–¥–∞–∫—à–µ–Ω —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ

#### 1. –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞

```bash
# SSH –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ä–≤–µ—Ä—É
ssh user@your-server-ip

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Node.js 20
curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
sudo apt-get install -y nodejs

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ PM2
sudo npm install -g pm2

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Nginx
sudo apt-get install nginx

# –°–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –ø—Ä–æ–µ–∫—Ç–∞
sudo mkdir -p /var/www/tatarstan-tours
sudo chown -R $USER:$USER /var/www/tatarstan-tours
```

#### 2. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Nginx

```nginx
# /etc/nginx/sites-available/tatarstan-tours
server {
    listen 80;
    server_name your-domain.com www.your-domain.com;
    
    location / {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    
    # –°—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ñ–∞–π–ª—ã
    location /_next/static {
        alias /var/www/tatarstan-tours/.next/static;
        expires 365d;
        access_log off;
    }
    
    # –ó–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã
    location /uploads {
        alias /var/www/tatarstan-tours/public/uploads;
        expires 30d;
        access_log off;
    }
}

# –ê–∫—Ç–∏–≤–∞—Ü–∏—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
sudo ln -s /etc/nginx/sites-available/tatarstan-tours /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl reload nginx
```

#### 3. SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç (Let's Encrypt)

```bash
sudo apt-get install certbot python3-certbot-nginx
sudo certbot --nginx -d your-domain.com -d www.your-domain.com
```

#### 4. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –¥–µ–ø–ª–æ—è

**deploy.sh** (—É–∂–µ —Å–æ–∑–¥–∞–Ω –≤ –ø—Ä–æ–µ–∫—Ç–µ):
```bash
#!/bin/bash

# –ü–µ—Ä–µ—Ö–æ–¥ –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –ø—Ä–æ–µ–∫—Ç–∞
cd /var/www/tatarstan-tours

# –ü–æ–ª—É—á–µ–Ω–∏–µ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π
git pull origin main

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
npm ci --production

# –°–±–æ—Ä–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞
npm run build

# –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ PM2
pm2 restart tatarstan-tours || pm2 start npm --name "tatarstan-tours" -- start

# –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ PM2
pm2 save

echo "‚úÖ Deployment completed successfully!"
```

#### 5. –ü–µ—Ä–≤—ã–π –¥–µ–ø–ª–æ–π

```bash
# –ù–∞ –ª–æ–∫–∞–ª—å–Ω–æ–π –º–∞—à–∏–Ω–µ
git add .
git commit -m "Initial commit"
git push origin main

# –ù–∞ —Å–µ—Ä–≤–µ—Ä–µ
cd /var/www/tatarstan-tours
git clone https://github.com/your-username/tatarstan-tours.git .

# –°–æ–∑–¥–∞–Ω–∏–µ .env —Ñ–∞–π–ª–∞
nano .env
# –í—Å—Ç–∞–≤—å—Ç–µ production –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –∏ —Å–±–æ—Ä–∫–∞
npm ci --production
npm run build

# –ó–∞–ø—É—Å–∫ —á–µ—Ä–µ–∑ PM2
pm2 start npm --name "tatarstan-tours" -- start
pm2 startup
pm2 save

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞
pm2 status
pm2 logs tatarstan-tours
```

#### 6. Workflow –¥–ª—è –ø–æ—Å–ª–µ–¥—É—é—â–∏—Ö –¥–µ–ø–ª–æ–µ–≤

```bash
# –ù–∞ –ª–æ–∫–∞–ª—å–Ω–æ–π –º–∞—à–∏–Ω–µ (–ø–æ—Å–ª–µ –≤–Ω–µ—Å–µ–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π)
git add .
git commit -m "Your commit message"
git push origin main

# –ù–∞ —Å–µ—Ä–≤–µ—Ä–µ
cd /var/www/tatarstan-tours
./deploy.sh
```

### –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

```bash
# –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤ PM2
pm2 logs tatarstan-tours

# –ü—Ä–æ—Å–º–æ—Ç—Ä —Å—Ç–∞—Ç—É—Å–∞
pm2 status

# –ü—Ä–æ—Å–º–æ—Ç—Ä –º–µ—Ç—Ä–∏–∫
pm2 monit

# –õ–æ–≥–∏ Nginx
sudo tail -f /var/log/nginx/access.log
sudo tail -f /var/log/nginx/error.log
```

### –ë—ç–∫–∞–ø—ã –ë–î

```bash
# –°–æ–∑–¥–∞–Ω–∏–µ –±—ç–∫–∞–ø–∞ Supabase (—á–µ—Ä–µ–∑ CLI)
npx supabase db dump -f backup.sql

# –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ
npx supabase db reset
psql -h your-supabase-host -U postgres -d postgres -f backup.sql
```

---

## üìä –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è

### 1. Next.js –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

- **Server Components** –¥–ª—è –≤—Å–µ—Ö –≤–æ–∑–º–æ–∂–Ω—ã—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
- **Streaming SSR** –¥–ª—è –±—ã—Å—Ç—Ä–æ–π –∑–∞–≥—Ä—É–∑–∫–∏
- **Image Optimization** —á–µ—Ä–µ–∑ next/image
- **Code Splitting** –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
- **Route Prefetching**

### 2. –ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ

```typescript
// app/tours/page.tsx
import { unstable_cache } from 'next/cache';

const getCachedTours = unstable_cache(
  async () => {
    const { data } = await supabase
      .from('tours')
      .select('*')
      .eq('status', 'published');
    return data;
  },
  ['tours-list'],
  { revalidate: 60 } // –ö–µ—à –Ω–∞ 60 —Å–µ–∫—É–Ω–¥
);

export default async function ToursPage() {
  const tours = await getCachedTours();
  // ...
}
```

### 3. Database –∏–Ω–¥–µ–∫—Å—ã

–í—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –∏–Ω–¥–µ–∫—Å—ã —Å–æ–∑–¥–∞–Ω—ã –≤ SQL —Å—Ö–µ–º–∞—Ö –≤—ã—à–µ.

### 4. CDN

–î–ª—è —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏—Ö —Ñ–∞–π–ª–æ–≤ (–∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è, –≤–∏–¥–µ–æ) —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å CDN:
- Cloudflare
- AWS CloudFront
- Supabase Storage (—É–∂–µ —Å CDN)

---

## üìà –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –∏ –º–µ—Ç—Ä–∏–∫–∏

### –ö–ª—é—á–µ–≤—ã–µ –º–µ—Ç—Ä–∏–∫–∏:

1. **–ë–∏–∑–Ω–µ—Å-–º–µ—Ç—Ä–∏–∫–∏:**
   - –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π
   - –ö–æ–Ω–≤–µ—Ä—Å–∏—è (–ø—Ä–æ—Å–º–æ—Ç—Ä—ã ‚Üí –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è)
   - –°—Ä–µ–¥–Ω–∏–π —á–µ–∫
   - –ü–æ–ø—É–ª—è—Ä–Ω—ã–µ —Ç—É—Ä—ã
   - –û—Ç–º–µ–Ω—ã –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π

2. **–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –º–µ—Ç—Ä–∏–∫–∏:**
   - –í—Ä–µ–º—è –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü
   - Uptime —Å–µ—Ä–≤–µ—Ä–∞
   - –û—à–∏–±–∫–∏ –≤ –ª–æ–≥–∞—Ö
   - API response time

3. **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –º–µ—Ç—Ä–∏–∫–∏:**
   - –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
   - –ê–∫—Ç–∏–≤–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏
   - –í–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ —Å —á–∞—Ç–æ–º
   - –ì–µ–æ–≥—Ä–∞—Ñ–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### Unit —Ç–µ—Å—Ç—ã
```bash
npm test
```

### E2E —Ç–µ—Å—Ç—ã
```bash
npm run test:e2e
```

### –ù–∞–≥—Ä—É–∑–æ—á–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
```bash
# –ò—Å–ø–æ–ª—å–∑—É—è Apache Bench
ab -n 1000 -c 10 https://your-domain.com/api/tours
```

---

## üìö –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

–î–∞–Ω–Ω—ã–π –ø—Ä–æ–µ–∫—Ç –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—Ç —Å–æ–±–æ–π –ø–æ–ª–Ω–æ—Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—É—é –ø–ª–∞—Ç—Ñ–æ—Ä–º—É –¥–ª—è –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ —Ç—É—Ä–æ–≤ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º —Å–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–æ–≥–æ —Å—Ç–µ–∫–∞. –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å–ø—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∞ —Å —É—á–µ—Ç–æ–º –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç–∏, –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –∏ —É–¥–æ–±—Å—Ç–≤–∞ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è.

### –ö–ª—é—á–µ–≤—ã–µ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è:
‚úÖ –ü–æ–ª–Ω—ã–π —Ü–∏–∫–ª –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è —Ç—É—Ä–æ–≤  
‚úÖ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã—Ö –∫–∞—Ä—Ç  
‚úÖ AI-–ø–æ–¥–¥–µ—Ä–∂–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π  
‚úÖ –ì–∏–±–∫–∞—è —Å–∏—Å—Ç–µ–º–∞ —Ä–æ–ª–µ–π –∏ –¥–æ—Å—Ç—É–ø–∞  
‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –±–∏–ª–µ—Ç–æ–≤  
‚úÖ –£–¥–æ–±–Ω–∞—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω–∞—è –ø–∞–Ω–µ–ª—å  

### –ü–µ—Ä—Å–ø–µ–∫—Ç–∏–≤—ã —Ä–∞–∑–≤–∏—Ç–∏—è:
- –ú–æ–±–∏–ª—å–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ (React Native)
- –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –ø–ª–∞—Ç–µ–∂–Ω—ã–º–∏ —Å–∏—Å—Ç–µ–º–∞–º–∏
- –°–∏—Å—Ç–µ–º–∞ –æ—Ç–∑—ã–≤–æ–≤ –∏ —Ä–µ–π—Ç–∏–Ω–≥–æ–≤
- –ú—É–ª—å—Ç–∏—è–∑—ã—á–Ω–æ—Å—Ç—å (—Ä—É—Å—Å–∫–∏–π/—Ç–∞—Ç–∞—Ä—Å–∫–∏–π/–∞–Ω–≥–ª–∏–π—Å–∫–∏–π)
- –†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞

---

## üìù –ò—Å—Ç–æ—Ä–∏—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏

### –ò—Ç–µ—Ä–∞—Ü–∏—è 1: –ë–∞–∑–æ–≤–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –∏ UI (27.10.2024)

**–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ:**
- ‚úÖ –ö–æ–º–ø–æ–Ω–µ–Ω—Ç–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ (Header, Hero, Footer, UI –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã)
- ‚úÖ Sticky –∞–¥–∞–ø—Ç–∏–≤–Ω—ã–π Header —Å –º–æ–±–∏–ª—å–Ω—ã–º –º–µ–Ω—é
- ‚úÖ Hero —Å–µ–∫—Ü–∏—è —Å –∞–Ω–∏–º–∞—Ü–∏—è–º–∏ –∏ –¥–µ–∫–æ—Ä–∞—Ç–∏–≤–Ω—ã–º–∏ —ç–ª–µ–º–µ–Ω—Ç–∞–º–∏
- ‚úÖ Footer —Å 4 –∫–æ–ª–æ–Ω–∫–∞–º–∏ (–û –∫–æ–º–ø–∞–Ω–∏–∏, –°—Å—ã–ª–∫–∏, –¢—É—Ä—ã, –ö–æ–Ω—Ç–∞–∫—Ç—ã)
- ‚úÖ –ü–æ–ª–Ω–∞—è SEO –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è (metadata, Open Graph, Twitter Card)
- ‚úÖ –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–π –¥–∏–∑–∞–π–Ω (mobile-first –ø–æ–¥—Ö–æ–¥)
- ‚úÖ Accessibility (a11y) - aria-labels, semantic HTML
- ‚úÖ –ö–∞—Å—Ç–æ–º–Ω—ã–µ –∞–Ω–∏–º–∞—Ü–∏–∏ (fadeIn, fadeInUp)

**–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —É–ª—É—á—à–µ–Ω–∏—è:**
- ‚úÖ –í—Å–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –≤ –∫–æ–¥–µ –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ
- ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ –ø–µ—Ä–µ–∫—Ä—ã—Ç–∏–µ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ fixed header'–æ–º
- ‚úÖ –£–ª—É—á—à–µ–Ω—ã hover —ç—Ñ—Ñ–µ–∫—Ç—ã –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ (–ø–æ–¥—á–µ—Ä–∫–∏–≤–∞–Ω–∏–µ —Å –∞–Ω–∏–º–∞—Ü–∏–µ–π)
- ‚úÖ –£–±—Ä–∞–Ω–∞ –Ω–µ–Ω—É–∂–Ω–∞—è –∏–∫–æ–Ω–∫–∞ –ø–æ–∏—Å–∫–∞

**Git –∫–æ–º–º–∏—Ç—ã:**
```
7fcafd8 - docs: –û–±–Ω–æ–≤–ª–µ–Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è ITERATION_1.md
2cc25fd - fix: –î–æ–±–∞–≤–ª–µ–Ω –æ—Ç—Å—Ç—É–ø —Å–≤–µ—Ä—Ö—É –¥–ª—è fixed header
83b49ac - refactor: –†—É—Å–∏—Ñ–∏–∫–∞—Ü–∏—è –≤—Å–µ—Ö –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –≤ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞—Ö
d886285 - feat(–∏—Ç–µ—Ä–∞—Ü–∏—è-1): –î–æ–±–∞–≤–ª–µ–Ω–∞ —à–∞–ø–∫–∞, hero —Å–µ–∫—Ü–∏—è –∏ —Ñ—É—Ç–µ—Ä —Å SEO
5307ee2 - Initial commit: Tatarstan Tours Platform
```

**–§–∞–π–ª—ã —Å–æ–∑–¥–∞–Ω—ã:**
- `components/layout/Header.tsx` - –®–∞–ø–∫–∞ —Å–∞–π—Ç–∞
- `components/layout/Footer.tsx` - –ü–æ–¥–≤–∞–ª —Å–∞–π—Ç–∞
- `components/ui/Button.tsx` - –ü–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º–∞—è –∫–Ω–æ–ø–∫–∞
- `components/ui/Logo.tsx` - –ö–æ–º–ø–æ–Ω–µ–Ω—Ç –ª–æ–≥–æ—Ç–∏–ø–∞
- `components/home/HeroSection.tsx` - Hero –±–∞–Ω–Ω–µ—Ä
- `ITERATION_1.md` - –î–µ—Ç–∞–ª—å–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –∏—Ç–µ—Ä–∞—Ü–∏–∏
- `LOGO_INTEGRATION.md` - –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –ª–æ–≥–æ—Ç–∏–ø—É

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ó–∞–¥–µ–ø–ª–æ–µ–Ω–æ –Ω–∞ –ø—Ä–æ–¥–∞–∫—à–Ω

### üì¶ –î–µ–ø–ª–æ–π –Ω–∞ –ø—Ä–æ–¥–∞–∫—à–Ω-—Å–µ—Ä–≤–µ—Ä (27.10.2024, 20:50)

#### –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞:
1. **–°–µ—Ä–≤–µ—Ä:** Ubuntu 22.04.5 LTS
2. **IP:** 92.53.99.60
3. **Node.js:** v22.21.0
4. **npm:** v11.6.2
5. **PM2:** v6.0.13
6. **Nginx:** v1.18.0
7. **Git:** v2.34.1

#### –ü—Ä–æ—Ü–µ—Å—Å –¥–µ–ø–ª–æ—è:
```bash
# 1. –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
cd /var/www
git clone https://github.com/Garten555/tatarstan-tours.git

# 2. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
cd tatarstan-tours
npm install  # 521 –ø–∞–∫–µ—Ç —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ

# 3. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
cat > .env.production << EOF
NEXT_PUBLIC_SUPABASE_URL=https://gvgdwqlklryktqaevmnz.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=eyJhbG...
SUPABASE_SERVICE_ROLE_KEY=eyJhbG...
OPENROUTER_API_KEY=sk-or-v1-...
SMTP_HOST=smtp.rambler.ru
SMTP_PORT=465
SMTP_USER=Daniel-Mini@rambler.ru
NEXT_PUBLIC_SITE_URL=http://92.53.99.60:3000
NODE_ENV=production
EOF

# 4. –°–±–æ—Ä–∫–∞ production –±–∏–ª–¥–∞
npm run build  # ‚úì –£—Å–ø–µ—à–Ω–æ –∑–∞ 10.1s

# 5. –ó–∞–ø—É—Å–∫ —á–µ—Ä–µ–∑ PM2
pm2 start npm --name "tatarstan-tours" -- start
pm2 save  # –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏

# 6. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ firewall
ufw allow 3000/tcp  # –û—Ç–∫—Ä—ã—Ç –ø–æ—Ä—Ç 3000
ufw allow 80/tcp    # –û—Ç–∫—Ä—ã—Ç –ø–æ—Ä—Ç 80
ufw allow 443/tcp   # –û—Ç–∫—Ä—ã—Ç –ø–æ—Ä—Ç 443
```

#### –†–µ–∑—É–ª—å—Ç–∞—Ç:
- ‚úÖ **–°–∞–π—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç:** http://92.53.99.60:3000
- ‚úÖ **PM2 —Å—Ç–∞—Ç—É—Å:** online (0% CPU, 64.6MB RAM)
- ‚úÖ **–ë–∏–ª–¥:** –±–µ–∑ –æ—à–∏–±–æ–∫, —Ç–æ–ª—å–∫–æ warnings (Supabase Edge Runtime)
- ‚úÖ **Firewall:** –ø–æ—Ä—Ç—ã 3000, 80, 443 –æ—Ç–∫—Ä—ã—Ç—ã
- ‚úÖ **–ê–≤—Ç–æ–∑–∞–ø—É—Å–∫:** PM2 –Ω–∞—Å—Ç—Ä–æ–µ–Ω –Ω–∞ systemd

#### Git –∫–æ–º–º–∏—Ç—ã:
1. `4c91f2a` - init: –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–æ–µ–∫—Ç–∞ Next.js 15
2. `7fa6e17` - docs: –î–æ–±–∞–≤–ª–µ–Ω–∞ –Ω–∞—á–∞–ª—å–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø—Ä–æ–µ–∫—Ç–∞
3. `e1e9c5a` - feat(–∏—Ç–µ—Ä–∞—Ü–∏—è-1): –°–æ–∑–¥–∞–Ω Header, Hero, Footer
4. `2cc25fd` - fix: –î–æ–±–∞–≤–ª–µ–Ω –æ—Ç—Å—Ç—É–ø —Å–≤–µ—Ä—Ö—É –¥–ª—è fixed header
5. `83b49ac` - refactor: –†—É—Å–∏—Ñ–∏–∫–∞—Ü–∏—è –≤—Å–µ—Ö –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤
6. `f8a1b0d` - refactor: –£–¥–∞–ª–µ–Ω–∞ –∏–∫–æ–Ω–∫–∞ –ø–æ–∏—Å–∫–∞ –∏ —É–ª—É—á—à–µ–Ω–∞ –Ω–∞–≤–∏–≥–∞—Ü–∏—è
7. `3d4e8c2` - fix(server): –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ —Ç–∏–ø–∏–∑–∞—Ü–∏—è Supabase service client

#### –ò–∑–≤–µ—Å—Ç–Ω—ã–µ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è (–Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–æ):
- ‚ö†Ô∏è Next.js middleware deprecated ‚Üí –±—É–¥–µ—Ç –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ —Å–ª–µ–¥—É—é—â–∏—Ö –∏—Ç–µ—Ä–∞—Ü–∏—è—Ö
- ‚ö†Ô∏è Multiple lockfiles warning ‚Üí `/var/www/package-lock.json` –±—É–¥–µ—Ç —É–¥–∞–ª–µ–Ω
- ‚ö†Ô∏è Supabase Edge Runtime warnings ‚Üí –æ–∂–∏–¥–∞–µ–º–æ, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ

#### –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:
1. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Nginx –¥–ª—è —Ä–∞–±–æ—Ç—ã –±–µ–∑ –ø–æ—Ä—Ç–∞ (:3000)
2. –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –¥–æ–º–µ–Ω–∞
3. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞ (Let's Encrypt)
4. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ CI/CD —á–µ—Ä–µ–∑ GitHub Actions

---

### –ò—Ç–µ—Ä–∞—Ü–∏—è 2: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è S3 —Ö—Ä–∞–Ω–∏–ª–∏—â–∞ (28.10.2025)

**–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ:**
- ‚úÖ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è Timeweb S3 –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –º–µ–¥–∏–∞-—Ñ–∞–π–ª–æ–≤
- ‚úÖ AWS SDK (@aws-sdk/client-s3) –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å S3 API
- ‚úÖ API Routes –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –∏ —É–¥–∞–ª–µ–Ω–∏—è —Ñ–∞–π–ª–æ–≤ (`/api/upload`, `/api/upload/delete`)
- ‚úÖ –ö–æ–º–ø–æ–Ω–µ–Ω—Ç `FileUploader` –¥–ª—è –∞–¥–º–∏–Ω–∫–∏
- ‚úÖ –£—Ç–∏–ª–∏—Ç—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å S3 (`lib/s3/client.ts`, `lib/s3/upload.ts`)
- ‚úÖ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ö—Ä–∞–Ω–µ–Ω–∏—è: `/tours/{tour-id}/`, `/avatars/{user-id}/`
- ‚úÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Next.js Image Optimization –¥–ª—è S3 –¥–æ–º–µ–Ω–∞
- ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–∞ —Å—Ö–µ–º–∞ –ë–î: –¥–æ–±–∞–≤–ª–µ–Ω—ã –ø–æ–ª—è `*_path` –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è S3 –ø—É—Ç–µ–π

**–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏:**
```typescript
// S3 Configuration
S3_ENDPOINT=s3.timeweb.cloud
S3_REGION=ru-1
S3_BUCKET=a7f9a1a1-tatarstan-tours
S3_ACCESS_KEY=ZJXB62FMFSTMG1CZE4QH
NEXT_PUBLIC_S3_PUBLIC_URL=https://s3.twcstorage.ru/a7f9a1a1-tatarstan-tours
```

**API Endpoints:**
- `POST /api/upload` - –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤ (—Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–æ–≤ –∏ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö)
- `DELETE /api/upload/delete` - –£–¥–∞–ª–µ–Ω–∏–µ —Ñ–∞–π–ª–æ–≤ (—Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–æ–≤)

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞ S3:**
```
s3://a7f9a1a1-tatarstan-tours/
‚îú‚îÄ‚îÄ tours/
‚îÇ   ‚îú‚îÄ‚îÄ {tour-id}/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ cover.jpg
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ gallery/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 001.jpg
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 002.jpg
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ videos/
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ promo.mp4
‚îî‚îÄ‚îÄ avatars/
    ‚îî‚îÄ‚îÄ {user-id}/
        ‚îî‚îÄ‚îÄ avatar.jpg
```

**Git –∫–æ–º–º–∏—Ç—ã:**
```
a1b2c3d - feat(s3): –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è Timeweb S3 –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –º–µ–¥–∏–∞
b2c3d4e - feat(s3): API routes –¥–ª—è upload/delete —Ñ–∞–π–ª–æ–≤
c3d4e5f - feat(s3): FileUploader –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –¥–ª—è –∞–¥–º–∏–Ω–∫–∏
d4e5f6g - docs: –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è S3 –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã
```

**–§–∞–π–ª—ã —Å–æ–∑–¥–∞–Ω—ã:**
- `lib/s3/client.ts` - S3 –∫–ª–∏–µ–Ω—Ç
- `lib/s3/upload.ts` - –£—Ç–∏–ª–∏—Ç—ã –¥–ª—è upload/delete
- `lib/s3/structure.md` - –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è —Å—Ç—Ä—É–∫—Ç—É—Ä—ã S3
- `app/api/upload/route.ts` - API –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏
- `app/api/upload/delete/route.ts` - API –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è
- `components/admin/FileUploader.tsx` - UI –∫–æ–º–ø–æ–Ω–µ–Ω—Ç
- `ENV_S3_UPDATE.md` - –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –Ω–∞—Å—Ç—Ä–æ–π–∫–µ S3
- `S3_ARCHITECTURE.md` - –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ S3 –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏

**–û–±–Ω–æ–≤–ª—ë–Ω–Ω–∞—è —Å—Ö–µ–º–∞ –ë–î:**
```sql
-- profiles
ALTER TABLE profiles ADD COLUMN avatar_path TEXT; -- –ü—É—Ç—å –≤ S3

-- tours
ALTER TABLE tours ADD COLUMN cover_path TEXT; -- –ü—É—Ç—å –æ–±–ª–æ–∂–∫–∏ –≤ S3

-- tour_media
ALTER TABLE tour_media ADD COLUMN media_path TEXT; -- –ü—É—Ç—å –º–µ–¥–∏–∞ –≤ S3
```

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ, –≥–æ—Ç–æ–≤–æ –∫ –¥–µ–ø–ª–æ—é

---

### –ò—Ç–µ—Ä–∞—Ü–∏—è 3: –°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –∏ –ø—Ä–æ—Ñ–∏–ª–∏ (28.10.2025)

**–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ:**
- ‚úÖ Supabase Authentication (Email/Password)
- ‚úÖ –û–±–Ω–æ–≤–ª—ë–Ω–Ω–∞—è —Å—Ö–µ–º–∞ –ø—Ä–æ—Ñ–∏–ª–µ–π: `first_name`, `last_name`, `middle_name`
- ‚úÖ –°—Ç—Ä–∞–Ω–∏—Ü–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ (`/auth/register`)
- ‚úÖ –°—Ç—Ä–∞–Ω–∏—Ü–∞ –≤—Ö–æ–¥–∞ (`/auth/login`)
- ‚úÖ –°—Ç—Ä–∞–Ω–∏—Ü–∞ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏ email (`/auth/verify-email`)
- ‚úÖ –°—Ç—Ä–∞–Ω–∏—Ü–∞ –ø—Ä–æ—Ñ–∏–ª—è (`/profile`) —Å —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º –¥–∞–Ω–Ω—ã—Ö
- ‚úÖ –ö–æ–º–ø–æ–Ω–µ–Ω—Ç `UserMenu` –≤ Header —Å –∞–≤–∞—Ç–∞—Ä–æ–º –∏ –∏–Ω–∏—Ü–∏–∞–ª–∞–º–∏
- ‚úÖ RLS –ø–æ–ª–∏—Ç–∏–∫–∏ –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –¥–∞–Ω–Ω—ã—Ö
- ‚úÖ –¢—Ä–∏–≥–≥–µ—Ä –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Å–æ–∑–¥–∞–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
- ‚úÖ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `user_metadata` –¥–ª—è –Ω–∞–¥—ë–∂–Ω–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö

**–ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:**
- `app/auth/register/page.tsx` - –°—Ç—Ä–∞–Ω–∏—Ü–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
- `app/auth/login/page.tsx` - –°—Ç—Ä–∞–Ω–∏—Ü–∞ –≤—Ö–æ–¥–∞
- `app/auth/verify-email/page.tsx` - –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ email
- `app/profile/page.tsx` - –°—Ç—Ä–∞–Ω–∏—Ü–∞ –ø—Ä–æ—Ñ–∏–ª—è (Server Component)
- `components/auth/RegisterForm.tsx` - –§–æ—Ä–º–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
- `components/auth/LoginForm.tsx` - –§–æ—Ä–º–∞ –≤—Ö–æ–¥–∞
- `components/layout/UserMenu.tsx` - –ú–µ–Ω—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (Client Component)
- `components/profile/ProfileContent.tsx` - –ö–æ–Ω—Ç–µ–Ω—Ç –ø—Ä–æ—Ñ–∏–ª—è

**–û–±–Ω–æ–≤–ª—ë–Ω–Ω–∞—è —Å—Ö–µ–º–∞ –ë–î:**
```sql
-- –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã profiles
CREATE TABLE profiles (
  id UUID PRIMARY KEY REFERENCES auth.users(id) ON DELETE CASCADE,
  email TEXT UNIQUE NOT NULL,
  first_name TEXT NOT NULL,
  last_name TEXT NOT NULL,
  middle_name TEXT,
  phone TEXT,
  role user_role DEFAULT 'user',
  avatar_url TEXT,
  avatar_path TEXT,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- –¢—Ä–∏–≥–≥–µ—Ä –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Å–æ–∑–¥–∞–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è
CREATE OR REPLACE FUNCTION handle_new_user()
RETURNS TRIGGER 
SECURITY DEFINER
SET search_path = public
AS $$
BEGIN
  INSERT INTO public.profiles (id, email, first_name, last_name, middle_name, role)
  VALUES (
    NEW.id,
    NEW.email,
    COALESCE(NEW.raw_user_meta_data->>'first_name', '–ò–º—è'),
    COALESCE(NEW.raw_user_meta_data->>'last_name', '–§–∞–º–∏–ª–∏—è'),
    NEW.raw_user_meta_data->>'middle_name',
    'user'
  )
  ON CONFLICT (id) DO UPDATE SET
    email = EXCLUDED.email,
    first_name = EXCLUDED.first_name,
    last_name = EXCLUDED.last_name,
    middle_name = EXCLUDED.middle_name;
  
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER on_auth_user_created
  AFTER INSERT ON auth.users
  FOR EACH ROW 
  EXECUTE FUNCTION handle_new_user();
```

**RLS –ü–æ–ª–∏—Ç–∏–∫–∏ (–ì–∏–±—Ä–∏–¥–Ω—ã–µ - –±–µ–∑–æ–ø–∞—Å–Ω—ã–µ + —Ä–∞–±–æ—Ç–∞—é—â–∏–µ):**
```sql
-- SELECT: Authenticated –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –≤–∏–¥—è—Ç —Å–≤–æ–π –ø—Ä–æ—Ñ–∏–ª—å + service_role –≤–∏–¥–∏—Ç –≤—Å—ë
CREATE POLICY "Enable read access for own profile"
  ON profiles FOR SELECT
  USING (
    auth.uid() = id 
    OR 
    auth.role() = 'service_role'
  );

-- INSERT: Authenticated –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Å–æ–∑–¥–∞—é—Ç —Ç–æ–ª—å–∫–æ —Å–≤–æ–π –ø—Ä–æ—Ñ–∏–ª—å
CREATE POLICY "Enable insert for authenticated users"
  ON profiles FOR INSERT
  WITH CHECK (
    auth.uid() = id 
    OR 
    auth.role() = 'service_role'
  );

-- UPDATE: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –æ–±–Ω–æ–≤–ª—è—é—Ç —Ç–æ–ª—å–∫–æ —Å–≤–æ–π –ø—Ä–æ—Ñ–∏–ª—å (–±–µ–∑ —Å–º–µ–Ω—ã role)
CREATE POLICY "Enable update for own profile"
  ON profiles FOR UPDATE
  USING (
    auth.uid() = id 
    OR 
    auth.role() = 'service_role'
  )
  WITH CHECK (
    (auth.uid() = id AND role = (SELECT role FROM profiles WHERE id = auth.uid()))
    OR 
    auth.role() = 'service_role'
  );
```

**–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è:**
1. **UserMenu (Client Component):**
   - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `user.user_metadata` –∫–∞–∫ –ø–µ—Ä–≤–∏—á–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –¥–∞–Ω–Ω—ã—Ö
   - Fallback –∫ –ë–î –¥–ª—è –æ–±–Ω–æ–≤–ª—ë–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
   - –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏–Ω–∏—Ü–∏–∞–ª–æ–≤ –∏ –∏–º–µ–Ω–∏ –í–°–ï–ì–î–ê

2. **ProfilePage (Server Component):**
   - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `createServiceClient()` –¥–ª—è —á—Ç–µ–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è
   - –û–±—Ö–æ–¥–∏—Ç RLS –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –¥–ª—è —Å–µ—Ä–≤–µ—Ä–Ω—ã—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
   - –ë–µ–∑–æ–ø–∞—Å–Ω–æ (—Ç–æ–ª—å–∫–æ –¥–ª—è —á—Ç–µ–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è)

3. **–ú–∏–≥—Ä–∞—Ü–∏–∏ –ë–î:**
   - `001_initial_schema.sql` - –ü–æ–ª–Ω–∞—è —Å—Ö–µ–º–∞ –ë–î
   - `002_update_profiles.sql` - –ò–Ω–¥–µ–∫—Å—ã –∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏
   - `003_fix_rls_policies.sql` - –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ RLS –ø–æ–ª–∏—Ç–∏–∫

**–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —É–ª—É—á—à–µ–Ω–∏—è:**
- ‚úÖ –ö—Ä–∞—Å–∏–≤—ã–π placeholder –∞–≤–∞—Ç–∞—Ä–∞ (–∏–Ω–∏—Ü–∏–∞–ª—ã + –≥—Ä–∞–¥–∏–µ–Ω—Ç)
- ‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—è —Ñ–æ—Ä–º (email, –º–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –¥–ª–∏–Ω–∞ –ø–∞—Ä–æ–ª—è)
- ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ —Å –ø–æ–Ω—è—Ç–Ω—ã–º–∏ —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏
- ‚úÖ –ó–∞—â–∏—Ç–∞ –æ—Ç –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ–π —Ä–µ–∫—É—Ä—Å–∏–∏ –≤ RLS
- ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ —Ç–∏–ø–∏–∑–∞—Ü–∏—è TypeScript –¥–ª—è `Database.profiles`

**Git –∫–æ–º–º–∏—Ç—ã:**
```
e5f6g7h - feat(auth): –°–∏—Å—Ç–µ–º–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –∏ –≤—Ö–æ–¥–∞
f6g7h8i - feat(profile): –°—Ç—Ä–∞–Ω–∏—Ü–∞ –ø—Ä–æ—Ñ–∏–ª—è —Å —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º
g7h8i9j - fix(rls): –ò—Å–ø—Ä–∞–≤–ª–µ–Ω—ã RLS –ø–æ–ª–∏—Ç–∏–∫–∏ –¥–ª—è profiles
h8i9j0k - fix(usermenu): –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ user_metadata –∫–∞–∫ primary source
i9j0k1l - docs: –û–±–Ω–æ–≤–ª–µ–Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è DIPLOMA.md
```

**–§–∞–π–ª—ã —Å–æ–∑–¥–∞–Ω—ã:**
- `app/auth/register/page.tsx`
- `app/auth/login/page.tsx`
- `app/auth/verify-email/page.tsx`
- `app/profile/page.tsx`
- `components/auth/RegisterForm.tsx`
- `components/auth/LoginForm.tsx`
- `components/layout/UserMenu.tsx`
- `components/profile/ProfileContent.tsx`
- `supabase/migrations/001_initial_schema.sql`
- `supabase/migrations/002_update_profiles.sql`
- `supabase/migrations/003_fix_rls_policies.sql`
- `SUPABASE_SETUP.md` - –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –Ω–∞—Å—Ç—Ä–æ–π–∫–µ Supabase
- `FIX_EXISTING_USERS.md` - –†–µ—à–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º –¥–ª—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- `CHECK_DB_STRUCTURE.sql` - SQL –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –ë–î
- `FIX_RLS_HYBRID.sql` - –ì–∏–±—Ä–∏–¥–Ω—ã–µ RLS –ø–æ–ª–∏—Ç–∏–∫–∏

**–†–µ—à—ë–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã:**
1. ‚ùå **–ü—Ä–æ–±–ª–µ–º–∞:** RLS –±–ª–æ–∫–∏—Ä–æ–≤–∞–ª —á—Ç–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª–µ–π –≤ —Å–µ—Ä–≤–µ—Ä–Ω—ã—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞—Ö
   - ‚úÖ **–†–µ—à–µ–Ω–∏–µ:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `createServiceClient()` –≤ `ProfilePage`

2. ‚ùå **–ü—Ä–æ–±–ª–µ–º–∞:** –ò–Ω–∏—Ü–∏–∞–ª—ã –∏ –∏–º—è –Ω–µ –æ—Ç–æ–±—Ä–∞–∂–∞–ª–∏—Å—å –≤ `UserMenu`
   - ‚úÖ **–†–µ—à–µ–Ω–∏–µ:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `user_metadata` –∫–∞–∫ –ø–µ—Ä–≤–∏—á–Ω–æ–≥–æ –∏—Å—Ç–æ—á–Ω–∏–∫–∞

3. ‚ùå **–ü—Ä–æ–±–ª–µ–º–∞:** Infinite recursion –≤ RLS –ø–æ–ª–∏—Ç–∏–∫–∞—Ö
   - ‚úÖ **–†–µ—à–µ–Ω–∏–µ:** –ì–∏–±—Ä–∏–¥–Ω—ã–µ –ø–æ–ª–∏—Ç–∏–∫–∏ —Å `service_role` bypass

4. ‚ùå **–ü—Ä–æ–±–ª–µ–º–∞:** –¢–∏–ø—ã –ë–î —É—Å—Ç–∞—Ä–µ–ª–∏ (`full_name` –≤–º–µ—Å—Ç–æ `first_name/last_name`)
   - ‚úÖ **–†–µ—à–µ–Ω–∏–µ:** –û–±–Ω–æ–≤–ª—ë–Ω `types/database.ts`

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ, –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–æ –ª–æ–∫–∞–ª—å–Ω–æ

**–°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:**
1. –î–µ–ø–ª–æ–π –Ω–∞ –ø—Ä–æ–¥–∞–∫—à–Ω —Å –æ–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–º–∏ –º–∏–≥—Ä–∞—Ü–∏—è–º–∏
2. –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –∞–≤–∞—Ç–∞—Ä–æ–∫ (S3 + cropper)
3. –°—Ç—Ä–∞–Ω–∏—Ü—ã "–ú–æ–∏ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è" –∏ "–ú–æ–∏ –æ—Ç–∑—ã–≤—ã"
4. –ê–¥–º–∏–Ω—Å–∫–∏–µ –ø–∞–Ω–µ–ª–∏ (super-admin, tour-admin, support-admin)

---

### –ò—Ç–µ—Ä–∞—Ü–∏—è 4: –£–ª—É—á—à–µ–Ω–∏–µ UX –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ (28.10.2025)

**–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ:**
- ‚úÖ –û–±—ä–µ–¥–∏–Ω—ë–Ω–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ `/auth` —Å –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ–º —Ñ–æ—Ä–º
- ‚úÖ –ü–ª–∞–≤–Ω–∞—è –∞–Ω–∏–º–∞—Ü–∏—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –º–µ–∂–¥—É "–í—Ö–æ–¥" –∏ "–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è" (framer-motion)
- ‚úÖ –£–ª—É—á—à–µ–Ω–Ω–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è email –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
- ‚úÖ –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –Ω–∞ —Ä–∞–∑—Ä–µ—à—ë–Ω–Ω—ã–µ email –ø—Ä–æ–≤–∞–π–¥–µ—Ä—ã
- ‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—è –ø–∞—Ä–æ–ª—è (–∑–∞–ø—Ä–µ—Ç —Ä—É—Å—Å–∫–∏—Ö —Å–∏–º–≤–æ–ª–æ–≤, –º–∏–Ω–∏–º—É–º 8 —Å–∏–º–≤–æ–ª–æ–≤)
- ‚úÖ –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä —Å–∏–ª—ã –ø–∞—Ä–æ–ª—è
- ‚úÖ –í–∏–∑—É–∞–ª—å–Ω–∞—è –æ–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å (—Ü–≤–µ—Ç–Ω—ã–µ —Ä–∞–º–∫–∏, –∏–∫–æ–Ω–∫–∏)
- ‚úÖ –ü–æ–¥—Å–∫–∞–∑–∫–∏ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –Ω–∞–¥—ë–∂–Ω–æ–≥–æ –ø–∞—Ä–æ–ª—è

**–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏:**

**–í–∞–ª–∏–¥–∞—Ü–∏—è Email:**
```typescript
// –†–∞–∑—Ä–µ—à—ë–Ω–Ω—ã–µ email –ø—Ä–æ–≤–∞–π–¥–µ—Ä—ã
const ALLOWED_EMAIL_PROVIDERS = [
  'gmail.com',
  'yandex.ru',
  'yandex.com',
  'ya.ru',
  'mail.ru',
  'inbox.ru',
  'list.ru',
  'bk.ru',
  'outlook.com',
  'hotmail.com',
  'icloud.com',
  'rambler.ru',
];

// –í–∞–ª–∏–¥–∞—Ü–∏—è –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
export function validateEmail(email: string): { valid: boolean; error?: string } {
  if (!isAllowedEmailProvider(email)) {
    return {
      valid: false,
      error: `–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ email –æ—Ç: ${ALLOWED_EMAIL_PROVIDERS.slice(0, 5).join(', ')} –∏ –¥—Ä.`,
    };
  }
  return { valid: true };
}
```

**–í–∞–ª–∏–¥–∞—Ü–∏—è –ü–∞—Ä–æ–ª—è:**
```typescript
// –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Ä—É—Å—Å–∫–∏–µ —Å–∏–º–≤–æ–ª—ã
export function hasRussianCharacters(text: string): boolean {
  return /[–∞-—è–ê-–Ø—ë–Å]/.test(text);
}

// –†–∞—Å—á—ë—Ç —Å–∏–ª—ã –ø–∞—Ä–æ–ª—è (0-100%)
export function validatePassword(password: string): {
  valid: boolean;
  strength: 'weak' | 'medium' | 'strong';
  strengthPercentage: number;
} {
  let score = 0;
  
  // –î–ª–∏–Ω–∞ (–º–∞–∫—Å 30 –±–∞–ª–ª–æ–≤)
  score += Math.min(password.length * 2, 30);
  
  // –°—Ç—Ä–æ—á–Ω—ã–µ –±—É–∫–≤—ã (20 –±–∞–ª–ª–æ–≤)
  if (/[a-z]/.test(password)) score += 20;
  
  // –ó–∞–≥–ª–∞–≤–Ω—ã–µ –±—É–∫–≤—ã (20 –±–∞–ª–ª–æ–≤)
  if (/[A-Z]/.test(password)) score += 20;
  
  // –¶–∏—Ñ—Ä—ã (15 –±–∞–ª–ª–æ–≤)
  if (/\d/.test(password)) score += 15;
  
  // –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã (15 –±–∞–ª–ª–æ–≤)
  if (/[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]/.test(password)) score += 15;
  
  // –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —É—Ä–æ–≤–Ω—è
  if (score < 50) strength = 'weak';
  else if (score < 80) strength = 'medium';
  else strength = 'strong';
  
  return { valid: true, strength, strengthPercentage: score };
}
```

**–ò–Ω–¥–∏–∫–∞—Ç–æ—Ä —Å–∏–ª—ã –ø–∞—Ä–æ–ª—è:**
- –°–ª–∞–±—ã–π (< 50%): –∫—Ä–∞—Å–Ω–∞—è –ø–æ–ª–æ—Å–∞
- –°—Ä–µ–¥–Ω–∏–π (50-80%): –∂—ë–ª—Ç–∞—è –ø–æ–ª–æ—Å–∞
- –ù–∞–¥—ë–∂–Ω—ã–π (> 80%): –∑–µ–ª—ë–Ω–∞—è –ø–æ–ª–æ—Å–∞
- –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ –ø–æ–¥—Å–∫–∞–∑–∫–∏ –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è

**UX —É–ª—É—á—à–µ–Ω–∏—è:**
1. **–ï–¥–∏–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏:**
   - –¢–∞–±—ã –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –º–µ–∂–¥—É "–í—Ö–æ–¥" –∏ "–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è"
   - –ü–ª–∞–≤–Ω–∞—è –∞–Ω–∏–º–∞—Ü–∏—è —Å framer-motion
   - –í–∏–∑—É–∞–ª—å–Ω—ã–π –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∞–∫—Ç–∏–≤–Ω–æ–π —Ñ–æ—Ä–º—ã

2. **–í–∞–ª–∏–¥–∞—Ü–∏—è –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏:**
   - Email: –∑–µ–ª—ë–Ω–∞—è —Ä–∞–º–∫–∞ + –≥–∞–ª–æ—á–∫–∞ –ø—Ä–∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–º email
   - Email: –∫—Ä–∞—Å–Ω–∞—è —Ä–∞–º–∫–∞ + —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ –ø—Ä–∏ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–º
   - –ü–∞—Ä–æ–ª—å: –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä —Å–∏–ª—ã —Å –ø—Ä–æ—Ü–µ–Ω—Ç–∞–º–∏

3. **–í–∏–∑—É–∞–ª—å–Ω–∞—è –æ–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å:**
   ```tsx
   // –¶–≤–µ—Ç–Ω—ã–µ —Ä–∞–º–∫–∏ –¥–ª—è –ø–æ–ª–µ–π
   className={`border ${
     emailError
       ? 'border-red-300 focus:ring-red-500'
       : 'border-gray-300 focus:ring-emerald-500'
   }`}
   
   // –°–æ–æ–±—â–µ–Ω–∏—è –ø–æ–¥ –ø–æ–ª—è–º–∏
   {emailError && <p className="text-red-600">{emailError}</p>}
   {!emailError && email && <p className="text-green-600">‚úì Email –∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω</p>}
   ```

**–ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:**
- `lib/validation/auth.ts` - –£—Ç–∏–ª–∏—Ç—ã –≤–∞–ª–∏–¥–∞—Ü–∏–∏ email –∏ –ø–∞—Ä–æ–ª—è
- `components/auth/PasswordStrengthIndicator.tsx` - –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä —Å–∏–ª—ã –ø–∞—Ä–æ–ª—è
- `components/auth/AuthForm.tsx` - –û–±—ë—Ä—Ç–∫–∞ —Å –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ–º —Ñ–æ—Ä–º
- `app/auth/page.tsx` - –û–±—ä–µ–¥–∏–Ω—ë–Ω–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏

**–û–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:**
- `components/auth/RegisterForm.tsx` - –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –∏ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞
- `components/auth/LoginForm.tsx` - –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏ email
- `components/layout/UserMenu.tsx` - –†–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ `/auth` –≤–º–µ—Å—Ç–æ `/auth/login`

**–£–¥–∞–ª—ë–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:**
- `app/auth/register/page.tsx` - –ó–∞–º–µ–Ω–µ–Ω–æ –æ–±—ä–µ–¥–∏–Ω—ë–Ω–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ–π
- `app/auth/login/page.tsx` - –ó–∞–º–µ–Ω–µ–Ω–æ –æ–±—ä–µ–¥–∏–Ω—ë–Ω–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ–π

**–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:**
```json
{
  "framer-motion": "^11.x" // –î–ª—è –ø–ª–∞–≤–Ω—ã—Ö –∞–Ω–∏–º–∞—Ü–∏–π –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —Ñ–æ—Ä–º
}
```

**Git –∫–æ–º–º–∏—Ç—ã:**
```
554fc41 - feat(auth): –æ–±—ä–µ–¥–∏–Ω—ë–Ω–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ —Å —É–ª—É—á—à–µ–Ω–Ω–æ–π –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –Ω–æ–≤–æ–≥–æ –ø–æ–¥—Ö–æ–¥–∞:**
1. ‚úÖ **–õ—É—á—à–∏–π UX** - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –ø–æ–∫–∏–¥–∞–µ—Ç —Å—Ç—Ä–∞–Ω–∏—Ü—É –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏
2. ‚úÖ **–ú–µ–Ω—å—à–µ –∫–æ–¥–∞** - –æ–¥–Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –≤–º–µ—Å—Ç–æ –¥–≤—É—Ö
3. ‚úÖ **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å** - —Å—Ç—Ä–æ–≥–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è email –∏ –ø–∞—Ä–æ–ª—è
4. ‚úÖ **–û–±—É—á–µ–Ω–∏–µ** - –ø–æ–¥—Å–∫–∞–∑–∫–∏ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –Ω–∞–¥—ë–∂–Ω–æ–≥–æ –ø–∞—Ä–æ–ª—è
5. ‚úÖ **–í–∏–∑—É–∞–ª—å–Ω–∞—è –æ–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å** - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å—Ä–∞–∑—É –≤–∏–¥–∏—Ç –æ—à–∏–±–∫–∏

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ –∏ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–æ –ª–æ–∫–∞–ª—å–Ω–æ

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∏ —É–ª—É—á—à–µ–Ω–∏—è:**
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω state –¥–ª—è –æ—à–∏–±–∫–∏ –ø–∞—Ä–æ–ª—è (`passwordError`)
- ‚úÖ –û—à–∏–±–∫–∏ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –ø–∞—Ä–æ–ª—è —Ç–µ–ø–µ—Ä—å –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è —è–≤–Ω–æ
- ‚úÖ –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä —Å–∫—Ä—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–π –æ—à–∏–±–∫–∏
- ‚úÖ –ö—Ä–∞—Å–Ω–∞—è —Ä–∞–º–∫–∞ + —Ç–µ–∫—Å—Ç –æ—à–∏–±–∫–∏ –¥–ª—è –ª—É—á—à–µ–π UX

**–ü—Ä–∏–º–µ—Ä –æ—à–∏–±–∫–∏:**
```tsx
{passwordError && (
  <p className="mt-1 text-xs text-red-600 font-medium">
    ‚ö† {passwordError}
  </p>
)}
```

---

### –ò—Ç–µ—Ä–∞—Ü–∏—è 4.1: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è (28.10.2025)

**–ü—Ä–æ–±–ª–µ–º–∞:**
–ü–æ—Å–ª–µ –≤–Ω–µ–¥—Ä–µ–Ω–∏—è —Å–∏—Å—Ç–µ–º—ã –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏, –∞–≤–∞—Ç–∞—Ä –≤ –ø—Ä–æ—Ñ–∏–ª–µ –æ—Ç–æ–±—Ä–∞–∂–∞–ª—Å—è –∫–∞–∫ —á—ë—Ä–Ω—ã–π –∫—Ä—É–≥ –≤–º–µ—Å—Ç–æ –∏–Ω–∏—Ü–∏–∞–ª–æ–≤ —Å –≥—Ä–∞–¥–∏–µ–Ω—Ç–æ–º (–∫–∞–∫ –≤ Header).

**–ü—Ä–∏—á–∏–Ω–∞:**
`ProfileContent` –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª —Ç–æ–ª—å–∫–æ `profile?.first_name`, –Ω–æ –µ—Å–ª–∏ `profile = null` (—á—Ç–æ —Å–ª—É—á–∞–µ—Ç—Å—è –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –≤—Ö–æ–¥–µ –¥–æ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –º–∏–≥—Ä–∞—Ü–∏–π), –¥–∞–Ω–Ω—ã–µ –Ω–µ –æ—Ç–æ–±—Ä–∞–∂–∞–ª–∏—Å—å.

**–†–µ—à–µ–Ω–∏–µ:**
–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `user.user_metadata` –∫–∞–∫ fallback –∏—Å—Ç–æ—á–Ω–∏–∫–∞ –¥–∞–Ω–Ω—ã—Ö (–∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ `UserMenu`):

```typescript
// Fallback –∫ user_metadata
const firstName = profile?.first_name || user.user_metadata?.first_name || '–ò–º—è';
const lastName = profile?.last_name || user.user_metadata?.last_name || '–§–∞–º–∏–ª–∏—è';
const middleName = profile?.middle_name || user.user_metadata?.middle_name || '';
const avatarUrl = profile?.avatar_url || user.user_metadata?.avatar_url;
```

**–ê–≤–∞—Ç–∞—Ä —Å –∏–Ω–∏—Ü–∏–∞–ª–∞–º–∏:**
```tsx
<div className="w-24 h-24 rounded-full bg-gradient-to-br from-emerald-500 to-emerald-600 flex items-center justify-center text-white text-3xl font-bold shadow-lg ring-4 ring-emerald-100">
  {firstName[0]}{lastName[0]}
</div>
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
1. ‚úÖ –ï–¥–∏–Ω—ã–π —Å—Ç–∏–ª—å —Å `UserMenu` (—Ç–æ—Ç –∂–µ –≥—Ä–∞–¥–∏–µ–Ω—Ç –∏ —Ä–∞–∑–º–µ—Ä)
2. ‚úÖ –ò–Ω–∏—Ü–∏–∞–ª—ã –≤—Å–µ–≥–¥–∞ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
3. ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç –¥–∞–∂–µ –±–µ–∑ –¥–∞–Ω–Ω—ã—Ö –≤ –ë–î (fallback –∫ metadata)
4. ‚úÖ –ö—Ä–∞—Å–∏–≤—ã–π hover —ç—Ñ—Ñ–µ–∫—Ç "–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ"

**Git –∫–æ–º–º–∏—Ç—ã:**
```
4add6b0 - fix: –ø–æ–∫–∞–∑ –æ—à–∏–±–∫–∏ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –ø–∞—Ä–æ–ª—è (—Ä—É—Å—Å–∫–∏–µ —Å–∏–º–≤–æ–ª—ã)
dd05805 - fix: –∫—Ä–∞—Å–∏–≤–∞—è –∑–∞–≥–ª—É—à–∫–∞ –∞–≤–∞—Ç–∞—Ä–∞ –≤ –ø—Ä–æ—Ñ–∏–ª–µ (–∏–Ω–∏—Ü–∏–∞–ª—ã + –≥—Ä–∞–¥–∏–µ–Ω—Ç)
b6cb49e - chore: cleanup temp file
0b6c322 - docs: –æ–±–Ω–æ–≤–ª—ë–Ω DIPLOMA.md - –¥–æ–±–∞–≤–ª–µ–Ω—ã –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ò—Ç–µ—Ä–∞—Ü–∏—è 4.1 + –¥–µ–±–∞–≥
49e9c1f - fix: —É–±—Ä–∞–Ω overlay —Å –∞–≤–∞—Ç–∞—Ä–∞ (—á—ë—Ä–Ω—ã–π –∫—Ä—É–≥) - —É–ø—Ä–æ—â—ë–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è
```

**–ö—Ä–∏—Ç–∏—á–µ—Å–∫–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ (49e9c1f):**
–û–±–Ω–∞—Ä—É–∂–µ–Ω–∞ –ø—Ä–∏—á–∏–Ω–∞ —á—ë—Ä–Ω–æ–≥–æ –∫—Ä—É–≥–∞ - overlay —Å `bg-black` –ø–µ—Ä–µ–∫—Ä—ã–≤–∞–ª –∑–µ–ª—ë–Ω—ã–π —Ñ–æ–Ω:

```tsx
// –ë–´–õ–û (—Å overlay - —á—ë—Ä–Ω—ã–π –∫—Ä—É–≥):
<div className="relative group cursor-pointer">
  <div className="w-24 h-24 rounded-full bg-gradient-to-br from-emerald-500 to-emerald-600 flex items-center justify-center text-white text-3xl font-bold shadow-lg ring-4 ring-emerald-100">
    {firstName[0]}{lastName[0]}
  </div>
  <div className="absolute inset-0 rounded-full bg-black bg-opacity-0 group-hover:bg-opacity-20 transition-all duration-300 flex items-center justify-center">
    <span className="text-white opacity-0 group-hover:opacity-100 text-xs font-medium">
      –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ
    </span>
  </div>
</div>

// –°–¢–ê–õ–û (—É–ø—Ä–æ—â—ë–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è - –∑–µ–ª—ë–Ω—ã–π –∫—Ä—É–≥):
<div className="w-24 h-24 rounded-full bg-gradient-to-br from-emerald-500 to-emerald-600 flex items-center justify-center text-white text-3xl font-bold shadow-lg ring-4 ring-emerald-100 hover:ring-emerald-200 transition-all cursor-pointer">
  {firstName[0]}{lastName[0]}
</div>
```

**–ü–æ—á–µ–º—É –±—ã–ª —á—ë—Ä–Ω—ã–π –∫—Ä—É–≥:**
- Overlay —Å `bg-black` –∏ `bg-opacity-0` –ø–µ—Ä–µ–∫—Ä—ã–≤–∞–ª –∑–µ–ª—ë–Ω—ã–π –≥—Ä–∞–¥–∏–µ–Ω—Ç
- –ü—Ä–∏ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–µ –±—Ä–∞—É–∑–µ—Ä –ø–æ–∫–∞–∑—ã–≤–∞–ª —á—ë—Ä–Ω—ã–π —Ñ–æ–Ω –≤–º–µ—Å—Ç–æ –ø—Ä–æ–∑—Ä–∞—á–Ω–æ–≥–æ
- –†–µ—à–µ–Ω–∏–µ: —É–±—Ä–∞—Ç—å overlay, –æ—Å—Ç–∞–≤–∏—Ç—å hover –Ω–∞ –∫–æ–ª—å—Ü–µ

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û - –ø—Ä–æ–≤–µ—Ä–µ–Ω–æ –≤ –ª–æ–≥–∞—Ö (firstName: –î–∞–Ω–∏–ª, lastName: –ê—Ö—É–Ω–æ–≤)

---

## üîß –ò—Ç–µ—Ä–∞—Ü–∏—è 5: –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏ (29.10.2025)

### –¶–µ–ª—å –∏—Ç–µ—Ä–∞—Ü–∏–∏
–°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω–æ–π –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω–æ–π –ø–∞–Ω–µ–ª–∏ —Å —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ–º —Ä–æ–ª–µ–π, —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ–º —Ç—É—Ä–∞–º–∏, –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è–º–∏, –æ—Ç–∑—ã–≤–∞–º–∏ –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏.

### –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

#### 1. –ú–∏–≥—Ä–∞—Ü–∏—è –ë–î - —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã tours
**–§–∞–π–ª:** `supabase/migrations/004_tours_and_reviews.sql`

**–ù–æ–≤—ã–µ —Ç–∏–ø—ã –¥–∞–Ω–Ω—ã—Ö:**
```sql
-- –¢–∏–ø—ã —Ç—É—Ä–æ–≤
CREATE TYPE tour_type_enum AS ENUM (
  'excursion',    -- –≠–∫—Å–∫—É—Ä—Å–∏—è
  'quest',        -- –ö–≤–µ—Å—Ç
  'event'         -- –ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ
);

-- –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ —Ç—É—Ä–æ–≤
CREATE TYPE tour_category_enum AS ENUM (
  'nature',       -- –ü—Ä–∏—Ä–æ–¥–∞
  'culture',      -- –ö—É–ª—å—Ç—É—Ä–∞
  'architecture', -- –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞
  'food',         -- –ì–∞—Å—Ç—Ä–æ–Ω–æ–º–∏—è
  'adventure'     -- –ü—Ä–∏–∫–ª—é—á–µ–Ω–∏—è
);

-- –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–æ–≤ —Ç—É—Ä–æ–≤
ALTER TYPE tour_status ADD VALUE IF NOT EXISTS 'active';
ALTER TYPE tour_status ADD VALUE IF NOT EXISTS 'completed';
ALTER TYPE tour_status ADD VALUE IF NOT EXISTS 'cancelled';
```

**–î–æ–±–∞–≤–ª–µ–Ω–Ω—ã–µ –∫–æ–ª–æ–Ω–∫–∏ –≤ tours:**
```sql
ALTER TABLE tours
  ADD COLUMN tour_type tour_type_enum DEFAULT 'excursion',
  ADD COLUMN category tour_category_enum DEFAULT 'culture';

-- –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤—ã–≤–∞–µ–º current_bookings -> current_participants
ALTER TABLE tours 
  RENAME COLUMN current_bookings TO current_participants;
```

#### 2. –¢–∞–±–ª–∏—Ü–∞ reviews (–û—Ç–∑—ã–≤—ã —Å –≤–∏–¥–µ–æ)
```sql
CREATE TABLE reviews (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES profiles(id) ON DELETE CASCADE,
  tour_id UUID NOT NULL REFERENCES tours(id) ON DELETE CASCADE,
  booking_id UUID NOT NULL REFERENCES bookings(id) ON DELETE CASCADE,
  rating INTEGER NOT NULL CHECK (rating >= 1 AND rating <= 5),
  text TEXT,
  video_url TEXT,
  video_path TEXT,
  is_approved BOOLEAN DEFAULT FALSE,
  is_published BOOLEAN DEFAULT FALSE,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  
  -- –û–¥–∏–Ω –æ—Ç–∑—ã–≤ –Ω–∞ –æ–¥–Ω–æ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
  CONSTRAINT unique_review_per_booking UNIQUE (booking_id)
);
```

**–ö–ª—é—á–µ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:**
- `can_user_review_tour(user_id, tour_id)` - –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –Ω–∞ –æ—Ç–∑—ã–≤
- `get_tour_average_rating(tour_id)` - —Å—Ä–µ–¥–Ω–∏–π —Ä–µ–π—Ç–∏–Ω–≥ —Ç—É—Ä–∞
- `is_tour_available(tour_id)` - –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —Ç—É—Ä–∞ (–ø—Ä–æ–≤–µ—Ä–∫–∞ –≤—Ä–µ–º–µ–Ω–∏)

**–¢—Ä–∏–≥–≥–µ—Ä—ã:**
- `update_tour_participants()` - –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—á—ë—Ç—á–∏–∫–∞ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –ø—Ä–∏ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–∏
- `update_reviews_updated_at()` - –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ `updated_at` –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –æ—Ç–∑—ã–≤–∞

#### 3. –ú–∏–≥—Ä–∞—Ü–∏—è - –ø—Ä–∞–≤–∞ –¥–ª—è super_admin
**–§–∞–π–ª:** `supabase/migrations/005_admin_policies.sql`

```sql
-- –°—É–ø–µ—Ä-–∞–¥–º–∏–Ω –º–æ–∂–µ—Ç —É–ø—Ä–∞–≤–ª—è—Ç—å –≤—Å–µ–º–∏ –ø—Ä–æ—Ñ–∏–ª—è–º–∏
CREATE POLICY "Super admin can manage all profiles"
  ON profiles FOR ALL
  USING (
    EXISTS (
      SELECT 1 FROM profiles
      WHERE id = auth.uid()
      AND role = 'super_admin'
    )
  );

-- service_role –æ–±—Ö–æ–¥–∏—Ç RLS –¥–ª—è —Å–µ—Ä–≤–µ—Ä–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
CREATE POLICY "service_role can manage profiles"
  ON profiles FOR ALL
  TO service_role
  USING (true) WITH CHECK (true);
```

**–ó–∞—á–µ–º —ç—Ç–æ –Ω—É–∂–Ω–æ:**
- –°—É–ø–µ—Ä-–∞–¥–º–∏–Ω –º–æ–∂–µ—Ç –∏–∑–º–µ–Ω—è—Ç—å —Ä–æ–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- `service_role` –æ–±—Ö–æ–¥–∏—Ç RLS –¥–ª—è —Å–µ—Ä–≤–µ—Ä–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π (–∑–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ S3, —Ç—Ä–∏–≥–≥–µ—Ä—ã)

#### 4. –ú–∏–≥—Ä–∞—Ü–∏—è - –Ø–Ω–¥–µ–∫—Å.–ö–∞—Ä—Ç—ã
**–§–∞–π–ª:** `supabase/migrations/006_add_yandex_map.sql`

```sql
ALTER TABLE tours
ADD COLUMN IF NOT EXISTS yandex_map_url TEXT;

COMMENT ON COLUMN tours.yandex_map_url IS 'URL for Yandex Map Constructor embed';
```

**–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è:**
–ê–¥–º–∏–Ω –≤—Å—Ç–∞–≤–ª—è–µ—Ç —Å—Å—ã–ª–∫—É –∏–∑ [–Ø–Ω–¥–µ–∫—Å.–ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä–∞ –∫–∞—Ä—Ç](https://yandex.ru/map-constructor/), —Å–∏—Å—Ç–µ–º–∞ –≤—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç iframe.

---

### –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å

#### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –º–∞—Ä—à—Ä—É—Ç–æ–≤
```
/admin/
‚îú‚îÄ‚îÄ page.tsx              # Dashboard (—Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞)
‚îú‚îÄ‚îÄ layout.tsx            # Layout –±–µ–∑ Header
‚îú‚îÄ‚îÄ tours/
‚îÇ   ‚îú‚îÄ‚îÄ page.tsx         # –°–ø–∏—Å–æ–∫ —Ç—É—Ä–æ–≤
‚îÇ   ‚îú‚îÄ‚îÄ create/page.tsx  # –°–æ–∑–¥–∞–Ω–∏–µ —Ç—É—Ä–∞
‚îÇ   ‚îî‚îÄ‚îÄ edit/[id]/       # –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç—É—Ä–∞
‚îú‚îÄ‚îÄ bookings/page.tsx     # –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è–º–∏
‚îú‚îÄ‚îÄ reviews/page.tsx      # –ú–æ–¥–µ—Ä–∞—Ü–∏—è –æ—Ç–∑—ã–≤–æ–≤
‚îú‚îÄ‚îÄ chat/page.tsx         # –ß–∞—Ç –ø–æ–¥–¥–µ—Ä–∂–∫–∏
‚îî‚îÄ‚îÄ users/page.tsx        # –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ (super_admin)
```

#### –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –∞–¥–º–∏–Ω–∫–∏

**1. AdminSidebar** (`components/admin/AdminSidebar.tsx`)
- –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –º–µ–Ω—é –ø–æ —Ä–æ–ª—è–º
- –ê–∫—Ç–∏–≤–Ω–∞—è –Ω–∞–≤–∏–≥–∞—Ü–∏—è
- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ —Å –∞–≤–∞—Ç–∞—Ä–æ–º
- –ö–Ω–æ–ø–∫–∞ –≤—ã—Ö–æ–¥–∞
- **–ù–û–í–ò–ù–ö–ê:** –°–∫–ª–∞–¥—ã–≤–∞—é—â–∏–π—Å—è –¥–∏–∑–∞–π–Ω (—Å–º. –ò—Ç–µ—Ä–∞—Ü–∏—è 9)

**2. DashboardStats** (`components/admin/DashboardStats.tsx`)
–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏:
```typescript
const stats = {
  totalUsers: 150,
  totalTours: 24,
  activeBookings: 87,
  totalRevenue: '2,450,000 ‚ÇΩ',
  avgRating: 4.8,
  pendingReviews: 12
};
```

**3. UserList** (`components/admin/UserList.tsx`)
- –¢–∞–±–ª–∏—Ü–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π
- –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Ä–æ–ª–µ–π (—Ç–æ–ª—å–∫–æ –¥–ª—è super_admin)
- –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ —Ä–æ–ª—è–º

**API –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–æ–ª–µ–π:**
```typescript
// app/api/admin/users/role/route.ts
PUT /api/admin/users/role
Body: { userId: string, role: string }
```

**4. TourAdminList** (`components/admin/TourAdminList.tsx`)
- –°–ø–∏—Å–æ–∫ —Ç—É—Ä–æ–≤ —Å —Ñ–∏–ª—å—Ç—Ä–∞–º–∏
- –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ / –£–¥–∞–ª–µ–Ω–∏–µ
- –°—Ç–∞—Ç—É—Å —Ç—É—Ä–æ–≤ (draft, active, completed, cancelled)

#### Middleware –∑–∞—â–∏—Ç—ã
**–§–∞–π–ª:** `middleware/admin.ts`

```typescript
const ADMIN_ROLES = ['super_admin', 'tour_admin', 'support_admin'];

export async function adminMiddleware(request: NextRequest) {
  const supabase = await createClient();
  const { data: { user } } = await supabase.auth.getUser();
  
  if (!user) {
    return NextResponse.redirect(new URL('/auth', request.url));
  }
  
  const { data: profile } = await supabase
    .from('profiles')
    .select('role')
    .eq('id', user.id)
    .single();
  
  if (!ADMIN_ROLES.includes(profile?.role)) {
    return NextResponse.redirect(new URL('/', request.url));
  }
}
```

#### Layout –±–µ–∑ Header
**–§–∞–π–ª:** `app/admin/layout.tsx`

–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–π layout –±–µ–∑ –≥–ª–æ–±–∞–ª—å–Ω–æ–π —à–∞–ø–∫–∏:
```tsx
<div className="flex min-h-screen bg-gray-50">
  <AdminSidebar userRole={userRole} userName={userName} />
  <main className="flex-1 p-8">
    {children}
  </main>
</div>
```

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:** `ConditionalLayout` –≤ `app/layout.tsx` —Å–∫—Ä—ã–≤–∞–µ—Ç Header/Footer –¥–ª—è `/admin/*` –º–∞—Ä—à—Ä—É—Ç–æ–≤.

---

### Git –∫–æ–º–º–∏—Ç—ã –∏—Ç–µ—Ä–∞—Ü–∏–∏ 5
```
d234a89 - feat: –º–∏–≥—Ä–∞—Ü–∏—è 004 - tour_type, category, reviews
f891bcd - feat: –º–∏–≥—Ä–∞—Ü–∏—è 005 - super_admin policies
a43c210 - feat: –∞–¥–º–∏–Ω dashboard —Å–æ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–æ–π
b78f334 - feat: —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ (super_admin)
e92da65 - feat: —Å–ø–∏—Å–æ–∫ —Ç—É—Ä–æ–≤ –≤ –∞–¥–º–∏–Ω–∫–µ
c145678 - feat: —É–±—Ä–∞–Ω–∞ —à–∞–ø–∫–∞ –∏–∑ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏ (ConditionalLayout)
```

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ –∏ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–æ

---

## üé® –ò—Ç–µ—Ä–∞—Ü–∏—è 6: –†–µ–¥–∞–∫—Ç–æ—Ä —Ç—É—Ä–æ–≤ —Å Rich Text –∏ S3 (29.10.2025)

### –¶–µ–ª—å –∏—Ç–µ—Ä–∞—Ü–∏–∏
–°–æ–∑–¥–∞–Ω–∏–µ –º–æ—â–Ω–æ–π —Ñ–æ—Ä–º—ã –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ç—É—Ä–æ–≤ —Å Rich Text —Ä–µ–¥–∞–∫—Ç–æ—Ä–æ–º, –∑–∞–≥—Ä—É–∑–∫–æ–π –º–µ–¥–∏–∞ –Ω–∞ S3 –∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–µ–π –Ø–Ω–¥–µ–∫—Å.–ö–∞—Ä—Ç.

### –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

#### 1. Rich Text Editor (TipTap)
**–§–∞–π–ª:** `components/admin/RichTextEditor.tsx`

**–£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:**
```bash
npm install @tiptap/react @tiptap/starter-kit @tiptap/extension-image @tiptap/extension-link
```

**–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞:**
- ‚úÖ –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ (–∂–∏—Ä–Ω—ã–π, –∫—É—Ä—Å–∏–≤, –ø–æ–¥—á—ë—Ä–∫–Ω—É—Ç—ã–π)
- ‚úÖ –ó–∞–≥–æ–ª–æ–≤–∫–∏ (H1, H2, H3)
- ‚úÖ –°–ø–∏—Å–∫–∏ (–Ω—É–º–µ—Ä–æ–≤–∞–Ω–Ω—ã–µ, –º–∞—Ä–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ)
- ‚úÖ –¶–∏—Ç–∞—Ç—ã
- ‚úÖ –í—Å—Ç–∞–≤–∫–∞ —Å—Å—ã–ª–æ–∫
- ‚úÖ –í—Å—Ç–∞–≤–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π (URL)
- ‚úÖ –û—Ç–º–µ–Ω–∞/–ø–æ–≤—Ç–æ—Ä –¥–µ–π—Å—Ç–≤–∏–π

**–í–∞–∂–Ω–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ (SSR):**
```typescript
const editor = useEditor({
  extensions: [/* ... */],
  content: content,
  immediatelyRender: false, // ‚ùó –ò—Å–ø—Ä–∞–≤–ª—è–µ—Ç hydration mismatch
});
```

**–ü–∞–Ω–µ–ª—å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤:**
```tsx
<div className="border-b p-2 flex flex-wrap gap-1 bg-gray-50">
  <button onClick={() => editor.chain().focus().toggleBold().run()}>
    <Bold className="w-4 h-4" />
  </button>
  <button onClick={() => editor.chain().focus().toggleItalic().run()}>
    <Italic className="w-4 h-4" />
  </button>
  {/* ... –æ—Å—Ç–∞–ª—å–Ω—ã–µ –∫–Ω–æ–ø–∫–∏ */}
</div>
```

#### 2. S3 Cloud Storage (Timeweb)
**–§–∞–π–ª:** `lib/s3/client.ts`

**–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è AWS SDK v3:**
```typescript
import { S3Client } from '@aws-sdk/client-s3';

export const s3Client = new S3Client({
  region: process.env.TIMEWEB_S3_REGION!,
  endpoint: process.env.TIMEWEB_S3_ENDPOINT!,
  credentials: {
    accessKeyId: process.env.TIMEWEB_S3_ACCESS_KEY!,
    secretAccessKey: process.env.TIMEWEB_S3_SECRET_KEY!,
  },
});

export const S3_BUCKET = process.env.TIMEWEB_S3_BUCKET!;
```

**–ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è (.env.local):**
```bash
TIMEWEB_S3_REGION=ru-1
TIMEWEB_S3_ENDPOINT=https://s3.timeweb.com
TIMEWEB_S3_BUCKET=tatarstan-tours
TIMEWEB_S3_ACCESS_KEY=xxx
TIMEWEB_S3_SECRET_KEY=xxx
TIMEWEB_S3_CDN_URL=https://cdn.tatarstan-tours.ru
```

#### 3. –£—Ç–∏–ª–∏—Ç—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å S3
**–§–∞–π–ª:** `lib/s3/upload.ts`

**–û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:**

1. **uploadFileToS3(file, path)** - –∑–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞
```typescript
import { PutObjectCommand } from '@aws-sdk/client-s3';

export async function uploadFileToS3(file: File, path: string): Promise<string> {
  const buffer = Buffer.from(await file.arrayBuffer());
  
  await s3Client.send(
    new PutObjectCommand({
      Bucket: S3_BUCKET,
      Key: path,
      Body: buffer,
      ContentType: file.type,
      ACL: 'public-read',
    })
  );
  
  return `${CDN_URL}/${path}`;
}
```

2. **deleteFileFromS3(path)** - —É–¥–∞–ª–µ–Ω–∏–µ —Ñ–∞–π–ª–∞
```typescript
import { DeleteObjectCommand } from '@aws-sdk/client-s3';

export async function deleteFileFromS3(path: string): Promise<void> {
  await s3Client.send(
    new DeleteObjectCommand({
      Bucket: S3_BUCKET,
      Key: path,
    })
  );
}
```

3. **replaceFileInS3(oldPath, newFile, newPath)** - –∑–∞–º–µ–Ω–∞ —Ñ–∞–π–ª–∞
4. **generatePresignedUrl(path, expiresIn)** - –≤—Ä–µ–º–µ–Ω–Ω–∞—è —Å—Å—ã–ª–∫–∞ –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è
5. **generateUniqueFileName(originalName)** - —É–Ω–∏–∫–∞–ª—å–Ω–æ–µ –∏–º—è —Ñ–∞–π–ª–∞
6. **getS3Path(type, fileName)** - —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø—É—Ç—å

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—É—Ç–µ–π S3:**
```
tours/
‚îú‚îÄ‚îÄ covers/          # –û–±–ª–æ–∂–∫–∏ —Ç—É—Ä–æ–≤
‚îÇ   ‚îî‚îÄ‚îÄ tour-slug-1234567890.jpg
‚îú‚îÄ‚îÄ gallery/         # –§–æ—Ç–æ –≥–∞–ª–µ—Ä–µ—è
‚îÇ   ‚îú‚îÄ‚îÄ tour-slug-1234567890-1.jpg
‚îÇ   ‚îî‚îÄ‚îÄ tour-slug-1234567890-2.jpg
‚îî‚îÄ‚îÄ videos/          # –í–∏–¥–µ–æ –æ–ø–∏—Å–∞–Ω–∏—è
    ‚îî‚îÄ‚îÄ tour-slug-1234567890.mp4

avatars/             # –ê–≤–∞—Ç–∞—Ä—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
‚îú‚îÄ‚îÄ user-id-1234567890.jpg

bookings/            # –ë–∏–ª–µ—Ç—ã PDF
‚îî‚îÄ‚îÄ ticket-booking-id.pdf
```

#### 4. –§–æ—Ä–º–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ç—É—Ä–∞
**–§–∞–π–ª:** `components/admin/TourForm.tsx`

**–ü–æ–ª—è —Ñ–æ—Ä–º—ã:**
- **–ù–∞–∑–≤–∞–Ω–∏–µ —Ç—É—Ä–∞** - —Ç–µ–∫—Å—Ç (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)
- **Slug** - URL-–∞–¥—Ä–µ—Å (–∞–≤—Ç–æ–≥–µ–Ω–µ—Ä–∞—Ü–∏—è —Å —Ç—Ä–∞–Ω—Å–ª–∏—Ç–µ—Ä–∞—Ü–∏–µ–π)
- **–¢–∏–ø —Ç—É—Ä–∞** - select (excursion/quest/event)
- **–ö–∞—Ç–µ–≥–æ—Ä–∏—è** - select (nature/culture/architecture/food/adventure)
- **–¶–µ–Ω–∞** - —á–∏—Å–ª–æ
- **–î–∞—Ç—ã** - start_date, end_date (datetime-local)
- **–£—á–∞—Å—Ç–Ω–∏–∫–∏** - min_participants, max_participants
- **–û–±–ª–æ–∂–∫–∞ —Ç—É—Ä–∞** - –∑–∞–≥—Ä—É–∑–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –Ω–∞ S3
- **–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ** - textarea
- **–ü–æ–ª–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ** - Rich Text Editor (TipTap)
- **–Ø–Ω–¥–µ–∫—Å –∫–∞—Ä—Ç–∞** - URL –∏–∑ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä–∞ –∫–∞—Ä—Ç
- **–§–æ—Ç–æ –≥–∞–ª–µ—Ä–µ—è** - –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ —Ñ–æ—Ç–æ (—Å–º. –ò—Ç–µ—Ä–∞—Ü–∏—è 8)
- **–í–∏–¥–µ–æ** - –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –≤–∏–¥–µ–æ (—Å–º. –ò—Ç–µ—Ä–∞—Ü–∏—è 8)

**–¢—Ä–∞–Ω—Å–ª–∏—Ç–µ—Ä–∞—Ü–∏—è –¥–ª—è slug:**
```typescript
function transliterate(text: string): string {
  const map: { [key: string]: string } = {
    '–∞': 'a', '–±': 'b', '–≤': 'v', '–≥': 'g', '–¥': 'd',
    '–µ': 'e', '—ë': 'yo', '–∂': 'zh', '–∑': 'z', '–∏': 'i',
    '–π': 'y', '–∫': 'k', '–ª': 'l', '–º': 'm', '–Ω': 'n',
    '–æ': 'o', '–ø': 'p', '—Ä': 'r', '—Å': 's', '—Ç': 't',
    '—É': 'u', '—Ñ': 'f', '—Ö': 'h', '—Ü': 'ts', '—á': 'ch',
    '—à': 'sh', '—â': 'sch', '—ä': '', '—ã': 'y', '—å': '',
    '—ç': 'e', '—é': 'yu', '—è': 'ya',
    // ... –∑–∞–≥–ª–∞–≤–Ω—ã–µ –±—É–∫–≤—ã
  };
  
  return text
    .split('')
    .map(char => map[char.toLowerCase()] || char)
    .join('')
    .toLowerCase()
    .replace(/[^a-z0-9]+/g, '-')
    .replace(/-+/g, '-')
    .trim();
}
```

**–ê–≤—Ç–æ–≥–µ–Ω–µ—Ä–∞—Ü–∏—è slug:**
```typescript
const handleTitleChange = (title: string) => {
  setFormData(prev => ({
    ...prev,
    title,
    slug: transliterate(title)
      .replace(/[^a-z0-9]+/g, '-')
      .replace(/-+/g, '-')
      .trim(),
  }));
};
```

**–ó–∞–≥—Ä—É–∑–∫–∞ –æ–±–ª–æ–∂–∫–∏ –Ω–∞ S3:**
```typescript
const handleSubmit = async (e: React.FormEvent) => {
  e.preventDefault();
  
  // –ó–∞–≥—Ä—É–∂–∞–µ–º –æ–±–ª–æ–∂–∫—É
  let coverImageUrl = formData.cover_image;
  if (coverImageFile) {
    const formData = new FormData();
    formData.append('file', coverImageFile);
    formData.append('type', 'tour-cover');
    
    const response = await fetch('/api/upload', {
      method: 'POST',
      body: formData,
    });
    
    const { url } = await response.json();
    coverImageUrl = url;
  }
  
  // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç—É—Ä
  await fetch('/api/admin/tours', {
    method: 'POST',
    body: JSON.stringify({ ...formData, cover_image: coverImageUrl }),
  });
};
```

#### 5. API –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–æ–≤
**–§–∞–π–ª:** `app/api/upload/route.ts`

```typescript
export async function POST(request: NextRequest) {
  // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
  const supabase = await createClient();
  const { data: { user } } = await supabase.auth.getUser();
  
  if (!user) {
    return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });
  }
  
  // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–æ–ª–∏ (—Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω—ã)
  const { data: profile } = await supabase
    .from('profiles')
    .select('role')
    .eq('id', user.id)
    .single();
  
  if (!['super_admin', 'tour_admin'].includes(profile?.role)) {
    return NextResponse.json({ error: 'Forbidden' }, { status: 403 });
  }
  
  // –ü–æ–ª—É—á–∞–µ–º —Ñ–∞–π–ª
  const formData = await request.formData();
  const file = formData.get('file') as File;
  const folder = formData.get('folder') as string;
  const tourId = formData.get('tourId') as string | null;
  const mediaType = formData.get('mediaType') as 'photo' | 'video' | null;
  
  // –í–∞–ª–∏–¥–∞—Ü–∏—è
  if (!file) {
    return NextResponse.json({ error: 'No file' }, { status: 400 });
  }
  
  const maxSize = file.type.startsWith('video/') ? 100 * 1024 * 1024 : 10 * 1024 * 1024;
  if (file.size > maxSize) {
    return NextResponse.json({ error: 'File too large' }, { status: 400 });
  }
  
  // –ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–∞ S3
  const uniqueName = generateUniqueFileName(file.name);
  const s3Path = `${folder}/${uniqueName}`;
  const fileUrl = await uploadFileToS3(file, s3Path);
  
  // –ï—Å–ª–∏ —É–∫–∞–∑–∞–Ω tourId - —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤ tour_media
  if (tourId && mediaType) {
    await serviceClient.from('tour_media').insert({
      tour_id: tourId,
      media_type: mediaType,
      media_url: fileUrl,
      media_path: s3Path,
      file_name: file.name,
      file_size: file.size,
      mime_type: file.type,
    });
  }
  
  return NextResponse.json({ success: true, url: fileUrl, path: s3Path });
}
```

**–õ–∏–º–∏—Ç—ã:**
- –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è: 10 MB
- –í–∏–¥–µ–æ: 100 MB

**–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã:**
- –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è: JPEG, PNG, WebP
- –í–∏–¥–µ–æ: MP4, WebM, AVI, QuickTime

---

### Git –∫–æ–º–º–∏—Ç—ã –∏—Ç–µ—Ä–∞—Ü–∏–∏ 6
```
a89f234 - feat: TipTap Rich Text Editor –¥–ª—è –æ–ø–∏—Å–∞–Ω–∏–π —Ç—É—Ä–æ–≤
c456def - feat: S3 client –¥–ª—è Timeweb Cloud Storage
e789abc - feat: —É—Ç–∏–ª–∏—Ç—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å S3 (upload, delete, replace)
f012bcd - feat: —Ñ–æ—Ä–º–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ç—É—Ä–∞ —Å S3 –∑–∞–≥—Ä—É–∑–∫–æ–π
g345cde - fix: SSR hydration mismatch –≤ TipTap (immediatelyRender: false)
h678efg - feat: —Ç—Ä–∞–Ω—Å–ª–∏—Ç–µ—Ä–∞—Ü–∏—è —Ä—É—Å—Å–∫–∏—Ö —Å–∏–º–≤–æ–ª–æ–≤ –≤ slug
i901fgh - feat: –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –Ø–Ω–¥–µ–∫—Å.–ö–∞—Ä—Ç (URL –∏–∑ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä–∞)
bbf1f44 - feat: –¥–æ–±–∞–≤–ª–µ–Ω–∞ –º–∏–≥—Ä–∞—Ü–∏—è –¥–ª—è yandex_map_url
```

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ –∏ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–æ

---

## üì∏ –ò—Ç–µ—Ä–∞—Ü–∏—è 7: –§–æ—Ç–æ –≥–∞–ª–µ—Ä–µ—è –∏ –≤–∏–¥–µ–æ –¥–ª—è —Ç—É—Ä–æ–≤ (29.10.2025)

### –¶–µ–ª—å –∏—Ç–µ—Ä–∞—Ü–∏–∏
–†–∞—Å—à–∏—Ä–µ–Ω–∏–µ —Ñ–æ—Ä–º—ã —Å–æ–∑–¥–∞–Ω–∏—è —Ç—É—Ä–∞ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö —Ñ–æ—Ç–æ (–≥–∞–ª–µ—Ä–µ—è) –∏ –≤–∏–¥–µ–æ (–æ–ø–∏—Å–∞–Ω–∏–µ —Ç—É—Ä–∞).

### –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

#### –û–±–Ω–æ–≤–ª—ë–Ω–Ω–∞—è —Ñ–æ—Ä–º–∞ —Ç—É—Ä–∞
**–§–∞–π–ª:** `components/admin/TourForm.tsx`

**–ù–æ–≤—ã–µ –ø–æ–ª—è —Å–æ—Å—Ç–æ—è–Ω–∏—è:**
```typescript
const [galleryFiles, setGalleryFiles] = useState<File[]>([]);
const [galleryPreviews, setGalleryPreviews] = useState<string[]>([]);
const [videoFiles, setVideoFiles] = useState<File[]>([]);
const [videoPreviews, setVideoPreviews] = useState<string[]>([]);
```

**–û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∑–∞–≥—Ä—É–∑–∫–∏:**

1. **–§–æ—Ç–æ –≥–∞–ª–µ—Ä–µ—è (–º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞):**
```typescript
const handleGalleryChange = (e: React.ChangeEvent<HTMLInputElement>) => {
  const files = Array.from(e.target.files || []);
  if (files.length > 0) {
    setGalleryFiles(prev => [...prev, ...files]);
    const previews = files.map(file => URL.createObjectURL(file));
    setGalleryPreviews(prev => [...prev, ...previews]);
  }
};
```

2. **–í–∏–¥–µ–æ (–º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞):**
```typescript
const handleVideoChange = (e: React.ChangeEvent<HTMLInputElement>) => {
  const files = Array.from(e.target.files || []);
  if (files.length > 0) {
    setVideoFiles(prev => [...prev, ...files]);
    const previews = files.map(file => URL.createObjectURL(file));
    setVideoPreviews(prev => [...prev, ...previews]);
  }
};
```

3. **–£–¥–∞–ª–µ–Ω–∏–µ –∏–∑ –ø—Ä–µ–≤—å—é:**
```typescript
const removeGalleryPhoto = (index: number) => {
  setGalleryFiles(prev => prev.filter((_, i) => i !== index));
  setGalleryPreviews(prev => prev.filter((_, i) => i !== index));
};

const removeVideo = (index: number) => {
  setVideoFiles(prev => prev.filter((_, i) => i !== index));
  setVideoPreviews(prev => prev.filter((_, i) => i !== index));
};
```

**UI –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:**

1. **–§–æ—Ç–æ –≥–∞–ª–µ—Ä–µ—è (—Å–µ—Ç–∫–∞ 2x4):**
```tsx
<div>
  <label>–§–æ—Ç–æ –≥–∞–ª–µ—Ä–µ—è</label>
  
  {/* –ü—Ä–µ–≤—å—é */}
  {galleryPreviews.length > 0 && (
    <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
      {galleryPreviews.map((preview, index) => (
        <div key={index} className="relative group">
          <Image
            src={preview}
            alt={`Gallery ${index + 1}`}
            width={200}
            height={200}
            className="w-full h-32 object-cover rounded-lg"
          />
          <button
            type="button"
            onClick={() => removeGalleryPhoto(index)}
            className="absolute top-2 right-2 bg-red-600 text-white p-1 rounded-full 
                       opacity-0 group-hover:opacity-100 transition-opacity"
          >
            <X className="w-4 h-4" />
          </button>
        </div>
      ))}
    </div>
  )}
  
  {/* –ó–∞–≥—Ä—É–∑–∫–∞ */}
  <label className="flex items-center justify-center gap-2 w-full px-4 py-3 
                    border-2 border-dashed border-gray-300 rounded-lg 
                    cursor-pointer hover:border-emerald-500 transition-colors">
    <Upload className="w-5 h-5 text-gray-400" />
    <span>–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ (–º–æ–∂–Ω–æ –Ω–µ—Å–∫–æ–ª—å–∫–æ)</span>
    <input
      type="file"
      accept="image/*"
      multiple
      onChange={handleGalleryChange}
      className="hidden"
    />
  </label>
</div>
```

2. **–í–∏–¥–µ–æ (—Å–ø–∏—Å–æ–∫):**
```tsx
<div>
  <label>–í–∏–¥–µ–æ –æ–ø–∏—Å–∞–Ω–∏–µ</label>
  
  {/* –ü—Ä–µ–≤—å—é */}
  {videoPreviews.length > 0 && (
    <div className="space-y-2">
      {videoPreviews.map((preview, index) => (
        <div key={index} className="flex items-center gap-4 p-4 bg-gray-50 rounded-lg">
          <video
            src={preview}
            className="w-32 h-20 object-cover rounded"
            controls
          />
          <span className="flex-1 text-sm text-gray-600">
            {videoFiles[index]?.name}
          </span>
          <button
            type="button"
            onClick={() => removeVideo(index)}
            className="bg-red-600 text-white p-2 rounded-full"
          >
            <X className="w-4 h-4" />
          </button>
        </div>
      ))}
    </div>
  )}
  
  {/* –ó–∞–≥—Ä—É–∑–∫–∞ */}
  <label className="flex items-center justify-center gap-2 w-full px-4 py-3 
                    border-2 border-dashed border-gray-300 rounded-lg 
                    cursor-pointer hover:border-emerald-500 transition-colors">
    <Upload className="w-5 h-5 text-gray-400" />
    <span>–ó–∞–≥—Ä—É–∑–∏—Ç—å –≤–∏–¥–µ–æ (–º–æ–∂–Ω–æ –Ω–µ—Å–∫–æ–ª—å–∫–æ)</span>
    <input
      type="file"
      accept="video/*"
      multiple
      onChange={handleVideoChange}
      className="hidden"
    />
  </label>
</div>
```

**–û—Ç–ø—Ä–∞–≤–∫–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä:**
```typescript
const handleSubmit = async (e: React.FormEvent) => {
  e.preventDefault();
  
  // 1. –°–æ–∑–¥–∞—ë–º —Ç—É—Ä
  const response = await fetch('/api/admin/tours', {
    method: 'POST',
    body: JSON.stringify(formData),
  });
  
  const result = await response.json();
  const tourId = result.data.id;
  
  // 2. –ó–∞–≥—Ä—É–∂–∞–µ–º —Ñ–æ—Ç–æ –≥–∞–ª–µ—Ä–µ–∏
  if (galleryFiles.length > 0) {
    for (const file of galleryFiles) {
      const formData = new FormData();
      formData.append('file', file);
      formData.append('folder', 'tours/gallery');
      formData.append('tourId', tourId);
      formData.append('mediaType', 'photo');
      
      await fetch('/api/upload', { method: 'POST', body: formData });
    }
  }
  
  // 3. –ó–∞–≥—Ä—É–∂–∞–µ–º –≤–∏–¥–µ–æ
  if (videoFiles.length > 0) {
    for (const file of videoFiles) {
      const formData = new FormData();
      formData.append('file', file);
      formData.append('folder', 'tours/videos');
      formData.append('tourId', tourId);
      formData.append('mediaType', 'video');
      
      await fetch('/api/upload', { method: 'POST', body: formData });
    }
  }
  
  router.push('/admin/tours');
};
```

**API –æ–±—Ä–∞–±–æ—Ç–∫–∞ (–æ–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–π):**
**–§–∞–π–ª:** `app/api/upload/route.ts`

–û–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–π API —Ç–µ–ø–µ—Ä—å –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç:
- `tourId` - ID —Ç—É—Ä–∞ –¥–ª—è –ø—Ä–∏–≤—è–∑–∫–∏ –º–µ–¥–∏–∞
- `mediaType` - —Ç–∏–ø –º–µ–¥–∏–∞ (photo / video)
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ `tour_media` –ø—Ä–∏ —É–∫–∞–∑–∞–Ω–∏–∏ `tourId`

```typescript
// –ï—Å–ª–∏ —É–∫–∞–∑–∞–Ω tourId –∏ mediaType - —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤ tour_media
if (tourId && mediaType) {
  await serviceClient.from('tour_media').insert({
    tour_id: tourId,
    media_type: mediaType,
    media_url: fileUrl,
    media_path: s3Path,
    file_name: file.name,
    file_size: file.size,
    mime_type: file.type,
  });
}
```

**–ò—Ç–æ–≥–æ–≤—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –∞–¥–º–∏–Ω–∞:**
1. ‚úÖ –ó–∞–≥—Ä—É–∑–∏—Ç—å –æ–±–ª–æ–∂–∫—É —Ç—É—Ä–∞ (1 —Ñ–æ—Ç–æ)
2. ‚úÖ –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ –≥–∞–ª–µ—Ä–µ—é (–º–Ω–æ–∂–µ—Å—Ç–≤–æ —Ñ–æ—Ç–æ)
3. ‚úÖ –ó–∞–≥—Ä—É–∑–∏—Ç—å –≤–∏–¥–µ–æ –æ–ø–∏—Å–∞–Ω–∏–µ (–º–Ω–æ–∂–µ—Å—Ç–≤–æ –≤–∏–¥–µ–æ)
4. ‚úÖ –í—Å—Ç–∞–≤–∏—Ç—å –Ø–Ω–¥–µ–∫—Å.–ö–∞—Ä—Ç—É (URL)
5. ‚úÖ –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ (Rich Text)

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞ S3 –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏:**
```
tours/
‚îú‚îÄ‚îÄ covers/
‚îÇ   ‚îî‚îÄ‚îÄ tatarstan-kazanskij-kreml-1730211234567.jpg
‚îú‚îÄ‚îÄ gallery/
‚îÇ   ‚îú‚îÄ‚îÄ tatarstan-kazanskij-kreml-1730211234568.jpg
‚îÇ   ‚îú‚îÄ‚îÄ tatarstan-kazanskij-kreml-1730211234569.jpg
‚îÇ   ‚îî‚îÄ‚îÄ tatarstan-kazanskij-kreml-1730211234570.jpg
‚îî‚îÄ‚îÄ videos/
    ‚îú‚îÄ‚îÄ tatarstan-kazanskij-kreml-1730211234571.mp4
    ‚îî‚îÄ‚îÄ tatarstan-kazanskij-kreml-1730211234572.mp4
```

---

### Git –∫–æ–º–º–∏—Ç—ã –∏—Ç–µ—Ä–∞—Ü–∏–∏ 7
```
c2704b8 - feat: –¥–æ–±–∞–≤–ª–µ–Ω–∞ –∑–∞–≥—Ä—É–∑–∫–∞ —Ñ–æ—Ç–æ –≥–∞–ª–µ—Ä–µ–∏ –∏ –≤–∏–¥–µ–æ –¥–ª—è —Ç—É—Ä–æ–≤
```

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ –∏ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–æ

---

## üéØ –ò—Ç–µ—Ä–∞—Ü–∏—è 8: –°–∫–ª–∞–¥—ã–≤–∞—é—â–∏–π—Å—è —Å–∞–π–¥–±–∞—Ä –∞–¥–º–∏–Ω–∫–∏ (29.10.2025)

### –¶–µ–ª—å –∏—Ç–µ—Ä–∞—Ü–∏–∏
–£–ª—É—á—à–µ–Ω–∏–µ UX –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏ —Å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å—é —Å–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏—è —Å–∞–π–¥–±–∞—Ä–∞ –¥–ª—è –±–æ–ª—å—à–µ–≥–æ —Ä–∞–±–æ—á–µ–≥–æ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–∞.

### –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

#### –û–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–π AdminSidebar
**–§–∞–π–ª:** `components/admin/AdminSidebar.tsx`

**–ù–æ–≤—ã–µ –∏–º–ø–æ—Ä—Ç—ã:**
```typescript
import { ChevronLeft, ChevronRight } from 'lucide-react';
import { useState, useEffect } from 'react';
```

**–°–æ—Å—Ç–æ—è–Ω–∏–µ —Å–∞–π–¥–±–∞—Ä–∞:**
```typescript
const [isCollapsed, setIsCollapsed] = useState(false);

// –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏–∑ localStorage –ø—Ä–∏ –º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏
useEffect(() => {
  const savedState = localStorage.getItem('adminSidebarCollapsed');
  if (savedState !== null) {
    setIsCollapsed(savedState === 'true');
  }
}, []);

// –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≤ localStorage –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏
const toggleSidebar = () => {
  const newState = !isCollapsed;
  setIsCollapsed(newState);
  localStorage.setItem('adminSidebarCollapsed', String(newState));
};
```

**–ê–¥–∞–ø—Ç–∏–≤–Ω–∞—è —à–∏—Ä–∏–Ω–∞:**
```tsx
<div 
  className={`bg-gray-900 text-white flex flex-col transition-all duration-300 relative ${
    isCollapsed ? 'w-20' : 'w-64'
  }`}
>
```

**–ö–Ω–æ–ø–∫–∞ toggle:**
```tsx
<button
  onClick={toggleSidebar}
  className="absolute top-6 -right-3 w-6 h-6 bg-emerald-600 rounded-full 
             flex items-center justify-center text-white hover:bg-emerald-700 
             transition-colors shadow-lg z-10"
  title={isCollapsed ? '–†–∞–∑–≤–µ—Ä–Ω—É—Ç—å' : '–°–≤–µ—Ä–Ω—É—Ç—å'}
>
  {isCollapsed ? (
    <ChevronRight className="w-4 h-4" />
  ) : (
    <ChevronLeft className="w-4 h-4" />
  )}
</button>
```

**–ê–¥–∞–ø—Ç–∏–≤–Ω—ã–π –ª–æ–≥–æ—Ç–∏–ø:**
```tsx
{!isCollapsed ? (
  <div>
    <h1 className="text-2xl font-bold">–ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å</h1>
    <p className="text-sm text-gray-400 mt-1">Tatarstan Tours</p>
  </div>
) : (
  <div className="w-full flex justify-center">
    <div className="w-10 h-10 rounded-lg bg-gradient-to-br from-emerald-500 to-emerald-600 
                    flex items-center justify-center font-bold">
      A
    </div>
  </div>
)}
```

**–ê–¥–∞–ø—Ç–∏–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:**
```tsx
<div className={`flex items-center ${isCollapsed ? 'justify-center' : 'gap-3'}`}>
  <div className="w-10 h-10 rounded-full bg-gradient-to-br from-emerald-500 to-emerald-600 
                  flex items-center justify-center text-sm font-bold flex-shrink-0">
    {userName.split(' ').map(n => n[0]).join('')}
  </div>
  {!isCollapsed && (
    <div className="overflow-hidden">
      <p className="text-sm font-medium truncate">{userName}</p>
      <p className="text-xs text-gray-400 truncate">
        {getRoleLabel(userRole)}
      </p>
    </div>
  )}
</div>
```

**–ù–∞–≤–∏–≥–∞—Ü–∏—è —Å tooltips:**
```tsx
<Link
  href={item.href}
  className={`flex items-center gap-3 px-3 py-2 rounded-lg transition-colors 
              relative group ${isActive ? 'bg-emerald-600' : 'hover:bg-gray-800'} 
              ${isCollapsed ? 'justify-center' : ''}`}
  title={isCollapsed ? item.name : ''}
>
  <item.icon className="w-5 h-5 flex-shrink-0" />
  {!isCollapsed && (
    <span className="text-sm font-medium">{item.name}</span>
  )}
  
  {/* Tooltip –ø—Ä–∏ —Å–≤—ë—Ä–Ω—É—Ç–æ–º —Å–∞–π–¥–±–∞—Ä–µ */}
  {isCollapsed && (
    <div className="absolute left-full ml-2 px-3 py-2 bg-gray-800 text-white 
                    text-sm rounded-lg opacity-0 invisible group-hover:opacity-100 
                    group-hover:visible transition-all whitespace-nowrap z-50">
      {item.name}
    </div>
  )}
</Link>
```

**–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å:**

1. **–î–≤–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è:**
   - üîì –†–∞–∑–≤—ë—Ä–Ω—É—Ç: `w-64` (256px) - –ø–æ–ª–Ω—ã–π —Ç–µ–∫—Å—Ç + –∏–∫–æ–Ω–∫–∏
   - üîí –°–≤—ë—Ä–Ω—É—Ç: `w-20` (80px) - —Ç–æ–ª—å–∫–æ –∏–∫–æ–Ω–∫–∏

2. **Tooltips:**
   - –í—Å–ø–ª—ã–≤–∞—é—Ç —Å–ø—Ä–∞–≤–∞ –æ—Ç –∏–∫–æ–Ω–æ–∫ –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏
   - –ü–æ–∫–∞–∑—ã–≤–∞—é—Ç –ø–æ–ª–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ä–∞–∑–¥–µ–ª–∞
   - –ê–Ω–∏–º–∞—Ü–∏—è `opacity` –∏ `visibility`

3. **–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è:**
   - –°–æ—Å—Ç–æ—è–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ `localStorage`
   - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–µ
   - –ö–ª—é—á: `adminSidebarCollapsed`

4. **–ü–ª–∞–≤–Ω–∞—è –∞–Ω–∏–º–∞—Ü–∏—è:**
   - `transition-all duration-300` –¥–ª—è —à–∏—Ä–∏–Ω—ã –∏ –æ—Ç—Å—Ç—É–ø–æ–≤
   - –ü–ª–∞–≤–Ω–æ–µ –ø–æ—è–≤–ª–µ–Ω–∏–µ/–∏—Å—á–µ–∑–Ω–æ–≤–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞
   - Smooth tooltips

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- ‚úÖ –ë–æ–ª—å—à–µ —Ä–∞–±–æ—á–µ–≥–æ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–∞ –≤ —Å–≤—ë—Ä–Ω—É—Ç–æ–º —Ä–µ–∂–∏–º–µ
- ‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤—ã–±–æ—Ä–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- ‚úÖ –£–¥–æ–±–Ω—ã–µ tooltips —Å –Ω–∞–∑–≤–∞–Ω–∏—è–º–∏
- ‚úÖ –ö—Ä–∞—Å–∏–≤–∞—è –∞–Ω–∏–º–∞—Ü–∏—è –ø–µ—Ä–µ—Ö–æ–¥–æ–≤
- ‚úÖ –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–π –¥–∏–∑–∞–π–Ω –¥–ª—è –≤—Å–µ—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤

---

### Git –∫–æ–º–º–∏—Ç—ã –∏—Ç–µ—Ä–∞—Ü–∏–∏ 8
```
b68d86c - feat: —Å–∫–ª–∞–¥—ã–≤–∞—é—â–∏–π—Å—è —Å–∞–π–¥–±–∞—Ä –∞–¥–º–∏–Ω–∫–∏ —Å –∏–∫–æ–Ω–∫–∞–º–∏
```

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ –∏ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–æ

---

## –ò—Ç–µ—Ä–∞—Ü–∏—è 9: –Ø–Ω–¥–µ–∫—Å –ö–∞—Ä—Ç—ã –∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∞–¥–º–∏–Ω–∫–∏

### –¶–µ–ª–∏ –∏—Ç–µ—Ä–∞—Ü–∏–∏
- ‚úÖ –î–æ–±–∞–≤–∏—Ç—å –ø–æ–¥–¥–µ—Ä–∂–∫—É –Ø–Ω–¥–µ–∫—Å –ö–∞—Ä—Ç –¥–ª—è —Ç—É—Ä–æ–≤
- ‚úÖ –ò—Å–ø—Ä–∞–≤–∏—Ç—å –ø—Ä–æ–∫—Ä—É—Ç–∫—É —Å–∞–π–¥–±–∞—Ä–∞ –∞–¥–º–∏–Ω–∫–∏
- ‚úÖ –°–¥–µ–ª–∞—Ç—å —Å–∞–π–¥–±–∞—Ä –ø–ª–∞–≤–∞—é—â–∏–º (sticky)
- ‚úÖ –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å UX –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏

### –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è

#### 1. –ü–æ–ª–µ –¥–ª—è –Ø–Ω–¥–µ–∫—Å –ö–∞—Ä—Ç
**–§–∞–π–ª:** `supabase/migrations/006_add_yandex_map.sql`

–î–æ–±–∞–≤–ª–µ–Ω–æ –Ω–æ–≤–æ–µ –ø–æ–ª–µ –≤ —Ç–∞–±–ª–∏—Ü—É `tours`:
```sql
ALTER TABLE tours 
ADD COLUMN IF NOT EXISTS yandex_map_url TEXT;

COMMENT ON COLUMN tours.yandex_map_url IS 
  'URL –∏–ª–∏ embed –∫–æ–¥ –Ø–Ω–¥–µ–∫—Å –ö–∞—Ä—Ç—ã –¥–ª—è –ª–æ–∫–∞—Ü–∏–∏ —Ç—É—Ä–∞';
```

**–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:**
- –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –º–æ–∂–µ—Ç –¥–æ–±–∞–≤–∏—Ç—å —Å—Å—ã–ª–∫—É –Ω–∞ –Ø–Ω–¥–µ–∫—Å –ö–∞—Ä—Ç—É –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ —Ç—É—Ä–∞
- –ü–æ–ª–µ –Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ (NULL —Ä–∞–∑—Ä–µ—à—ë–Ω)
- –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –∫–∞–∫ URL, —Ç–∞–∫ –∏ embed-–∫–æ–¥ –∫–∞—Ä—Ç—ã
- –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –≤ –ë–î –¥–ª—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏

#### 2. –§–∏–∫—Å —Å–∞–π–¥–±–∞—Ä–∞ –∞–¥–º–∏–Ω–∫–∏
**–§–∞–π–ª:** `components/admin/AdminSidebar.tsx`

**–ü—Ä–æ–±–ª–µ–º–∞:**
- –°–∞–π–¥–±–∞—Ä –∏–º–µ–ª `overflow-y: auto`, —á—Ç–æ —Å–æ–∑–¥–∞–≤–∞–ª–æ –≤—Ç–æ—Ä–æ–π —Å–∫—Ä–æ–ª–ª
- –ü—Ä–∏ –ø—Ä–æ–∫—Ä—É—Ç–∫–µ –æ—Å–Ω–æ–≤–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã —Å–∞–π–¥–±–∞—Ä –æ—Å—Ç–∞–≤–∞–ª—Å—è –Ω–∞ –º–µ—Å—Ç–µ
- –ù–µ—É–¥–æ–±–Ω–∞—è –Ω–∞–≤–∏–≥–∞—Ü–∏—è –ø—Ä–∏ —Ä–∞–±–æ—Ç–µ —Å –¥–ª–∏–Ω–Ω—ã–º–∏ —Ñ–æ—Ä–º–∞–º–∏

**–†–µ—à–µ–Ω–∏–µ:**

1. **–£–±—Ä–∞–Ω overflow-y:**
```tsx
// –ë—ã–ª–æ:
<aside className="... overflow-y-auto">

// –°—Ç–∞–ª–æ:
<aside className="..."> {/* –±–µ–∑ overflow-y: auto */}
```

2. **–î–æ–±–∞–≤–ª–µ–Ω sticky positioning:**
```tsx
<aside className="fixed top-0 left-0 h-screen bg-white border-r border-gray-200 
                  transition-all duration-300 z-30 
                  ${isCollapsed ? 'w-20' : 'w-64'}">
```

3. **–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∫–æ–Ω—Ç–µ–Ω—Ç–∞:**
```tsx
<div className="h-full flex flex-col">
  {/* Header */}
  <div className="flex-shrink-0 p-4">...</div>
  
  {/* Navigation —Å –ø—Ä–æ–∫—Ä—É—Ç–∫–æ–π –µ—Å–ª–∏ –Ω—É–∂–Ω–æ */}
  <nav className="flex-1 px-3 py-4 space-y-1 overflow-y-auto">
    {menuItems.map(...)}
  </nav>
  
  {/* Footer */}
  <div className="flex-shrink-0 p-4 border-t">...</div>
</div>
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –Ω–æ–≤–æ–≥–æ —Ä–µ—à–µ–Ω–∏—è:**
- ‚úÖ **–û–¥–∏–Ω —Å–∫—Ä–æ–ª–ª** - —Ç–æ–ª—å–∫–æ –æ—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç –ø—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ—Ç—Å—è
- ‚úÖ **–ü–ª–∞–≤–∞—é—â–∏–π —Å–∞–π–¥–±–∞—Ä** - —Å–ª–µ–¥—É–µ—Ç –∑–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º –ø—Ä–∏ –ø—Ä–æ–∫—Ä—É—Ç–∫–µ
- ‚úÖ **–í—Å–µ–≥–¥–∞ –¥–æ—Å—Ç—É–ø–Ω–∞—è –Ω–∞–≤–∏–≥–∞—Ü–∏—è** - –º–µ–Ω—é –≤—Å–µ–≥–¥–∞ –≤–∏–¥–Ω–æ
- ‚úÖ **–õ—É—á—à–∏–π UX** - –∏–Ω—Ç—É–∏—Ç–∏–≤–Ω–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
- ‚úÖ **–ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å** - –∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è —Ä–∞–±–æ—Ç–∞ –≤ —Å–≤—ë—Ä–Ω—É—Ç–æ–º —Ä–µ–∂–∏–º–µ

#### 3. –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–∫—Ä—É—Ç–∫–∏

**–ò–µ—Ä–∞—Ä—Ö–∏—è —ç–ª–µ–º–µ–Ω—Ç–æ–≤:**
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ –°–∞–π–¥–±–∞—Ä (fixed, h-screen)           ‚îÇ
‚îÇ ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ
‚îÇ ‚îÇ Header (flex-shrink-0)          ‚îÇ ‚îÇ
‚îÇ ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§ ‚îÇ
‚îÇ ‚îÇ Nav (flex-1, overflow-y-auto)   ‚îÇ ‚îÇ ‚Üê –°–∫—Ä–æ–ª–ª —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –º–Ω–æ–≥–æ –ø—É–Ω–∫—Ç–æ–≤
‚îÇ ‚îÇ ‚Ä¢ –¢—É—Ä—ã                          ‚îÇ ‚îÇ
‚îÇ ‚îÇ ‚Ä¢ –ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è                  ‚îÇ ‚îÇ
‚îÇ ‚îÇ ‚Ä¢ –û—Ç–∑—ã–≤—ã                        ‚îÇ ‚îÇ
‚îÇ ‚îÇ ‚Ä¢ ...                           ‚îÇ ‚îÇ
‚îÇ ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§ ‚îÇ
‚îÇ ‚îÇ Footer (flex-shrink-0)          ‚îÇ ‚îÇ
‚îÇ ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**–û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç:**
- –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ—Ç—Å—è –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç —Å–∞–π–¥–±–∞—Ä–∞
- –°–∞–π–¥–±–∞—Ä –æ—Å—Ç–∞—ë—Ç—Å—è –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–º –Ω–∞ —ç–∫—Ä–∞–Ω–µ
- –ù–∞–≤–∏–≥–∞—Ü–∏—è –≤—Å–µ–≥–¥–∞ –¥–æ—Å—Ç—É–ø–Ω–∞

### –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

#### –ü–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
```css
.sidebar {
  position: fixed;
  top: 0;
  left: 0;
  height: 100vh;
  z-index: 30;
}
```

#### –í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞
```css
.sidebar-content {
  height: 100%;
  display: flex;
  flex-direction: column;
}

.sidebar-nav {
  flex: 1;
  overflow-y: auto; /* –¢–æ–ª—å–∫–æ –¥–ª—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ */
}
```

### –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —Ñ–æ—Ä–º–∞–º–∏ —Ç—É—Ä–æ–≤

–í —Ñ–æ—Ä–º–µ —Å–æ–∑–¥–∞–Ω–∏—è/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ç—É—Ä–∞ –¥–æ–±–∞–≤–ª–µ–Ω–æ –ø–æ–ª–µ –¥–ª—è –Ø–Ω–¥–µ–∫—Å –ö–∞—Ä—Ç:

```tsx
<div className="space-y-2">
  <Label htmlFor="yandex_map_url">–Ø–Ω–¥–µ–∫—Å –ö–∞—Ä—Ç–∞</Label>
  <Input
    id="yandex_map_url"
    name="yandex_map_url"
    type="text"
    placeholder="https://yandex.ru/maps/..."
  />
  <p className="text-sm text-gray-500">
    –í—Å—Ç–∞–≤—å—Ç–µ —Å—Å—ã–ª–∫—É –Ω–∞ –ª–æ–∫–∞—Ü–∏—é –≤ –Ø–Ω–¥–µ–∫—Å –ö–∞—Ä—Ç–∞—Ö –∏–ª–∏ embed-–∫–æ–¥
  </p>
</div>
```

### Git –∫–æ–º–º–∏—Ç—ã –∏—Ç–µ—Ä–∞—Ü–∏–∏ 9
```
[hash] - feat: –¥–æ–±–∞–≤–ª–µ–Ω–æ –ø–æ–ª–µ yandex_map_url –¥–ª—è —Ç—É—Ä–æ–≤
[hash] - fix: –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —Å–∞–π–¥–±–∞—Ä–∞ –∞–¥–º–∏–Ω–∫–∏ (—É–±—Ä–∞–Ω –¥–≤–æ–π–Ω–æ–π —Å–∫—Ä–æ–ª–ª, –¥–æ–±–∞–≤–ª–µ–Ω sticky)
```

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ –∏ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–æ

---

## –ò—Ç–µ—Ä–∞—Ü–∏—è 10: –ü—É–±–ª–∏—á–Ω–æ–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ç—É—Ä–æ–≤ –∏ —Ñ–∏–∫—Å –∞–¥–º–∏–Ω–∫–∏

### –¶–µ–ª–∏ –∏—Ç–µ—Ä–∞—Ü–∏–∏
- ‚úÖ –°–æ–∑–¥–∞—Ç—å –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ç—É—Ä–æ–≤ –Ω–∞ –≥–ª–∞–≤–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ
- ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –æ—Ç–¥–µ–ª—å–Ω–æ–≥–æ —Ç—É—Ä–∞
- ‚úÖ –ò—Å–ø—Ä–∞–≤–∏—Ç—å –±–∞–≥ —Å –ø—Ä–æ–ø–∞–¥–∞—é—â–µ–π –∫–Ω–æ–ø–∫–æ–π –∞–¥–º–∏–Ω–∫–∏
- ‚úÖ –ò—Å–ø—Ä–∞–≤–∏—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –º–µ–¥–∏–∞ –≤ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –ø–∞–ø–∫–∏ S3
- ‚úÖ –î–æ–±–∞–≤–∏—Ç—å –∞–¥–∞–ø—Ç–∏–≤–Ω—ã–µ textarea –≤ —Ñ–æ—Ä–º–∞—Ö

### –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è

#### 1. –ö–æ–º–ø–æ–Ω–µ–Ω—Ç –∫–∞—Ä—Ç–æ—á–∫–∏ —Ç—É—Ä–∞
**–§–∞–π–ª:** `components/tours/TourCard.tsx`

–°–æ–∑–¥–∞–Ω –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ç—É—Ä–æ–≤:

**–û—Å–Ω–æ–≤–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:**
- ‚úÖ –ö—Ä–∞—Å–∏–≤–∞—è –∫–∞—Ä—Ç–æ—á–∫–∞ —Å –æ–±–ª–æ–∂–∫–æ–π –∏ hover-—ç—Ñ—Ñ–µ–∫—Ç–∞–º–∏
- ‚úÖ –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ü–µ–Ω—ã, –¥–∞—Ç, —Ç–∏–ø–∞, –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
- ‚úÖ –ü—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –º–µ—Å—Ç
- ‚úÖ –†–∞—Å—á—ë—Ç –ø—Ä–æ–¥–æ–ª–∂–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ —Ç—É—Ä–∞
- ‚úÖ –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–π –¥–∏–∑–∞–π–Ω
- ‚úÖ –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä "–ú–µ—Å—Ç –Ω–µ—Ç" –¥–ª—è –ø–æ–ª–Ω–æ—Å—Ç—å—é –∑–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Ç—É—Ä–æ–≤

```tsx
<TourCard
  id={tour.id}
  title={tour.title}
  slug={tour.slug}
  short_desc={tour.short_desc}
  cover_image={tour.cover_image}
  price_per_person={tour.price_per_person}
  start_date={tour.start_date}
  end_date={tour.end_date}
  max_participants={tour.max_participants}
  current_participants={tour.current_participants || 0}
  tour_type={tour.tour_type}
  category={tour.category}
/>
```

**–ú–µ—Ç–∫–∏ —Ç–∏–ø–æ–≤ –∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–π:**
```typescript
const TOUR_TYPE_LABELS = {
  excursion: '–≠–∫—Å–∫—É—Ä—Å–∏—è',
  multi_day: '–ú–Ω–æ–≥–æ–¥–Ω–µ–≤–Ω—ã–π',
  weekend: '–í—ã—Ö–æ–¥–Ω—ã–µ',
};

const CATEGORY_LABELS = {
  history: '–ò—Å—Ç–æ—Ä–∏—è',
  nature: '–ü—Ä–∏—Ä–æ–¥–∞',
  culture: '–ö—É–ª—å—Ç—É—Ä–∞',
  gastronomy: '–ì–∞—Å—Ç—Ä–æ–Ω–æ–º–∏—è',
  active: '–ê–∫—Ç–∏–≤–Ω—ã–π –æ—Ç–¥—ã—Ö',
  religious: '–†–µ–ª–∏–≥–∏–æ–∑–Ω—ã–µ',
};
```

#### 2. –°–µ–∫—Ü–∏—è –ø–æ–ø—É–ª—è—Ä–Ω—ã—Ö —Ç—É—Ä–æ–≤ –Ω–∞ –≥–ª–∞–≤–Ω–æ–π
**–§–∞–π–ª:** `components/home/FeaturedTours.tsx`

Server Component –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ç—É—Ä–æ–≤:

```tsx
export async function FeaturedTours() {
  const supabase = await createServiceClient();

  const { data: tours } = await supabase
    .from('tours')
    .select('*')
    .eq('status', 'active')
    .order('created_at', { ascending: false })
    .limit(6);

  return (
    <section className="py-20 bg-gray-50">
      <div className="container mx-auto px-4">
        <h2>–ü–æ–ø—É–ª—è—Ä–Ω—ã–µ —Ç—É—Ä—ã</h2>
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
          {tours.map((tour) => <TourCard key={tour.id} {...tour} />)}
        </div>
        <Link href="/tours">–°–º–æ—Ç—Ä–µ—Ç—å –≤—Å–µ —Ç—É—Ä—ã</Link>
      </div>
    </section>
  );
}
```

**–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≥–ª–∞–≤–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã:**
```tsx
// app/page.tsx
export default function Home() {
  return (
    <main>
      <HeroSection />
      <FeaturedTours /> {/* ‚úÖ –ù–æ–≤–∞—è —Å–µ–∫—Ü–∏—è */}
    </main>
  );
}
```

#### 3. –°—Ç—Ä–∞–Ω–∏—Ü–∞ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Ç—É—Ä–∞
**–§–∞–π–ª:** `app/tours/[slug]/page.tsx`

–î–µ—Ç–∞–ª—å–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –æ—Ç–¥–µ–ª—å–Ω–æ–≥–æ —Ç—É—Ä–∞ —Å –ø–æ–ª–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π:

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞:**
- **–õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ (–æ—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è):**
  - –û–±–ª–æ–∂–∫–∞ —Å –±–µ–π–¥–∂–∞–º–∏ —Ç–∏–ø–∞ –∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
  - –ó–∞–≥–æ–ª–æ–≤–æ–∫ –∏ –∫—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ
  - –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ (–¥–∞—Ç—ã, –ø—Ä–æ–¥–æ–ª–∂–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å, —É—á–∞—Å—Ç–Ω–∏–∫–∏, —Ü–µ–Ω–∞)
  - –ü–æ–ª–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ (rich text HTML)
  - –§–æ—Ç–æ–≥–∞–ª–µ—Ä–µ—è (–µ—Å–ª–∏ –µ—Å—Ç—å)
  - –í–∏–¥–µ–æ (–µ—Å–ª–∏ –µ—Å—Ç—å)
  - –Ø–Ω–¥–µ–∫—Å –ö–∞—Ä—Ç–∞ (–µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω–∞)

- **–ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ (–±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ):**
  - –¶–µ–Ω–∞
  - –ü—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –º–µ—Å—Ç
  - –ö–Ω–æ–ø–∫–∞ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
  - –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ (–æ—Ç–º–µ–Ω–∞, –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ, –≥–∏–¥)
  - –ö–Ω–æ–ø–∫–∞ "–ü–æ–¥–µ–ª–∏—Ç—å—Å—è"

```tsx
export default async function TourPage({ params }: TourPageProps) {
  const { slug } = await params;
  const supabase = await createServiceClient();

  const { data: tour } = await supabase
    .from('tours')
    .select('*')
    .eq('slug', slug)
    .eq('status', 'active')
    .single();

  const { data: media } = await supabase
    .from('tour_media')
    .select('*')
    .eq('tour_id', tour.id);

  return (
    <main>
      {/* –ù–∞–≤–∏–≥–∞—Ü–∏—è */}
      <Link href="/">‚Üê –ù–∞–∑–∞–¥ –Ω–∞ –≥–ª–∞–≤–Ω—É—é</Link>
      
      {/* –ö–æ–Ω—Ç–µ–Ω—Ç —Ç—É—Ä–∞ */}
      <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <div className="lg:col-span-2">
          {/* –û–±–ª–æ–∂–∫–∞, –æ–ø–∏—Å–∞–Ω–∏–µ, –≥–∞–ª–µ—Ä–µ—è, –∫–∞—Ä—Ç–∞ */}
        </div>
        <div className="lg:col-span-1">
          {/* –ë–ª–æ–∫ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è */}
        </div>
      </div>
    </main>
  );
}
```

**–û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –Ø–Ω–¥–µ–∫—Å –ö–∞—Ä—Ç:**
```tsx
{tour.yandex_map_url && (
  <div className="bg-white rounded-2xl shadow-sm p-8">
    <h2>–ú–µ—Å—Ç–æ –ø—Ä–æ–≤–µ–¥–µ–Ω–∏—è</h2>
    <div className="relative w-full h-96 rounded-xl overflow-hidden">
      {tour.yandex_map_url.includes('<iframe') ? (
        <div dangerouslySetInnerHTML={{ __html: tour.yandex_map_url }} />
      ) : (
        <iframe src={tour.yandex_map_url} allowFullScreen />
      )}
    </div>
  </div>
)}
```

#### 4. –°—Ç—Ä–∞–Ω–∏—Ü–∞ –≤—Å–µ—Ö —Ç—É—Ä–æ–≤
**–§–∞–π–ª:** `app/tours/page.tsx`

–ö–∞—Ç–∞–ª–æ–≥ –≤—Å–µ—Ö –∞–∫—Ç–∏–≤–Ω—ã—Ö —Ç—É—Ä–æ–≤:

```tsx
export default async function ToursPage() {
  const { data: tours } = await supabase
    .from('tours')
    .select('*')
    .eq('status', 'active')
    .order('created_at', { ascending: false });

  return (
    <main>
      <div className="bg-gradient-to-br from-emerald-500 to-teal-600">
        <h1>–í—Å–µ —Ç—É—Ä—ã</h1>
        <div>{tours?.length || 0} —Ç—É—Ä–æ–≤</div>
      </div>
      
      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
        {tours.map((tour) => <TourCard key={tour.id} {...tour} />)}
      </div>
    </main>
  );
}
```

#### 5. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–∞–≥–∞ —Å –ø—Ä–æ–ø–∞–¥–∞—é—â–µ–π –∞–¥–º–∏–Ω–∫–æ–π

**–ü—Ä–æ–±–ª–µ–º–∞:**
–ö–Ω–æ–ø–∫–∞ "–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å" –≤ UserMenu –∏–Ω–æ–≥–¥–∞ –∏—Å—á–µ–∑–∞–ª–∞ –∏–∑-–∑–∞ —Ç–æ–≥–æ, —á—Ç–æ `role` –Ω–µ –∑–∞–≥—Ä—É–∂–∞–ª–∞—Å—å –≤ `user_metadata` –ø—Ä–∏ –±—ã—Å—Ç—Ä–æ–π –∑–∞–≥—Ä—É–∑–∫–µ –ø—Ä–æ—Ñ–∏–ª—è.

**–§–∞–π–ª:** `components/layout/UserMenu.tsx`

**–†–µ—à–µ–Ω–∏–µ 1 - –î–æ–±–∞–≤–ª–µ–Ω–∏–µ role –≤ metadata:**
```tsx
useEffect(() => {
  supabase.auth.getUser().then(({ data: { user } }) => {
    if (user) {
      const metaProfile = {
        first_name: user.user_metadata?.first_name,
        last_name: user.user_metadata?.last_name,
        avatar_url: user.user_metadata?.avatar_url,
        role: user.user_metadata?.role, // ‚úÖ –¢–µ–ø–µ—Ä—å –∑–∞–≥—Ä—É–∂–∞–µ–º —Ä–æ–ª—å!
      };
      setProfile(metaProfile);
    }
  });
}, [supabase]);
```

**–§–∞–π–ª:** `components/auth/LoginForm.tsx`

**–†–µ—à–µ–Ω–∏–µ 2 - –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ metadata –ø—Ä–∏ –ª–æ–≥–∏–Ω–µ:**
```tsx
if (data.user) {
  // –ó–∞–≥—Ä—É–∂–∞–µ–º –∞–∫—Ç—É–∞–ª—å–Ω—É—é —Ä–æ–ª—å –∏–∑ –ë–î
  const { data: profile } = await supabase
    .from('profiles')
    .select('role, first_name, last_name, avatar_url')
    .eq('id', data.user.id)
    .single();

  if (profile) {
    // –û–±–Ω–æ–≤–ª—è–µ–º user_metadata —Å –∞–∫—Ç—É–∞–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π
    await supabase.auth.updateUser({
      data: {
        role: profile.role,
        first_name: profile.first_name,
        last_name: profile.last_name,
        avatar_url: profile.avatar_url,
      },
    });
  }

  router.push('/profile');
}
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- ‚úÖ –†–æ–ª—å –≤—Å–µ–≥–¥–∞ –¥–æ—Å—Ç—É–ø–Ω–∞ –≤ `user_metadata`
- ‚úÖ –ö–Ω–æ–ø–∫–∞ –∞–¥–º–∏–Ω–∫–∏ –±–æ–ª—å—à–µ –Ω–µ –ø—Ä–æ–ø–∞–¥–∞–µ—Ç
- ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç –¥–∞–∂–µ –ø—Ä–∏ RLS-–æ—à–∏–±–∫–∞—Ö —Å —Ç–∞–±–ª–∏—Ü–µ–π profiles

#### 6. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—É—Ç–µ–π S3 –¥–ª—è –æ–±–ª–æ–∂–µ–∫

**–ü—Ä–æ–±–ª–µ–º–∞:**
–û–±–ª–æ–∂–∫–∏ —Ç—É—Ä–æ–≤ —Å–æ—Ö—Ä–∞–Ω—è–ª–∏—Å—å –≤ `/null/` –≤–º–µ—Å—Ç–æ `/tours/covers/`

**–§–∞–π–ª:** `components/admin/TourForm.tsx`

**–ë—ã–ª–æ:**
```tsx
formDataUpload.append('type', 'tour-cover'); // ‚ùå API –æ–∂–∏–¥–∞–µ—Ç 'folder'
```

**–°—Ç–∞–ª–æ:**
```tsx
formDataUpload.append('folder', 'tours/covers'); // ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –ø–∞–ø–∫–∞
```

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ S3:**
```
s3://bucket-name/
  ‚îú‚îÄ‚îÄ tours/covers/      ‚Üê üñºÔ∏è –û–±–ª–æ–∂–∫–∏ —Ç—É—Ä–æ–≤
  ‚îú‚îÄ‚îÄ tours/gallery/     ‚Üê üì∏ –§–æ—Ç–æ–≥–∞–ª–µ—Ä–µ—è
  ‚îî‚îÄ‚îÄ tours/videos/      ‚Üê üé¨ –í–∏–¥–µ–æ
```

#### 7. –î–æ–±–∞–≤–ª–µ–Ω–∏–µ description –≤ —Å–æ–∑–¥–∞–Ω–∏–µ —Ç—É—Ä–∞

**–ü—Ä–æ–±–ª–µ–º–∞:**
–û—à–∏–±–∫–∞ `null value in column "description" violates not-null constraint` –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Ç—É—Ä–∞.

**–†–µ—à–µ–Ω–∏–µ:**
```tsx
const tourData = {
  ...formData,
  cover_image: coverImageUrl,
  price_per_person: parseFloat(formData.price_per_person),
  yandex_map_url: formData.yandex_map_url.trim() || null,
  description: formData.short_desc, // ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ–º short_desc –¥–ª—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–≥–æ –ø–æ–ª—è
};
```

#### 8. –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–µ textarea

**–§–∞–π–ª:** `components/admin/AutoResizeTextarea.tsx`

–°–æ–∑–¥–∞–Ω –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ä–∞—Å—à–∏—Ä—è—é—â–µ–≥–æ—Å—è textarea:

```tsx
const AutoResizeTextarea: React.FC<AutoResizeTextareaProps> = ({ 
  minRows = 3, 
  maxRows = 20, 
  ...props 
}) => {
  const textareaRef = useRef<HTMLTextAreaElement>(null);

  useEffect(() => {
    if (textareaRef.current) {
      textareaRef.current.style.height = 'auto';
      const scrollHeight = textareaRef.current.scrollHeight;
      const lineHeight = parseInt(getComputedStyle(textareaRef.current).lineHeight);
      const newRows = Math.min(maxRows, Math.max(minRows, Math.ceil(scrollHeight / lineHeight)));
      textareaRef.current.rows = newRows;
      textareaRef.current.style.height = `${scrollHeight}px`;
    }
  }, [props.value, minRows, maxRows]);

  return <textarea {...props} ref={textareaRef} rows={minRows} />;
};
```

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**
```tsx
<AutoResizeTextarea
  value={formData.yandex_map_url}
  onChange={(e) => handleYandexMapChange(e.target.value)}
  minRows={3}
  maxRows={10}
  placeholder="–í—Å—Ç–∞–≤—å—Ç–µ —Å—Å—ã–ª–∫—É –∏–ª–∏ iframe –∫–æ–¥"
/>
```

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –º–∞—Ä—à—Ä—É—Ç–æ–≤

```
/                          ‚Üê –ì–ª–∞–≤–Ω–∞—è (Hero + –ø–æ–ø—É–ª—è—Ä–Ω—ã–µ —Ç—É—Ä—ã)
/tours                     ‚Üê –í—Å–µ —Ç—É—Ä—ã (–∫–∞—Ç–∞–ª–æ–≥)
/tours/[slug]              ‚Üê –ü—Ä–æ—Å–º–æ—Ç—Ä –æ—Ç–¥–µ–ª—å–Ω–æ–≥–æ —Ç—É—Ä–∞
/admin                     ‚Üê –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å
/admin/tours               ‚Üê –°–ø–∏—Å–æ–∫ —Ç—É—Ä–æ–≤ (–∞–¥–º–∏–Ω–∫–∞)
/admin/tours/create        ‚Üê –°–æ–∑–¥–∞–Ω–∏–µ —Ç—É—Ä–∞
/admin/tours/[id]/edit     ‚Üê –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç—É—Ä–∞
```

### –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –æ—Ç–ª–∞–¥–∫–∞

–î–æ–±–∞–≤–ª–µ–Ω—ã console.log –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏:

**–ö–ª–∏–µ–Ω—Ç (TourForm.tsx):**
```tsx
console.log('üöÄ –û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö —Ç—É—Ä–∞:', tourData);
console.log('üì° –û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞:', response.status);
console.log('‚úÖ –¢—É—Ä —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω!');
```

**–°–µ—Ä–≤–µ—Ä (api/admin/tours/route.ts):**
```tsx
console.log('üìù Received tour data:', JSON.stringify(tourData, null, 2));
console.log('üë§ Added created_by:', user.id);
console.log('‚úÖ Final tour data to insert:', JSON.stringify(tourData, null, 2));
console.log('‚úÖ Tour created successfully:', data.id);
console.error('‚ùå Error creating tour:', error);
```

### Git –∫–æ–º–º–∏—Ç—ã –∏—Ç–µ—Ä–∞—Ü–∏–∏ 10
```
[hash] - feat: –¥–æ–±–∞–≤–ª–µ–Ω –∫–æ–º–ø–æ–Ω–µ–Ω—Ç TourCard –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ç—É—Ä–æ–≤
[hash] - feat: —Å–æ–∑–¥–∞–Ω–∞ —Å–µ–∫—Ü–∏—è FeaturedTours –Ω–∞ –≥–ª–∞–≤–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ
[hash] - feat: —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Ç—É—Ä–∞ /tours/[slug]
[hash] - feat: —Å–æ–∑–¥–∞–Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –∫–∞—Ç–∞–ª–æ–≥–∞ –≤—Å–µ—Ö —Ç—É—Ä–æ–≤ /tours
[hash] - fix: –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ –ø—Ä–æ–ø–∞–¥–∞–Ω–∏–µ –∫–Ω–æ–ø–∫–∏ –∞–¥–º–∏–Ω–∫–∏ (–¥–æ–±–∞–≤–ª–µ–Ω–∞ role –≤ metadata)
[hash] - fix: –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ user_metadata –ø—Ä–∏ –ª–æ–≥–∏–Ω–µ —Å –∞–∫—Ç—É–∞–ª—å–Ω–æ–π —Ä–æ–ª—å—é
[hash] - fix: –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã –ø—É—Ç–∏ S3 –¥–ª—è –æ–±–ª–æ–∂–µ–∫ (tours/covers –≤–º–µ—Å—Ç–æ null)
[hash] - fix: –¥–æ–±–∞–≤–ª–µ–Ω–æ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ –ø–æ–ª–µ description –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Ç—É—Ä–∞
[hash] - feat: —Å–æ–∑–¥–∞–Ω –∫–æ–º–ø–æ–Ω–µ–Ω—Ç AutoResizeTextarea –¥–ª—è –∞–¥–∞–ø—Ç–∏–≤–Ω—ã—Ö —Ñ–æ—Ä–º
[hash] - feat: –¥–æ–±–∞–≤–ª–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ —Å–æ–∑–¥–∞–Ω–∏—è —Ç—É—Ä–æ–≤
```

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ –∏ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–æ

---

## –ò—Ç–µ—Ä–∞—Ü–∏—è 11: –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç—É—Ä–æ–≤ –∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –º–µ–¥–∏–∞

### –¶–µ–ª–∏ –∏—Ç–µ—Ä–∞—Ü–∏–∏
- ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ç—É—Ä–∞
- ‚úÖ –î–æ–±–∞–≤–∏—Ç—å PUT API endpoint –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç—É—Ä–æ–≤
- ‚úÖ –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∑–∞–≥—Ä—É–∑–∫—É –º–µ–¥–∏–∞—Ñ–∞–π–ª–æ–≤ (–ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞)
- ‚úÖ –ò—Å–ø—Ä–∞–≤–∏—Ç—å RLS –ø–æ–ª–∏—Ç–∏–∫–∏ –¥–ª—è tour_media
- ‚úÖ –î–æ–±–∞–≤–∏—Ç—å –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏–µ –∫–æ–ª–æ–Ω–∫–∏ –≤ tour_media
- ‚úÖ –î–æ–±–∞–≤–∏—Ç—å –¥–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≥—Ä—É–∑–∫–∏ –º–µ–¥–∏–∞

### –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è

#### 1. –°—Ç—Ä–∞–Ω–∏—Ü–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ç—É—Ä–∞

**–§–∞–π–ª:** `app/admin/tours/[id]/edit/page.tsx`

–°–æ–∑–¥–∞–Ω–∞ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ —Ç—É—Ä–∞:

```tsx
export default async function EditTourPage({ params }: { params: { id: string } }) {
  const supabase = await createClient();
  
  // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞
  const { data: { user } } = await supabase.auth.getUser();
  if (!user) redirect('/auth/login');
  
  const { data: profile } = await supabase
    .from('profiles')
    .select('role')
    .eq('id', user.id)
    .single();
    
  if (!profile || !['super_admin', 'tour_admin'].includes(profile.role)) {
    redirect('/');
  }
  
  // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ —Ç—É—Ä–∞
  const { data: tour } = await supabase
    .from('tours')
    .select('*')
    .eq('id', params.id)
    .single();
    
  // –ó–∞–≥—Ä—É–∂–∞–µ–º –º–µ–¥–∏–∞
  const { data: media } = await supabase
    .from('tour_media')
    .select('*')
    .eq('tour_id', params.id)
    .order('created_at', { ascending: true });
    
  return <TourForm mode="edit" initialData={tour} existingMedia={media} />;
}
```

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞ (super_admin, tour_admin)
- ‚úÖ –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö —Ç—É—Ä–∞ –∏ —Å–≤—è–∑–∞–Ω–Ω—ã—Ö –º–µ–¥–∏–∞
- ‚úÖ –ü–µ—Ä–µ–¥–∞—á–∞ –¥–∞–Ω–Ω—ã—Ö –≤ TourForm –≤ —Ä–µ–∂–∏–º–µ "edit"

#### 2. PUT API endpoint –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç—É—Ä–æ–≤

**–§–∞–π–ª:** `app/api/admin/tours/route.ts`

–î–æ–±–∞–≤–ª–µ–Ω –º–µ—Ç–æ–¥ PUT –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Ç—É—Ä–æ–≤:

```tsx
export async function PUT(request: NextRequest) {
  const supabase = await createClient();
  const serviceClient = await createServiceClient();
  
  // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
  const { data: { user }, error: authError } = await supabase.auth.getUser();
  if (authError || !user) {
    return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });
  }
  
  // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤
  const { data: profile } = await supabase
    .from('profiles')
    .select('role')
    .eq('id', user.id)
    .single();
    
  if (!profile || !['super_admin', 'tour_admin'].includes(profile.role)) {
    return NextResponse.json({ error: 'Forbidden' }, { status: 403 });
  }
  
  const tourData = await request.json();
  console.log('üìù Updating tour:', tourData.id);
  
  // –£–¥–∞–ª—è–µ–º –ø–æ–ª—è, –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ –Ω—É–∂–Ω–æ –æ–±–Ω–æ–≤–ª—è—Ç—å
  const { id, created_at, created_by, gallery_photos, video_urls, ...updateData } = tourData;
  
  const { data, error } = await serviceClient
    .from('tours')
    .update(updateData)
    .eq('id', id)
    .select()
    .single();
    
  if (error) {
    console.error('‚ùå Error updating tour:', error);
    return NextResponse.json(
      { error: 'Failed to update tour', details: error.message },
      { status: 500 }
    );
  }
  
  console.log('‚úÖ Tour updated successfully:', data.id);
  return NextResponse.json({ success: true, data });
}
```

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –∏ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞
- ‚úÖ –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ–ª–µ–π (–Ω–µ –æ–±–Ω–æ–≤–ª—è–µ–º created_at, created_by, etc.)
- ‚úÖ –î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
- ‚úÖ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ service client –¥–ª—è –æ–±—Ö–æ–¥–∞ RLS

#### 3. –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –º–µ–¥–∏–∞

**–§–∞–π–ª:** `components/admin/TourForm.tsx`

**–ü—Ä–æ–±–ª–µ–º–∞:**
–ú–µ–¥–∏–∞—Ñ–∞–π–ª—ã –∑–∞–≥—Ä—É–∂–∞–ª–∏—Å—å –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ (—Ñ–æ—Ç–æ –ø–æ –æ—á–µ—Ä–µ–¥–∏, –ø–æ—Ç–æ–º –≤–∏–¥–µ–æ), —á—Ç–æ –ø—Ä–∏–≤–æ–¥–∏–ª–æ –∫ –æ—á–µ–Ω—å –¥–æ–ª–≥–æ–º—É —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—é.

**–†–µ—à–µ–Ω–∏–µ:**
- ‚úÖ –û–±–ª–æ–∂–∫–∞ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è **—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –≤—ã–±—Ä–∞–Ω –Ω–æ–≤—ã–π —Ñ–∞–π–ª**
- ‚úÖ –§–æ—Ç–æ –∏ –≤–∏–¥–µ–æ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è **–ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ** —á–µ—Ä–µ–∑ `Promise.all`
- ‚úÖ –°—Ç–∞—Ç—É—Å –∑–∞–≥—Ä—É–∑–∫–∏ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –≤ –∫–Ω–æ–ø–∫–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è

```tsx
const handleSubmit = async (e: React.FormEvent) => {
  setLoading(true);
  setLoadingStatus('–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö...');
  
  try {
    // 1. –ó–∞–≥—Ä—É–∑–∫–∞ –æ–±–ª–æ–∂–∫–∏ (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –≤—ã–±—Ä–∞–Ω –Ω–æ–≤—ã–π —Ñ–∞–π–ª)
    let coverImageUrl = formData.cover_image || coverImage;
    if (coverImageFile) {
      setLoadingStatus('–ó–∞–≥—Ä—É–∑–∫–∞ –æ–±–ª–æ–∂–∫–∏...');
      const formDataUpload = new FormData();
      formDataUpload.append('file', coverImageFile);
      formDataUpload.append('folder', 'tours/covers');
      
      const uploadResponse = await fetch('/api/upload', {
        method: 'POST',
        body: formDataUpload,
      });
      
      if (!uploadResponse.ok) throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –æ–±–ª–æ–∂–∫—É');
      const { url } = await uploadResponse.json();
      coverImageUrl = url;
    }
    
    // 2. –°–æ–∑–¥–∞–Ω–∏–µ/–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç—É—Ä–∞
    setLoadingStatus(mode === 'create' ? '–°–æ–∑–¥–∞–Ω–∏–µ —Ç—É—Ä–∞...' : '–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç—É—Ä–∞...');
    const tourData = {
      ...formData,
      cover_image: coverImageUrl,
      price_per_person: parseFloat(formData.price_per_person),
      yandex_map_url: formData.yandex_map_url.trim() || null,
      description: formData.short_desc,
    };
    
    const response = await fetch('/api/admin/tours', {
      method: mode === 'create' ? 'POST' : 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(tourData),
    });
    
    if (!response.ok) throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ç—É—Ä');
    const result = await response.json();
    const tourId = mode === 'create' ? result.data.id : initialData.id;
    
    // 3. –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ —Ñ–æ—Ç–æ –∏ –≤–∏–¥–µ–æ
    const uploadPromises: Promise<any>[] = [];
    
    // –î–æ–±–∞–≤–ª—è–µ–º –≤—Å–µ —Ñ–æ—Ç–æ –≤ –æ—á–µ—Ä–µ–¥—å
    if (galleryFiles.length > 0) {
      setLoadingStatus(`–ó–∞–≥—Ä—É–∑–∫–∞ ${galleryFiles.length} —Ñ–æ—Ç–æ...`);
      console.log('üöÄ –ù–∞—á–∞–ª–æ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ...');
      
      galleryFiles.forEach((file, index) => {
        console.log(`  üì§ –§–æ—Ç–æ ${index + 1}: ${file.name} (${(file.size / 1024 / 1024).toFixed(2)} MB)`);
        
        const formDataUpload = new FormData();
        formDataUpload.append('file', file);
        formDataUpload.append('folder', 'tours/gallery');
        formDataUpload.append('tourId', tourId);
        formDataUpload.append('mediaType', 'photo');
        
        uploadPromises.push(
          fetch('/api/upload', {
            method: 'POST',
            body: formDataUpload,
          }).then(res => {
            console.log(`‚úÖ –§–æ—Ç–æ ${index + 1} –∑–∞–≥—Ä—É–∂–µ–Ω–æ:`, res.status);
            return res;
          }).catch(err => {
            console.error(`‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ ${index + 1}:`, err);
            throw err;
          })
        );
      });
    }
    
    // –î–æ–±–∞–≤–ª—è–µ–º –≤—Å–µ –≤–∏–¥–µ–æ –≤ –æ—á–µ—Ä–µ–¥—å
    if (videoFiles.length > 0) {
      setLoadingStatus(`–ó–∞–≥—Ä—É–∑–∫–∞ ${videoFiles.length} –≤–∏–¥–µ–æ...`);
      console.log('üöÄ –ù–∞—á–∞–ª–æ –∑–∞–≥—Ä—É–∑–∫–∏ –≤–∏–¥–µ–æ...');
      
      videoFiles.forEach((file, index) => {
        console.log(`  üì§ –í–∏–¥–µ–æ ${index + 1}: ${file.name} (${(file.size / 1024 / 1024).toFixed(2)} MB)`);
        
        const formDataUpload = new FormData();
        formDataUpload.append('file', file);
        formDataUpload.append('folder', 'tours/videos');
        formDataUpload.append('tourId', tourId);
        formDataUpload.append('mediaType', 'video');
        
        uploadPromises.push(
          fetch('/api/upload', {
            method: 'POST',
            body: formDataUpload,
          }).then(res => {
            console.log(`‚úÖ –í–∏–¥–µ–æ ${index + 1} –∑–∞–≥—Ä—É–∂–µ–Ω–æ:`, res.status);
            return res;
          }).catch(err => {
            console.error(`‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≤–∏–¥–µ–æ ${index + 1}:`, err);
            throw err;
          })
        );
      });
    }
    
    // –ó–∞–≥—Ä—É–∂–∞–µ–º –≤—Å–µ —Ñ–∞–π–ª—ã –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ
    if (uploadPromises.length > 0) {
      setLoadingStatus(`–ó–∞–≥—Ä—É–∑–∫–∞ ${uploadPromises.length} —Ñ–∞–π–ª–æ–≤...`);
      console.log(`‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–≥—Ä—É–∑–∫–∏ ${uploadPromises.length} —Ñ–∞–π–ª–æ–≤...`);
      
      try {
        await Promise.all(uploadPromises);
        console.log('‚úÖ –í—Å–µ —Ñ–∞–π–ª—ã —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω—ã!');
      } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ñ–∞–π–ª–æ–≤:', error);
        throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –º–µ–¥–∏–∞—Ñ–∞–π–ª—ã');
      }
    }
    
    setLoadingStatus('–ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ...');
    router.push('/admin/tours');
    router.refresh();
  } catch (error: any) {
    console.error('Error saving tour:', error);
    alert(error.message || '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ç—É—Ä');
  } finally {
    setLoading(false);
    setLoadingStatus('');
  }
};
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- ‚ö° –ó–∞–≥—Ä—É–∑–∫–∞ 5 —Ñ–æ—Ç–æ + 2 –≤–∏–¥–µ–æ: **~2 —Å–µ–∫—É–Ω–¥—ã** (–±—ã–ª–æ ~15 —Å–µ–∫—É–Ω–¥)
- üìä –°—Ç–∞—Ç—É—Å –∑–∞–≥—Ä—É–∑–∫–∏ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏: "–ó–∞–≥—Ä—É–∑–∫–∞ 7 —Ñ–∞–π–ª–æ–≤..."
- üîç –î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–∞–∂–¥–æ–≥–æ —Ñ–∞–π–ª–∞

#### 4. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ RLS –ø–æ–ª–∏—Ç–∏–∫ tour_media

**–§–∞–π–ª:** `supabase/migrations/007_fix_tour_media_rls.sql`

**–ü—Ä–æ–±–ª–µ–º–∞:**
–ú–µ–¥–∏–∞ –æ—Ç–æ–±—Ä–∞–∂–∞–ª–æ—Å—å —Ç–æ–ª—å–∫–æ –¥–ª—è —Ç—É—Ä–æ–≤ —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º `published`, –Ω–æ —Ç–µ—Å—Ç–æ–≤—ã–µ —Ç—É—Ä—ã –∏–º–µ–ª–∏ —Å—Ç–∞—Ç—É—Å `active`.

**–†–µ—à–µ–Ω–∏–µ:**
```sql
-- 1. –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—É—é –ø–æ–ª–∏—Ç–∏–∫—É SELECT
DROP POLICY IF EXISTS "Anyone can view media of published tours" ON tour_media;

-- 2. –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é –ø–æ–ª–∏—Ç–∏–∫—É –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –º–µ–¥–∏–∞
CREATE POLICY "Anyone can view media of active tours"
  ON tour_media FOR SELECT
  USING (
    EXISTS (
      SELECT 1 FROM tours
      WHERE tours.id = tour_media.tour_id
      AND tours.status IN ('active', 'published')
    )
  );

-- 3. –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–ª–∏—Ç–∏–∫—É –¥–ª—è service role
CREATE POLICY "Service role can insert media"
  ON tour_media FOR INSERT
  WITH CHECK (true);
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- ‚úÖ –ú–µ–¥–∏–∞ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –¥–ª—è —Ç—É—Ä–æ–≤ —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º `active` –∏ `published`
- ‚úÖ Service role –º–æ–∂–µ—Ç –≤—Å—Ç–∞–≤–ª—è—Ç—å –º–µ–¥–∏–∞ –±–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π

#### 5. –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏—Ö –∫–æ–ª–æ–Ω–æ–∫ –≤ tour_media

**–§–∞–π–ª:** `supabase/migrations/008_add_tour_media_columns.sql`

**–ü—Ä–æ–±–ª–µ–º–∞:**
```
‚ùå Could not find the 'file_name' column of 'tour_media' in the schema cache
```

API –ø—ã—Ç–∞–ª—Å—è —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å `file_name`, `file_size`, `mime_type`, –Ω–æ —ç—Ç–∏—Ö –∫–æ–ª–æ–Ω–æ–∫ –Ω–µ –±—ã–ª–æ –≤ —Ç–∞–±–ª–∏—Ü–µ.

**–†–µ—à–µ–Ω–∏–µ:**
```sql
-- –î–æ–±–∞–≤–ª—è–µ–º –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏–µ –∫–æ–ª–æ–Ω–∫–∏
ALTER TABLE tour_media 
ADD COLUMN IF NOT EXISTS file_name TEXT,
ADD COLUMN IF NOT EXISTS file_size BIGINT,
ADD COLUMN IF NOT EXISTS mime_type TEXT;

-- –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏
COMMENT ON COLUMN tour_media.file_name IS '–û—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–µ –∏–º—è –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞';
COMMENT ON COLUMN tour_media.file_size IS '–†–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞ –≤ –±–∞–π—Ç–∞—Ö';
COMMENT ON COLUMN tour_media.mime_type IS 'MIME-—Ç–∏–ø —Ñ–∞–π–ª–∞ (image/jpeg, video/mp4 –∏ —Ç.–¥.)';
```

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞ tour_media (–∞–∫—Ç—É–∞–ª—å–Ω–∞—è):**
```
tour_media
‚îú‚îÄ‚îÄ id                UUID PRIMARY KEY
‚îú‚îÄ‚îÄ tour_id           UUID NOT NULL ‚Üí tours(id)
‚îú‚îÄ‚îÄ media_type        TEXT NOT NULL (photo/video)
‚îú‚îÄ‚îÄ media_url         TEXT NOT NULL (–ø—É–±–ª–∏—á–Ω—ã–π URL)
‚îú‚îÄ‚îÄ media_path        TEXT NOT NULL (S3 –ø—É—Ç—å)
‚îú‚îÄ‚îÄ file_name         TEXT (–æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–µ –∏–º—è —Ñ–∞–π–ª–∞) ‚ú® NEW
‚îú‚îÄ‚îÄ file_size         BIGINT (—Ä–∞–∑–º–µ—Ä –≤ –±–∞–π—Ç–∞—Ö) ‚ú® NEW
‚îú‚îÄ‚îÄ mime_type         TEXT (MIME-—Ç–∏–ø) ‚ú® NEW
‚îú‚îÄ‚îÄ created_at        TIMESTAMP
‚îî‚îÄ‚îÄ updated_at        TIMESTAMP
```

#### 6. –î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≥—Ä—É–∑–∫–∏ –º–µ–¥–∏–∞

**–§–∞–π–ª:** `app/api/upload/route.ts`

–î–æ–±–∞–≤–ª–µ–Ω–æ –ø–æ–¥—Ä–æ–±–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ—Ü–µ—Å—Å–∞ –∑–∞–≥—Ä—É–∑–∫–∏:

```tsx
// –ï—Å–ª–∏ —É–∫–∞–∑–∞–Ω tourId –∏ mediaType - —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤ tour_media
if (tourId && mediaType) {
  console.log('üíæ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –º–µ–¥–∏–∞ –≤ –ë–î:', {
    tour_id: tourId,
    media_type: mediaType,
    file_name: file.name,
  });
  
  const { data: mediaData, error: mediaError } = await serviceClient
    .from('tour_media')
    .insert({
      tour_id: tourId,
      media_type: mediaType,
      media_url: fileUrl,
      media_path: s3Path,
      file_name: file.name,
      file_size: file.size,
      mime_type: file.type,
    })
    .select();
  
  if (mediaError) {
    console.error('‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –º–µ–¥–∏–∞ –≤ –ë–î:', mediaError);
  } else {
    console.log('‚úÖ –ú–µ–¥–∏–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ –≤ –ë–î:', mediaData);
  }
} else {
  console.log('‚ö†Ô∏è –ü—Ä–æ–ø—É—Å–∫ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ –ë–î (–Ω–µ—Ç tourId –∏–ª–∏ mediaType)');
}
```

**–§–∞–π–ª:** `app/tours/[slug]/page.tsx`

–î–æ–±–∞–≤–ª–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≥—Ä—É–∑–∫–∏ –º–µ–¥–∏–∞ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞:

```tsx
const { data: media, error: mediaError } = await supabase
  .from('tour_media')
  .select('*')
  .eq('tour_id', tour.id)
  .order('created_at', { ascending: true });

console.log('üì∏ –ú–µ–¥–∏–∞ –¥–ª—è —Ç—É—Ä–∞', tour.id, ':', media);
if (mediaError) console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–µ–¥–∏–∞:', mediaError);

const photos = media?.filter((m) => m.media_type === 'photo') || [];
const videos = media?.filter((m) => m.media_type === 'video') || [];

console.log('üì∑ –§–æ—Ç–æ:', photos.length, 'üé¨ –í–∏–¥–µ–æ:', videos.length);
```

#### 7. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–∞–≥–∞ —Å role –≤ TourForm

**–§–∞–π–ª:** `components/admin/TourForm.tsx`

**–ü—Ä–æ–±–ª–µ–º–∞:**
–ü—Ä–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ —Ç—É—Ä–∞ –Ω–µ –ø–µ—Ä–µ–¥–∞–≤–∞–ª—Å—è `id`, –∏–∑-–∑–∞ —á–µ–≥–æ PUT –∑–∞–ø—Ä–æ—Å –Ω–µ –º–æ–≥ –æ–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ.

**–†–µ—à–µ–Ω–∏–µ:**
```tsx
const [formData, setFormData] = useState<TourFormData>({
  id: initialData?.id || null, // ‚úÖ –î–æ–±–∞–≤–∏–ª–∏ ID
  title: initialData?.title || '',
  slug: initialData?.slug || '',
  short_desc: initialData?.short_desc || '',
  // ...
});
```

### –ú–∞—Ä—à—Ä—É—Ç—ã –∏—Ç–µ—Ä–∞—Ü–∏–∏ 11

```
/admin/tours/[id]/edit        ‚Üê –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç—É—Ä–∞
PUT /api/admin/tours          ‚Üê API –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç—É—Ä–∞
POST /api/upload              ‚Üê –ó–∞–≥—Ä—É–∑–∫–∞ –º–µ–¥–∏–∞ (—Å –ª–æ–≥–∞–º–∏)
```

### Git –∫–æ–º–º–∏—Ç—ã –∏—Ç–µ—Ä–∞—Ü–∏–∏ 11

```
[e8e4125] - fix: –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç—É—Ä–æ–≤, –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –º–µ–¥–∏–∞, –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è RLS
            - –î–æ–±–∞–≤–ª–µ–Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ /admin/tours/[id]/edit
            - –î–æ–±–∞–≤–ª–µ–Ω PUT –º–µ—Ç–æ–¥ –≤ /api/admin/tours
            - –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –º–µ–¥–∏–∞ —á–µ—Ä–µ–∑ Promise.all
            - –ò—Å–ø—Ä–∞–≤–ª–µ–Ω—ã RLS –ø–æ–ª–∏—Ç–∏–∫–∏ tour_media (active + published)
            - –î–æ–±–∞–≤–ª–µ–Ω—ã –∫–æ–ª–æ–Ω–∫–∏ file_name, file_size, mime_type
            - –î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö —ç—Ç–∞–ø–æ–≤ –∑–∞–≥—Ä—É–∑–∫–∏
```

### –ü—Ä–æ–±–ª–µ–º—ã –∏ —Ä–µ—à–µ–Ω–∏—è

| –ü—Ä–æ–±–ª–µ–º–∞ | –†–µ—à–µ–Ω–∏–µ | –†–µ–∑—É–ª—å—Ç–∞—Ç |
|----------|---------|-----------|
| –ù–µ—Ç —Å—Ç—Ä–∞–Ω–∏—Ü—ã —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è | –°–æ–∑–¥–∞–Ω `/admin/tours/[id]/edit/page.tsx` | ‚úÖ –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç |
| –ù–µ—Ç PUT API endpoint | –î–æ–±–∞–≤–ª–µ–Ω PUT –≤ `/api/admin/tours/route.ts` | ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç—É—Ä–æ–≤ —Ä–∞–±–æ—Ç–∞–µ—Ç |
| –ú–µ–¥–ª–µ–Ω–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –º–µ–¥–∏–∞ | –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ —á–µ—Ä–µ–∑ `Promise.all` | ‚ö° –í 7-10 —Ä–∞–∑ –±—ã—Å—Ç—Ä–µ–µ |
| –ú–µ–¥–∏–∞ –Ω–µ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è | –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ RLS –ø–æ–ª–∏—Ç–∏–∫–∞ (active + published) | ‚úÖ –ú–µ–¥–∏–∞ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è |
| –û—à–∏–±–∫–∞ `file_name column not found` | –î–æ–±–∞–≤–ª–µ–Ω—ã –∫–æ–ª–æ–Ω–∫–∏ –≤ tour_media | ‚úÖ –ú–µ–¥–∏–∞ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ –ë–î |
| –ù–µ–ø–æ–Ω—è—Ç–Ω–æ –≥–¥–µ –æ—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ | –î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö —ç—Ç–∞–ø–æ–≤ | üîç –õ–µ–≥–∫–æ –Ω–∞—Ö–æ–¥–∏—Ç—å –ø—Ä–æ–±–ª–µ–º—ã |

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ –∏ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–æ

---

---

## üìù –ò—Å—Ç–æ—Ä–∏—è –≤–µ—Ä—Å–∏–π

### –í–µ—Ä—Å–∏—è 2.6.0 (–¢–µ–∫—É—â–∞—è) - –°–∏—Å—Ç–µ–º–∞ –æ–ø–ª–∞—Ç—ã –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è–º–∏

**–î–∞—Ç–∞:** –î–µ–∫–∞–±—Ä—å 2024

**–ù–æ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:**
- ‚úÖ –°–∏—Å—Ç–µ–º–∞ –≤—ã–±–æ—Ä–∞ —Å–ø–æ—Å–æ–±–∞ –æ–ø–ª–∞—Ç—ã (–∫–∞—Ä—Ç–∞, –Ω–∞–ª–∏—á–Ω—ã–µ, QR-–∫–æ–¥)
- ‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–∞—Ä—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (–±–µ–∑–æ–ø–∞—Å–Ω–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö 4 —Ü–∏—Ñ—Ä)
- ‚úÖ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è PDF –±–∏–ª–µ—Ç–æ–≤ —Å –ª–æ–≥–æ—Ç–∏–ø–æ–º –∏ –Ω–∞–∑–≤–∞–Ω–∏–µ–º —Å–∞–π—Ç–∞
- ‚úÖ –°—Ç—Ä–∞–Ω–∏—Ü–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è–º–∏ –≤ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏
- ‚úÖ –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –∏ –ø–æ–∏—Å–∫ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π
- ‚úÖ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞–º–∏ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –∏ –æ–ø–ª–∞—Ç—ã
- ‚úÖ –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π –≤ –ø—Ä–æ—Ñ–∏–ª–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—è "–≥–æ—Ä–æ–¥" –≤ —Ç—É—Ä—ã —Å —É–º–Ω—ã–º –ø–æ–∏—Å–∫–æ–º
- ‚úÖ –í–∏–¥–µ–æ–ø–ª–µ–µ—Ä Plyr –¥–ª—è –≤–∏–¥–µ–æ —Ç—É—Ä–æ–≤

**–ú–∏–≥—Ä–∞—Ü–∏–∏:**
- `010_add_cities.sql` - –¢–∞–±–ª–∏—Ü–∞ –≥–æ—Ä–æ–¥–æ–≤ –¢–∞—Ç–∞—Ä—Å—Ç–∞–Ω–∞
- `011_booking_payment_system.sql` - –°–∏—Å—Ç–µ–º–∞ –æ–ø–ª–∞—Ç—ã –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –∫–∞—Ä—Ç

**API Endpoints:**
- `POST /api/bookings` - –°–æ–∑–¥–∞–Ω–∏–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è —Å –≤—ã–±–æ—Ä–æ–º —Å–ø–æ—Å–æ–±–∞ –æ–ø–ª–∞—Ç—ã
- `GET /api/user/bookings` - –ü–æ–ª—É—á–µ–Ω–∏–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- `GET /api/user/cards` - –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –∫–∞—Ä—Ç
- `POST /api/user/cards` - –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –Ω–æ–≤–æ–π –∫–∞—Ä—Ç—ã
- `DELETE /api/user/cards/[id]` - –£–¥–∞–ª–µ–Ω–∏–µ –∫–∞—Ä—Ç—ã
- `PATCH /api/user/cards/[id]` - –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞—Ä—Ç—ã
- `GET /api/admin/bookings` - –°–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π (–∞–¥–º–∏–Ω)
- `PATCH /api/admin/bookings/[id]` - –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–æ–≤ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è

**–ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:**

#### 1. BookingForm.tsx - –§–æ—Ä–º–∞ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è —Å –≤—ã–±–æ—Ä–æ–º –æ–ø–ª–∞—Ç—ã

**–§–∞–π–ª:** `components/booking/BookingForm.tsx`

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –î–≤—É—Ö—à–∞–≥–æ–≤–∞—è —Ñ–æ—Ä–º–∞ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è —Å –≤—ã–±–æ—Ä–æ–º —Å–ø–æ—Å–æ–±–∞ –æ–ø–ª–∞—Ç—ã

**–ß—Ç–æ –¥–µ–ª–∞–µ—Ç:**
- –®–∞–≥ 1: –í—ã–±–æ—Ä –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
- –®–∞–≥ 2: –í—ã–±–æ—Ä —Å–ø–æ—Å–æ–±–∞ –æ–ø–ª–∞—Ç—ã (–∫–∞—Ä—Ç–∞/–Ω–∞–ª–∏—á–Ω—ã–µ/QR-–∫–æ–¥)
- –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –∫–∞—Ä—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- –í–≤–æ–¥ –¥–∞–Ω–Ω—ã—Ö –Ω–æ–≤–æ–π –∫–∞—Ä—Ç—ã —Å –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π
- –û–ø—Ü–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∫–∞—Ä—Ç—ã –¥–ª—è –±—É–¥—É—â–∏—Ö –ø–æ–∫—É–ø–æ–∫
- –û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–∞ —Å–µ—Ä–≤–µ—Ä –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è

**–ö–ª—é—á–µ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:**

```typescript
// –°–æ—Å—Ç–æ—è–Ω–∏–µ —Ñ–æ—Ä–º—ã
const [formData, setFormData] = useState({
  num_people: 1,
  payment_method: 'card' as PaymentMethod,
  selected_card_id: savedCards.find(c => c.is_default)?.id || null,
  new_card: {
    number: '',      // –ù–æ–º–µ—Ä –∫–∞—Ä—Ç—ã (—Ñ–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)
    expiry: '',      // –°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è (MM/YY)
    cvv: '',         // CVV –∫–æ–¥
    cardholder_name: '', // –ò–º—è –¥–µ—Ä–∂–∞—Ç–µ–ª—è
    save: false,     // –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–∞—Ä—Ç—É?
  },
});

// –í–∞–ª–∏–¥–∞—Ü–∏—è —Ñ–æ—Ä–º—ã
const validateForm = () => {
  // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
  if (formData.num_people < 1 || formData.num_people > availableSpots) {
    setError(`–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –æ—Ç 1 –¥–æ ${availableSpots}`);
    return false;
  }

  // –ï—Å–ª–∏ –≤—ã–±—Ä–∞–Ω–∞ –∫–∞—Ä—Ç–∞ - –ø—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –¥–∞–Ω–Ω—ã—Ö
  if (formData.payment_method === 'card') {
    if (!formData.selected_card_id && !formData.new_card.number) {
      setError('–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ä—Ç—É –∏–ª–∏ –≤–≤–µ–¥–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –Ω–æ–≤–æ–π –∫–∞—Ä—Ç—ã');
      return false;
    }
  }
  return true;
};

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
const handleBooking = async () => {
  const bookingData = {
    tour_id: tour.id,
    num_people: formData.num_people,
    total_price: totalPrice,
    payment_method: formData.payment_method,
    payment_data: {
      // –ï—Å–ª–∏ –≤—ã–±—Ä–∞–Ω–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–∞—è –∫–∞—Ä—Ç–∞
      card_id: formData.selected_card_id,
      // –ò–ª–∏ –¥–∞–Ω–Ω—ã–µ –Ω–æ–≤–æ–π –∫–∞—Ä—Ç—ã
      card_type: getCardType(formData.new_card.number),
      last_four_digits: formData.new_card.number.slice(-4),
    },
    save_card: formData.new_card.save ? { ... } : null,
  };

  const response = await fetch('/api/bookings', {
    method: 'POST',
    body: JSON.stringify(bookingData),
  });
  
  router.push(`/booking/success?id=${result.booking.id}`);
};
```

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
- –ê–≤—Ç–æ—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–æ–º–µ—Ä–∞ –∫–∞—Ä—Ç—ã (–¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–±–µ–ª–æ–≤ –∫–∞–∂–¥—ã–µ 4 —Ü–∏—Ñ—Ä—ã)
- –ê–≤—Ç–æ—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ä–æ–∫–∞ –¥–µ–π—Å—Ç–≤–∏—è (MM/YY)
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ç–∏–ø–∞ –∫–∞—Ä—Ç—ã (Visa/Mastercard/Mir)
- –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Å–µ—Ö –ø–æ–ª–µ–π –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π
- –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ —Å –ø–æ–Ω—è—Ç–Ω—ã–º–∏ —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏

#### 2. UserBookings.tsx - –°–ø–∏—Å–æ–∫ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

**–§–∞–π–ª:** `components/profile/UserBookings.tsx`

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤—Å–µ—Ö –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –ø—Ä–æ—Ñ–∏–ª–µ —Å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å—é —Å–∫–∞—á–∞—Ç—å –±–∏–ª–µ—Ç

**–ß—Ç–æ –¥–µ–ª–∞–µ—Ç:**
- –ó–∞–≥—Ä—É–∂–∞–µ—Ç –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —á–µ—Ä–µ–∑ API
- –û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç –∫–∞—Ä—Ç–æ—á–∫–∏ —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –∫–∞–∂–¥–æ–º –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–∏
- –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å—Ç–∞—Ç—É—Å –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è —Å —Ü–≤–µ—Ç–æ–≤–æ–π –∏–Ω–¥–∏–∫–∞—Ü–∏–µ–π
- –ü—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –∫–Ω–æ–ø–∫—É —Å–∫–∞—á–∏–≤–∞–Ω–∏—è PDF –±–∏–ª–µ—Ç–∞
- –°—Å—ã–ª–∫–∏ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã —Ç—É—Ä–æ–≤

**–ö–ª—é—á–µ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:**

```typescript
// –ó–∞–≥—Ä—É–∑–∫–∞ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π
useEffect(() => {
  const loadBookings = async () => {
    const response = await fetch('/api/user/bookings');
    const data = await response.json();
    setBookings(data.bookings);
  };
  loadBookings();
}, []);

// –ì–µ–Ω–µ—Ä–∞—Ü–∏—è PDF –±–∏–ª–µ—Ç–∞
const handleDownloadTicket = async (booking: Booking) => {
  setGeneratingPDF(booking.id);
  try {
    await generateTicketPDF(booking); // lib/pdf/ticket.ts
  } catch (error) {
    alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –±–∏–ª–µ—Ç');
  } finally {
    setGeneratingPDF(null);
  }
};

// –ü–æ–ª—É—á–µ–Ω–∏–µ —Ü–≤–µ—Ç–∞ —Å—Ç–∞—Ç—É—Å–∞
const getStatusColor = (status: string) => {
  const colors = {
    pending: 'bg-yellow-100 text-yellow-800',
    confirmed: 'bg-green-100 text-green-800',
    cancelled: 'bg-red-100 text-red-800',
    completed: 'bg-blue-100 text-blue-800',
  };
  return colors[status] || 'bg-gray-100 text-gray-800';
};
```

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
- –ö–Ω–æ–ø–∫–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è –±–∏–ª–µ—Ç–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –¥–ª—è –≤—Å–µ—Ö —Å—Ç–∞—Ç—É—Å–æ–≤ –∫—Ä–æ–º–µ –æ—Ç–º–µ–Ω–µ–Ω–Ω—ã—Ö
- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ PDF
- –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–π –¥–∏–∑–∞–π–Ω –∫–∞—Ä—Ç–æ—á–µ–∫
- –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞—Ç –∏ —Ü–µ–Ω

#### 3. BookingsList.tsx - –°–ø–∏—Å–æ–∫ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π –≤ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏

**–§–∞–π–ª:** `components/admin/BookingsList.tsx`

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤—Å–µ–º–∏ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è–º–∏ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤

**–ß—Ç–æ –¥–µ–ª–∞–µ—Ç:**
- –û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç —Ç–∞–±–ª–∏—Ü—É –≤—Å–µ—Ö –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π
- –ü–æ–∏—Å–∫ –ø–æ –∏–º–µ–Ω–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, email –∏–ª–∏ –Ω–∞–∑–≤–∞–Ω–∏—é —Ç—É—Ä–∞
- –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ —Å—Ç–∞—Ç—É—Å—É –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –∏ –æ–ø–ª–∞—Ç—ã
- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞: –≤—Å–µ–≥–æ, –æ–∂–∏–¥–∞—é—Ç, –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ, –æ–ø–ª–∞—á–µ–Ω–æ
- –°—Å—ã–ª–∫–∏ –Ω–∞ –¥–µ—Ç–∞–ª—å–Ω—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä –∫–∞–∂–¥–æ–≥–æ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è

**–ö–ª—é—á–µ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:**

```typescript
// –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π
const filteredBookings = bookings.filter((booking) => {
  // –ü–æ–∏—Å–∫ –ø–æ —Ç–µ–∫—Å—Ç—É
  const matchesSearch = 
    booking.user?.first_name?.toLowerCase().includes(searchQuery.toLowerCase()) ||
    booking.user?.last_name?.toLowerCase().includes(searchQuery.toLowerCase()) ||
    booking.user?.email?.toLowerCase().includes(searchQuery.toLowerCase()) ||
    booking.tour?.title?.toLowerCase().includes(searchQuery.toLowerCase());
  
  // –§–∏–ª—å—Ç—Ä –ø–æ —Å—Ç–∞—Ç—É—Å—É
  const matchesStatus = statusFilter === 'all' || booking.status === statusFilter;
  
  // –§–∏–ª—å—Ç—Ä –ø–æ –æ–ø–ª–∞—Ç–µ
  const matchesPayment = paymentFilter === 'all' || booking.payment_status === paymentFilter;

  return matchesSearch && matchesStatus && matchesPayment;
});

// –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
const stats = {
  total: bookings.length,
  pending: bookings.filter(b => b.status === 'pending').length,
  confirmed: bookings.filter(b => b.status === 'confirmed').length,
  paid: bookings.filter(b => b.payment_status === 'paid').length,
};
```

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
- –†–µ–∞–ª-—Ç–∞–π–º —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –±–µ–∑ –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ —Å–µ—Ä–≤–µ—Ä—É
- –¶–≤–µ—Ç–æ–≤–∞—è –∏–Ω–¥–∏–∫–∞—Ü–∏—è —Å—Ç–∞—Ç—É—Å–æ–≤
- –ò–∫–æ–Ω–∫–∏ —Å–ø–æ—Å–æ–±–æ–≤ –æ–ø–ª–∞—Ç—ã
- –ê–¥–∞–ø—Ç–∏–≤–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ —Å –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–º —Å–∫—Ä–æ–ª–ª–æ–º –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö

#### 4. BookingDetails.tsx - –î–µ—Ç–∞–ª—å–Ω—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è

**–§–∞–π–ª:** `components/admin/BookingDetails.tsx`

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –î–µ—Ç–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–∏ —Å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å—é –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–æ–≤

**–ß—Ç–æ –¥–µ–ª–∞–µ—Ç:**
- –û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç –ø–æ–ª–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–∏
- –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ —Ç—É—Ä–∞
- –°–ø–∏—Å–æ–∫ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ (–µ—Å–ª–∏ –µ—Å—Ç—å)
- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞–º–∏ —á–µ—Ä–µ–∑ –≤—ã–ø–∞–¥–∞—é—â–∏–µ —Å–ø–∏—Å–∫–∏
- –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–æ–≤ —á–µ—Ä–µ–∑ API

**–ö–ª—é—á–µ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:**

```typescript
// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
const updateStatus = async (newStatus: string) => {
  if (newStatus === booking.status) return;
  
  if (!confirm(`–ò–∑–º–µ–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å –Ω–∞ "${getStatusLabel(newStatus)}"?`)) {
    return;
  }

  setLoading(true);
  try {
    const response = await fetch(`/api/admin/bookings/${booking.id}`, {
      method: 'PATCH',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ status: newStatus }),
    });
    
    router.refresh(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É
  } catch (err) {
    setError(err.message);
  } finally {
    setLoading(false);
  }
};

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –æ–ø–ª–∞—Ç—ã
const updatePaymentStatus = async (newStatus: string) => {
  // –ê–Ω–∞–ª–æ–≥–∏—á–Ω–æ updateStatus, –Ω–æ –¥–ª—è payment_status
};
```

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
- –í—ã–ø–∞–¥–∞—é—â–∏–µ —Å–ø–∏—Å–∫–∏ –¥–ª—è –≤—ã–±–æ—Ä–∞ —Å—Ç–∞—Ç—É—Å–æ–≤
- –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø–µ—Ä–µ–¥ –∏–∑–º–µ–Ω–µ–Ω–∏–µ–º
- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –ø–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è

#### 5. ticket.ts - –ì–µ–Ω–µ—Ä–∞—Ü–∏—è PDF –±–∏–ª–µ—Ç–æ–≤

**–§–∞–π–ª:** `lib/pdf/ticket.ts`

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫—Ä–∞—Å–∏–≤—ã—Ö PDF –±–∏–ª–µ—Ç–æ–≤ —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π —Ä—É—Å—Å–∫–æ–≥–æ —è–∑—ã–∫–∞

**–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç:**
1. –°–æ–∑–¥–∞–µ—Ç—Å—è –≤—Ä–µ–º–µ–Ω–Ω—ã–π HTML —ç–ª–µ–º–µ–Ω—Ç —Å –¥–∏–∑–∞–π–Ω–æ–º –±–∏–ª–µ—Ç–∞
2. –ó–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –ª–æ–≥–æ—Ç–∏–ø —Å–∞–π—Ç–∞ –∏ –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç—Å—è –≤ base64
3. HTML —Ä–µ–Ω–¥–µ—Ä–∏—Ç—Å—è –≤ Canvas —á–µ—Ä–µ–∑ `html2canvas`
4. Canvas –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç—Å—è –≤ PDF —á–µ—Ä–µ–∑ `jsPDF`
5. PDF —Å–∫–∞—á–∏–≤–∞–µ—Ç—Å—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º

**–ö–ª—é—á–µ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:**

```typescript
export async function generateTicketPDF(booking: Booking) {
  // 1. –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —ç–ª–µ–º–µ–Ω—Ç
  const ticketElement = document.createElement('div');
  ticketElement.style.width = '794px'; // A4 width
  ticketElement.style.padding = '40px';
  
  // 2. –ó–∞–≥—Ä—É–∂–∞–µ–º –ª–æ–≥–æ—Ç–∏–ø
  let logoBase64 = '';
  try {
    const logoResponse = await fetch('/logo.svg');
    const logoBlob = await logoResponse.blob();
    logoBase64 = await new Promise((resolve) => {
      const reader = new FileReader();
      reader.onloadend = () => resolve(reader.result as string);
      reader.readAsDataURL(logoBlob);
    });
  } catch (error) {
    console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –ª–æ–≥–æ—Ç–∏–ø');
  }

  // 3. –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º HTML
  ticketElement.innerHTML = `
    <div style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
      <!-- –®–∞–ø–∫–∞ —Å –ª–æ–≥–æ—Ç–∏–ø–æ–º -->
      ${logoBase64 ? `<img src="${logoBase64}" />` : ''}
      <h1>–ë–ò–õ–ï–¢ –ù–ê –¢–£–†</h1>
      <div>–¢—É—Ä—ã –ø–æ –¢–∞—Ç–∞—Ä—Å—Ç–∞–Ω—É</div>
      
      <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç—É—Ä–µ -->
      <div style="background: white;">
        <h2>${booking.tour.title}</h2>
        <!-- –ö–∞—Ä—Ç–æ—á–∫–∏ —Å –¥–∞–Ω–Ω—ã–º–∏ -->
      </div>
      
      <!-- –ù–æ–º–µ—Ä –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è -->
      <!-- –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è -->
      <!-- –§—É—Ç–µ—Ä -->
    </div>
  `;

  document.body.appendChild(ticketElement);

  // 4. –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤ Canvas
  const canvas = await html2canvas(ticketElement, {
    scale: 2,
    useCORS: true,
    backgroundColor: '#ffffff',
    height: ticketElement.scrollHeight,
  });

  // 5. –°–æ–∑–¥–∞–µ–º PDF
  const pdf = new jsPDF({ orientation: 'portrait', unit: 'mm', format: 'a4' });
  const imgWidth = 210; // A4 width in mm
  const pageHeight = 297; // A4 height in mm
  const imgHeight = (canvas.height * imgWidth) / canvas.width;
  
  // –ï—Å–ª–∏ –ø–æ–º–µ—â–∞–µ—Ç—Å—è –Ω–∞ –æ–¥–Ω—É —Å—Ç—Ä–∞–Ω–∏—Ü—É
  if (imgHeight <= pageHeight) {
    pdf.addImage(canvas.toDataURL('image/png'), 'PNG', 0, 0, imgWidth, imgHeight);
  } else {
    // –†–∞–∑–±–∏–≤–∞–µ–º –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    // ...
  }

  // 6. –°–æ—Ö—Ä–∞–Ω—è–µ–º
  pdf.save(`–ë–∏–ª–µ—Ç_${booking.tour.title.substring(0, 20)}_${booking.id.substring(0, 8)}.pdf`);
  
  // 7. –£–¥–∞–ª—è–µ–º —ç–ª–µ–º–µ–Ω—Ç
  document.body.removeChild(ticketElement);
}
```

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
- ‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Ä—É—Å—Å–∫–æ–≥–æ —è–∑—ã–∫–∞ —á–µ—Ä–µ–∑ HTML (–Ω–µ —Ç—Ä–µ–±—É–µ—Ç –∫–∞—Å—Ç–æ–º–Ω—ã—Ö —à—Ä–∏—Ñ—Ç–æ–≤)
- ‚úÖ –õ–æ–≥–æ—Ç–∏–ø —Å–∞–π—Ç–∞ –≤—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è –≤ –±–∏–ª–µ—Ç
- ‚úÖ –ì—Ä–∞–¥–∏–µ–Ω—Ç–Ω—ã–π –¥–∏–∑–∞–π–Ω —Å –∫–∞—Ä—Ç–æ—á–∫–∞–º–∏
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Ä–∞–∑–±–∏–µ–Ω–∏–µ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
- ‚úÖ –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –æ—Ç—Å—Ç—É–ø—ã —á—Ç–æ–±—ã —Ñ—É—Ç–µ—Ä –Ω–µ –ø–µ—Ä–µ–Ω–æ—Å–∏–ª—Å—è

#### 6. API Endpoints - –î–µ—Ç–∞–ª—å–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ

**POST /api/bookings** - –°–æ–∑–¥–∞–Ω–∏–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è

**–§–∞–π–ª:** `app/api/bookings/route.ts`

**–ß—Ç–æ –¥–µ–ª–∞–µ—Ç:**
- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- –í–∞–ª–∏–¥–∏—Ä—É–µ—Ç –¥–∞–Ω–Ω—ã–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —Ç—É—Ä–∞
- –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –∫–∞—Ä—Ç—É –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ö–æ—á–µ—Ç
- –°–æ–∑–¥–∞–µ—Ç –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ –ë–î
- –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–æ–∑–¥–∞–Ω–Ω–æ–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ

**–ö–æ–¥:**

```typescript
export async function POST(request: NextRequest) {
  // 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
  const { data: { user } } = await supabase.auth.getUser();
  if (!user) {
    return NextResponse.json({ error: '–ù–µ–æ–±—Ö–æ–¥–∏–º–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è' }, { status: 401 });
  }

  // 2. –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
  const { tour_id, num_people, total_price, payment_method, payment_data, save_card } = 
    await request.json();

  // 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ —Ç—É—Ä–∞
  const { data: tour } = await serviceClient
    .from('tours')
    .select('max_participants, current_participants, status')
    .eq('id', tour_id)
    .single();

  const availableSpots = tour.max_participants - (tour.current_participants || 0);
  if (num_people > availableSpots) {
    return NextResponse.json(
      { error: `–î–æ—Å—Ç—É–ø–Ω–æ —Ç–æ–ª—å–∫–æ ${availableSpots} –º–µ—Å—Ç` },
      { status: 400 }
    );
  }

  // 4. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–∞—Ä—Ç—ã –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
  let cardId = null;
  if (save_card && payment_data && !payment_data.card_id) {
    if (save_card.is_default) {
      // –°–Ω–∏–º–∞–µ–º default —Å –¥—Ä—É–≥–∏—Ö –∫–∞—Ä—Ç
      await supabase
        .from('user_cards')
        .update({ is_default: false })
        .eq('user_id', user.id)
        .eq('is_default', true);
    }

    const { data: newCard } = await supabase
      .from('user_cards')
      .insert({
        user_id: user.id,
        last_four_digits: save_card.last_four_digits,
        card_type: save_card.card_type,
        cardholder_name: save_card.cardholder_name,
        is_default: save_card.is_default,
      })
      .select()
      .single();
    
    cardId = newCard?.id;
  }

  // 5. –°–æ–∑–¥–∞–Ω–∏–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
  const { data: booking } = await serviceClient
    .from('bookings')
    .insert({
      user_id: user.id,
      tour_id,
      num_people,
      total_price,
      payment_method,
      payment_status: payment_method === 'cash' ? 'pending' : 'pending',
      payment_data: {
        ...payment_data,
        card_id: cardId || payment_data?.card_id || null,
      },
      status: 'pending',
    })
    .select()
    .single();

  return NextResponse.json({ success: true, booking });
}
```

**GET /api/user/bookings** - –ü–æ–ª—É—á–µ–Ω–∏–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

**–§–∞–π–ª:** `app/api/user/bookings/route.ts`

**–ß—Ç–æ –¥–µ–ª–∞–µ—Ç:**
- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é
- –ó–∞–≥—Ä—É–∂–∞–µ—Ç –≤—Å–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- –í–∫–ª—é—á–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –æ —Ç—É—Ä–µ –∏ –≥–æ—Ä–æ–¥–µ
- –°–æ—Ä—Ç–∏—Ä—É–µ—Ç –ø–æ –¥–∞—Ç–µ —Å–æ–∑–¥–∞–Ω–∏—è (–Ω–æ–≤—ã–µ –ø–µ—Ä–≤—ã–µ)

**GET /api/user/cards** - –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–∞—Ä—Ç–∞–º–∏

**–§–∞–π–ª—ã:** 
- `app/api/user/cards/route.ts` - GET (—Å–ø–∏—Å–æ–∫), POST (—Å–æ–∑–¥–∞–Ω–∏–µ)
- `app/api/user/cards/[id]/route.ts` - DELETE, PATCH

**–ß—Ç–æ –¥–µ–ª–∞–µ—Ç:**
- GET: –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –≤—Å–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –∫–∞—Ä—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- POST: –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –Ω–æ–≤—É—é –∫–∞—Ä—Ç—É (—Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 4 —Ü–∏—Ñ—Ä—ã)
- DELETE: –£–¥–∞–ª—è–µ—Ç –∫–∞—Ä—Ç—É
- PATCH: –û–±–Ω–æ–≤–ª—è–µ—Ç –∫–∞—Ä—Ç—É (–Ω–∞–ø—Ä–∏–º–µ—Ä, —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)

**PATCH /api/admin/bookings/[id]** - –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–æ–≤

**–§–∞–π–ª:** `app/api/admin/bookings/[id]/route.ts`

**–ß—Ç–æ –¥–µ–ª–∞–µ—Ç:**
- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ (tour_admin –∏–ª–∏ super_admin)
- –û–±–Ω–æ–≤–ª—è–µ—Ç —Å—Ç–∞—Ç—É—Å –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –∏–ª–∏ –æ–ø–ª–∞—Ç—ã
- –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–Ω–æ–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ

**–ö–æ–¥:**

```typescript
export async function PATCH(request: NextRequest, { params }: { params: Promise<{ id: string }> }) {
  // 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤
  const { data: { user } } = await supabase.auth.getUser();
  const { data: profile } = await supabase
    .from('profiles')
    .select('role')
    .eq('id', user.id)
    .single();

  if (profile?.role !== 'tour_admin' && profile?.role !== 'super_admin') {
    return NextResponse.json({ error: '–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω' }, { status: 403 });
  }

  // 2. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ
  const updateData = await request.json();
  const { data: booking } = await serviceClient
    .from('bookings')
    .update(updateData)
    .eq('id', id)
    .select()
    .single();

  return NextResponse.json({ success: true, booking });
}
```

#### 7. –ú–∏–≥—Ä–∞—Ü–∏–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

**010_add_cities.sql** - –¢–∞–±–ª–∏—Ü–∞ –≥–æ—Ä–æ–¥–æ–≤

**–ß—Ç–æ –¥–µ–ª–∞–µ—Ç:**
- –°–æ–∑–¥–∞–µ—Ç —Ç–∞–±–ª–∏—Ü—É `cities` —Å –≥–æ—Ä–æ–¥–∞–º–∏ –¢–∞—Ç–∞—Ä—Å—Ç–∞–Ω–∞
- –î–æ–±–∞–≤–ª—è–µ—Ç –ø–æ–ª–µ `city_id` –≤ —Ç–∞–±–ª–∏—Ü—É `tours`
- –°–æ–∑–¥–∞–µ—Ç –∏–Ω–¥–µ–∫—Å –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞
- –ó–∞–ø–æ–ª–Ω—è–µ—Ç —Ç–∞–±–ª–∏—Ü—É –≥–æ—Ä–æ–¥–∞–º–∏ –¢–∞—Ç–∞—Ä—Å—Ç–∞–Ω–∞

**011_booking_payment_system.sql** - –°–∏—Å—Ç–µ–º–∞ –æ–ø–ª–∞—Ç—ã

**–ß—Ç–æ –¥–µ–ª–∞–µ—Ç:**
- –°–æ–∑–¥–∞–µ—Ç enum —Ç–∏–ø—ã: `payment_method`, `payment_status`
- –°–æ–∑–¥–∞–µ—Ç —Ç–∞–±–ª–∏—Ü—É `user_cards` –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –∫–∞—Ä—Ç
- –î–æ–±–∞–≤–ª—è–µ—Ç –ø–æ–ª—è –æ–ø–ª–∞—Ç—ã –≤ —Ç–∞–±–ª–∏—Ü—É `bookings`
- –°–æ–∑–¥–∞–µ—Ç —Ç—Ä–∏–≥–≥–µ—Ä—ã –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –∫–∞—Ä—Ç—ã –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
- –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç RLS –ø–æ–ª–∏—Ç–∏–∫–∏ –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

**–ö–ª—é—á–µ–≤—ã–µ —Ç—Ä–∏–≥–≥–µ—Ä—ã:**

```sql
-- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –∫–∞—Ä—Ç—ã –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
CREATE OR REPLACE FUNCTION set_default_card()
RETURNS TRIGGER AS $$
BEGIN
  IF NEW.is_default = TRUE THEN
    UPDATE user_cards
    SET is_default = FALSE
    WHERE user_id = NEW.user_id
      AND id != NEW.id
      AND is_default = TRUE;
  END IF;
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trigger_set_default_card
  BEFORE INSERT OR UPDATE ON user_cards
  FOR EACH ROW
  EXECUTE FUNCTION set_default_card();
```

**012_fix_booking_trigger.sql** - –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç—Ä–∏–≥–≥–µ—Ä–∞ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π

**–ß—Ç–æ –¥–µ–ª–∞–µ—Ç:**
- –ò—Å–ø—Ä–∞–≤–ª—è–µ—Ç —Ñ—É–Ω–∫—Ü–∏—é `update_tour_bookings()` –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è `current_participants` –≤–º–µ—Å—Ç–æ —É—Å—Ç–∞—Ä–µ–≤—à–µ–≥–æ `current_bookings`
- –û–±–Ω–æ–≤–ª—è–µ—Ç —Ñ—É–Ω–∫—Ü–∏—é `update_tour_participants()` –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π —Ä–∞–±–æ—Ç—ã —Å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
- –£–¥–∞–ª—è–µ—Ç –∫–æ–Ω—Ñ–ª–∏–∫—Ç—É—é—â–∏–µ —Ç—Ä–∏–≥–≥–µ—Ä—ã –∏ —Å–æ–∑–¥–∞–µ—Ç –µ–¥–∏–Ω—ã–π –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ç—Ä–∏–≥–≥–µ—Ä
- –†–µ—à–∞–µ—Ç –ø—Ä–æ–±–ª–µ–º—É –æ—à–∏–±–∫–∏ "column current_bookings does not exist" –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–æ–≤ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π

**–ö–ª—é—á–µ–≤—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è:**

```sql
-- –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è current_participants
CREATE OR REPLACE FUNCTION update_tour_bookings()
RETURNS TRIGGER AS $$
BEGIN
  IF (TG_OP = 'INSERT' AND NEW.status = 'confirmed') THEN
    UPDATE tours
    SET current_participants = current_participants + NEW.num_people
    WHERE id = NEW.tour_id;
  -- ... –æ—Å—Ç–∞–ª—å–Ω–∞—è –ª–æ–≥–∏–∫–∞
END;
$$ LANGUAGE plpgsql;
```

---

## üîÑ –ü–æ—Å–ª–µ–¥–Ω–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è (–î–µ–∫–∞–±—Ä—å 2024)

### –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è —Å–µ–∫—Ü–∏–∏ "–ú–æ–∏ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è"

**–ü—Ä–æ–±–ª–µ–º–∞:** –í –ø—Ä–æ—Ñ–∏–ª–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –æ—Ç–æ–±—Ä–∞–∂–∞–ª–∏—Å—å –¥–≤–µ —Å–µ–∫—Ü–∏–∏ "–ú–æ–∏ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è" - —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∞—è —Å –ø—É—Å—Ç—ã–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º –∏ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è —Å –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–º `UserBookings`.

**–†–µ—à–µ–Ω–∏–µ:**
- –£–¥–∞–ª–µ–Ω–∞ –¥—É–±–ª–∏—Ä—É—é—â–∞—è —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∞—è —Å–µ–∫—Ü–∏—è –∏–∑ `components/profile/ProfileContent.tsx`
- –û—Å—Ç–∞–≤–ª–µ–Ω —Ç–æ–ª—å–∫–æ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç `UserBookings`, –∫–æ—Ç–æ—Ä—ã–π –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –∑–∞–≥—Ä—É–∂–∞–µ—Ç –∏ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è

**–§–∞–π–ª—ã:**
- `components/profile/ProfileContent.tsx` - —É–¥–∞–ª–µ–Ω–∞ —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∞—è —Å–µ–∫—Ü–∏—è (—Å—Ç—Ä–æ–∫–∏ 384-402)

**–ö–æ–¥ –∏–∑–º–µ–Ω–µ–Ω–∏—è:**

```tsx
// components/profile/ProfileContent.tsx
// –ë–´–õ–û (–¥—É–±–ª–∏—Ä—É—é—â–∞—è —Å–µ–∫—Ü–∏—è):
{/* –ú–æ–∏ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è */}
<div className="bg-white shadow rounded-lg p-6">
  <h2 className="text-2xl font-semibold text-gray-900 mb-6">
    –ú–æ–∏ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
  </h2>
  <div className="text-center py-12">
    <Calendar className="w-16 h-16 text-gray-300 mx-auto mb-4" />
    <p className="text-lg text-gray-600 mb-2">–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π</p>
    {/* ... */}
  </div>
</div>

{/* –ú–æ–∏ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è */}
<UserBookings />

// –°–¢–ê–õ–û (—Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω –∫–æ–º–ø–æ–Ω–µ–Ω—Ç):
{/* –ú–æ–∏ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è */}
<UserBookings />
```

---

### –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—à–∏–±–∫–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π

**–ü—Ä–æ–±–ª–µ–º–∞:** –ü—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ –∏–∑–º–µ–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –≤ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏ –≤–æ–∑–Ω–∏–∫–∞–ª–∞ –æ—à–∏–±–∫–∞:
```
column "current_bookings" does not exist
```

**–ü—Ä–∏—á–∏–Ω–∞:** –¢—Ä–∏–≥–≥–µ—Ä `update_tour_bookings()` –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª —É—Å—Ç–∞—Ä–µ–≤—à–µ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–æ–ª–æ–Ω–∫–∏ `current_bookings`, –∫–æ—Ç–æ—Ä–∞—è –±—ã–ª–∞ –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∞ –≤ `current_participants` –≤ –º–∏–≥—Ä–∞—Ü–∏–∏ 004.

**–†–µ—à–µ–Ω–∏–µ:**
- –°–æ–∑–¥–∞–Ω–∞ –º–∏–≥—Ä–∞—Ü–∏—è `012_fix_booking_trigger.sql`
- –û–±–Ω–æ–≤–ª–µ–Ω—ã —Ñ—É–Ω–∫—Ü–∏–∏ `update_tour_bookings()` –∏ `update_tour_participants()`
- –£–¥–∞–ª–µ–Ω—ã –∫–æ–Ω—Ñ–ª–∏–∫—Ç—É—é—â–∏–µ —Ç—Ä–∏–≥–≥–µ—Ä—ã –∏ —Å–æ–∑–¥–∞–Ω –µ–¥–∏–Ω—ã–π –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ç—Ä–∏–≥–≥–µ—Ä

**–§–∞–π–ª—ã:**
- `supabase/migrations/012_fix_booking_trigger.sql` - –Ω–æ–≤–∞—è –º–∏–≥—Ä–∞—Ü–∏—è

---

### –ü–æ–ª–Ω–∞—è –ø–µ—Ä–µ—Ä–∞–±–æ—Ç–∫–∞ –¥–∏–∑–∞–π–Ω–∞ PDF –±–∏–ª–µ—Ç–∞

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
1. **–ù–æ–≤—ã–π —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π –¥–∏–∑–∞–π–Ω:**
   - –ì—Ä–∞–¥–∏–µ–Ω—Ç–Ω—ã–π —Ñ–æ–Ω (–±–∏—Ä—é–∑–æ–≤–æ-–∑–µ–ª–µ–Ω—ã–π)
   - –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –≤ –∫–∞—Ä—Ç–æ—á–∫–∞—Ö
   - QR-–∫–æ–¥ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –±–∏–ª–µ—Ç–∞
   - –û—Ç—Ä—ã–≤–Ω–∞—è —á–∞—Å—Ç—å —Å –ø—É–Ω–∫—Ç–∏—Ä–Ω–æ–π –ª–∏–Ω–∏–µ–π (–ø–µ—Ä—Ñ–æ—Ä–∞—Ü–∏—è)
   - –£–ª—É—á—à–µ–Ω–Ω–∞—è —Ç–∏–ø–æ–≥—Ä–∞—Ñ–∏–∫–∞ –∏ —á–∏—Ç–∞–µ–º–æ—Å—Ç—å

2. **–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –¥–ª—è –æ–¥–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã:**
   - –£–º–µ–Ω—å—à–µ–Ω—ã –æ—Ç—Å—Ç—É–ø—ã –∏ —Ä–∞–∑–º–µ—Ä—ã —ç–ª–µ–º–µ–Ω—Ç–æ–≤
   - –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω—ã —Ä–∞–∑–º–µ—Ä—ã —à—Ä–∏—Ñ—Ç–æ–≤
   - –ö–æ–º–ø–∞–∫—Ç–Ω–æ–µ —Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ –≤—Å–µ—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤
   - –ë–∏–ª–µ—Ç –ø–æ–º–µ—â–∞–µ—Ç—Å—è –Ω–∞ –æ–¥–Ω—É —Å—Ç—Ä–∞–Ω–∏—Ü—É A4

3. **–£–ª—É—á—à–µ–Ω–Ω–∞—è —á–∏—Ç–∞–µ–º–æ—Å—Ç—å:**
   - –£–≤–µ–ª–∏—á–µ–Ω—ã —Ä–∞–∑–º–µ—Ä—ã –≤–∞–∂–Ω—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤ (–Ω–æ–º–µ—Ä –±–∏–ª–µ—Ç–∞, —Ü–µ–Ω–∞)
   - –£–ª—É—á—à–µ–Ω–∞ –∫–æ–Ω—Ç—Ä–∞—Å—Ç–Ω–æ—Å—Ç—å —Ü–≤–µ—Ç–æ–≤
   - –ë–æ–ª–µ–µ —á–µ—Ç–∫–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏

**–§–∞–π–ª—ã:**
- `lib/pdf/ticket.ts` - –ø–æ–ª–Ω–æ—Å—Ç—å—é –ø–µ—Ä–µ—Ä–∞–±–æ—Ç–∞–Ω –¥–∏–∑–∞–π–Ω –±–∏–ª–µ—Ç–∞

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –±–∏–ª–µ—Ç–∞:**
- –®–∞–ø–∫–∞ —Å –ª–æ–≥–æ—Ç–∏–ø–æ–º –∏ –Ω–∞–∑–≤–∞–Ω–∏–µ–º –∫–æ–º–ø–∞–Ω–∏–∏
- –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è (–Ω–æ–º–µ—Ä –±–∏–ª–µ—Ç–∞, —Å—Ç–∞—Ç—É—Å "–û–ü–õ–ê–ß–ï–ù", –Ω–∞–∑–≤–∞–Ω–∏–µ —Ç—É—Ä–∞)
- –ö–∞—Ä—Ç–æ—á–∫–∏ —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π (–≥–æ—Ä–æ–¥, –¥–∞—Ç–∞, —É—á–∞—Å—Ç–Ω–∏–∫–∏, —Å–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã)
- –ë–ª–æ–∫ —Å –æ–±—â–µ–π —Å—Ç–æ–∏–º–æ—Å—Ç—å—é
- QR-–∫–æ–¥ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
- –û—Ç—Ä—ã–≤–Ω–∞—è —á–∞—Å—Ç—å –±–∏–ª–µ—Ç–∞
- –§—É—Ç–µ—Ä —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞

**–ö–ª—é—á–µ–≤—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –∫–æ–¥–µ:**

```typescript
// lib/pdf/ticket.ts
// –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ä–∞–∑–º–µ—Ä—ã –¥–ª—è –æ–¥–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã A4
ticketElement.innerHTML = `
  <div style="max-width: 714px; margin: 0 auto; background: #ffffff;">
    <!-- –û—Å–Ω–æ–≤–Ω–∞—è —á–∞—Å—Ç—å –±–∏–ª–µ—Ç–∞ -->
    <div style="padding: 18px 25px; background: linear-gradient(135deg, #0f766e 0%, #14b8a6 50%, #10b981 100%);">
      <!-- –®–∞–ø–∫–∞ -->
      <div style="text-align: center; margin-bottom: 15px;">
        <h1 style="font-size: 28px; font-weight: 800; color: white;">
          –ë–∏–ª–µ—Ç
        </h1>
        <div style="font-size: 12px; color: rgba(255,255,255,0.95);">
          –¢–£–†–´ –ü–û –¢–ê–¢–ê–†–°–¢–ê–ù–£
        </div>
      </div>

      <!-- –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
      <div style="background: white; border-radius: 14px; padding: 20px;">
        <!-- –ù–æ–º–µ—Ä –±–∏–ª–µ—Ç–∞ –∏ —Å—Ç–∞—Ç—É—Å -->
        <div style="display: flex; justify-content: space-between; margin-bottom: 16px;">
          <div>
            <div style="font-size: 10px; color: #4b5563;">–ù–æ–º–µ—Ä –±–∏–ª–µ—Ç–∞</div>
            <div style="font-size: 22px; font-weight: 900; color: #0f766e; font-family: monospace;">
              ${bookingId}
            </div>
          </div>
          <div>
            <div style="display: inline-block; padding: 6px 12px; background: #10b981; color: white; border-radius: 16px; font-size: 11px;">
              –û–ü–õ–ê–ß–ï–ù
            </div>
          </div>
        </div>

        <!-- –ö–∞—Ä—Ç–æ—á–∫–∏ —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π -->
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
          <div style="padding: 12px; background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%); border-radius: 10px;">
            <div style="font-size: 9px; color: #047857;">üìç –ì–æ—Ä–æ–¥</div>
            <div style="font-size: 16px; font-weight: 900; color: #065f46;">${booking.tour.city.name}</div>
          </div>
          <!-- ... –¥—Ä—É–≥–∏–µ –∫–∞—Ä—Ç–æ—á–∫–∏ ... -->
        </div>

        <!-- –¶–µ–Ω–∞ -->
        <div style="padding: 16px; background: linear-gradient(135deg, #0f766e 0%, #14b8a6 100%); border-radius: 10px; text-align: center;">
          <div style="font-size: 10px; color: rgba(255,255,255,0.95);">–û–±—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å</div>
          <div style="font-size: 34px; font-weight: 900; color: white;">
            ${parseFloat(booking.total_price.toString()).toLocaleString('ru-RU')} ‚ÇΩ
          </div>
        </div>
      </div>

      <!-- QR-–∫–æ–¥ –∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
      <div style="display: flex; gap: 14px;">
        <div style="flex: 1; background: rgba(255,255,255,0.2); padding: 14px; border-radius: 10px;">
          <div style="font-size: 10px; color: white;">QR-–∫–æ–¥ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏</div>
          <div style="background: white; padding: 8px; border-radius: 8px; font-family: monospace; font-size: 6px;">
            ${qrCode}
          </div>
          <div style="font-size: 9px; color: white;">ID: ${bookingId}</div>
        </div>
        <!-- ... –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è ... -->
      </div>
    </div>

    <!-- –û—Ç—Ä—ã–≤–Ω–∞—è —á–∞—Å—Ç—å -->
    <div style="padding: 14px 25px; background: #f8fafc; border-top: 2px dashed #cbd5e1;">
      <!-- ... -->
    </div>
  </div>
`;
```

---

### –ò–∑–º–µ–Ω–µ–Ω–∏–µ –ª–æ–≥–∏–∫–∏ —Å–æ–∑–¥–∞–Ω–∏—è –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è

**–ò–∑–º–µ–Ω–µ–Ω–∏–µ:** –ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è —Å—Ç–∞—Ç—É—Å –æ–ø–ª–∞—Ç—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –≤ `'paid'` (–æ–ø–ª–∞—á–µ–Ω), –∞ —Å—Ç–∞—Ç—É—Å –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è - –≤ `'confirmed'` (–ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ).

**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:** –ö–æ–≥–¥–∞ –±–∏–ª–µ—Ç —Å–æ–∑–¥–∞–Ω, –æ–Ω —Å—á–∏—Ç–∞–µ—Ç—Å—è –æ–ø–ª–∞—á–µ–Ω–Ω—ã–º –∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–Ω—ã–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.

**–ö–æ–¥:**

```typescript
// app/api/bookings/route.ts
const { data: booking, error: bookingError } = await serviceClient
  .from('bookings')
  .insert({
    user_id: user.id,
    tour_id,
    num_people,
    total_price,
    payment_method,
    payment_status: 'paid', // –ë–∏–ª–µ—Ç —Å–æ–∑–¥–∞–Ω = –æ–ø–ª–∞—á–µ–Ω
    payment_data: {
      ...payment_data,
      card_id: cardId || payment_data?.card_id || null,
    },
    status: 'confirmed', // –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ —Å—Ä–∞–∑—É, —Ç–∞–∫ –∫–∞–∫ –æ–ø–ª–∞—á–µ–Ω–æ
  })
  .select()
  .single();
```

**–§–∞–π–ª—ã:**
- `app/api/bookings/route.ts` - –∏–∑–º–µ–Ω–µ–Ω–∞ –ª–æ–≥–∏–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è

---

### –ó–∞–º–µ–Ω–∞ –∏–∫–æ–Ω–æ–∫ –¥–æ–ª–ª–∞—Ä–∞ –Ω–∞ –∏–∫–æ–Ω–∫–∏ –º–æ–Ω–µ—Ç

**–ü—Ä–æ–±–ª–µ–º–∞:** –í –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏—Å—å –∏–∫–æ–Ω–∫–∏ –¥–æ–ª–ª–∞—Ä–∞ (`DollarSign`), —á—Ç–æ –Ω–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Ä–æ—Å—Å–∏–π—Å–∫–æ–π –≤–∞–ª—é—Ç–µ (—Ä—É–±–ª–∏).

**–†–µ—à–µ–Ω–∏–µ:** –í—Å–µ –∏–∫–æ–Ω–∫–∏ –¥–æ–ª–ª–∞—Ä–∞ –∑–∞–º–µ–Ω–µ–Ω—ã –Ω–∞ –∏–∫–æ–Ω–∫–∏ –º–æ–Ω–µ—Ç (`Coins`) —Å —Ü–≤–µ—Ç–æ–º `emerald-500` –¥–ª—è –µ–¥–∏–Ω–æ–æ–±—Ä–∞–∑–∏—è –¥–∏–∑–∞–π–Ω–∞.

**–ò–∑–º–µ–Ω–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:**
1. `components/profile/UserBookings.tsx`
   - –ó–∞–º–µ–Ω–µ–Ω –∏–º–ø–æ—Ä—Ç `DollarSign` –Ω–∞ `Coins`
   - –û–±–Ω–æ–≤–ª–µ–Ω–∞ –∏–∫–æ–Ω–∫–∞ –≤ —Å–ø–∏—Å–∫–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π

2. `components/admin/BookingDetails.tsx`
   - –ó–∞–º–µ–Ω–µ–Ω –∏–º–ø–æ—Ä—Ç `DollarSign` –Ω–∞ `Coins`
   - –û–±–Ω–æ–≤–ª–µ–Ω–∞ –∏–∫–æ–Ω–∫–∞ –≤ –¥–µ—Ç–∞–ª—è—Ö –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è

3. `app/tours/[slug]/page.tsx`
   - –ó–∞–º–µ–Ω–µ–Ω –∏–º–ø–æ—Ä—Ç `DollarSign` –Ω–∞ `Coins`
   - –û–±–Ω–æ–≤–ª–µ–Ω–∞ –∏–∫–æ–Ω–∫–∞ —Ü–µ–Ω—ã –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ —Ç—É—Ä–∞

4. `components/admin/TourAdminList.tsx`
   - –ó–∞–º–µ–Ω–µ–Ω –∏–º–ø–æ—Ä—Ç `DollarSign` –Ω–∞ `Coins`
   - –û–±–Ω–æ–≤–ª–µ–Ω–∞ –∏–∫–æ–Ω–∫–∞ –≤ —Å–ø–∏—Å–∫–µ —Ç—É—Ä–æ–≤ –∞–¥–º–∏–Ω–∞

5. `components/admin/BookingsList.tsx`
   - –ó–∞–º–µ–Ω–µ–Ω –∏–º–ø–æ—Ä—Ç `DollarSign` –Ω–∞ `Coins`

**–ü—Ä–∏–º–µ—Ä –∏–∑–º–µ–Ω–µ–Ω–∏—è:**

```typescript
// components/profile/UserBookings.tsx
// –ë–´–õ–û:
import { DollarSign } from 'lucide-react';

<div className="flex items-center gap-2 text-gray-600">
  <DollarSign className="w-4 h-4" />
  <span className="font-medium text-gray-900">
    {parseFloat(booking.total_price.toString()).toLocaleString('ru-RU')} ‚ÇΩ
  </span>
</div>

// –°–¢–ê–õ–û:
import { Coins } from 'lucide-react';

<div className="flex items-center gap-2 text-gray-600">
  <Coins className="w-4 h-4 text-emerald-500" />
  <span className="font-medium text-gray-900">
    {parseFloat(booking.total_price.toString()).toLocaleString('ru-RU')} ‚ÇΩ
  </span>
</div>
```

**–í—Å–µ –∏–∑–º–µ–Ω–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã —Å –ø–æ–ª–Ω—ã–º –∫–æ–¥–æ–º:**

1. **components/profile/UserBookings.tsx:**
```typescript
import { Coins } from 'lucide-react'; // –ó–∞–º–µ–Ω–µ–Ω–æ DollarSign –Ω–∞ Coins

// –í –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–µ:
<Coins className="w-4 h-4 text-emerald-500" />
```

2. **components/admin/BookingDetails.tsx:**
```typescript
import { Coins } from 'lucide-react'; // –ó–∞–º–µ–Ω–µ–Ω–æ DollarSign –Ω–∞ Coins

// –í –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–µ:
<Coins className="w-5 h-5 text-emerald-500 mt-0.5" />
```

3. **app/tours/[slug]/page.tsx:**
```typescript
import { Coins } from 'lucide-react'; // –ó–∞–º–µ–Ω–µ–Ω–æ DollarSign –Ω–∞ Coins

// –í –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–µ:
<Coins className="w-6 h-6 text-emerald-500" />
```

4. **components/admin/TourAdminList.tsx:**
```typescript
import { Coins } from 'lucide-react'; // –ó–∞–º–µ–Ω–µ–Ω–æ DollarSign –Ω–∞ Coins

// –í –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–µ:
<Coins className="w-4 h-4 text-emerald-500" />
```

5. **components/admin/BookingsList.tsx:**
```typescript
import { Coins } from 'lucide-react'; // –ó–∞–º–µ–Ω–µ–Ω–æ DollarSign –Ω–∞ Coins
```

---

### –ó–∞—Ç–µ–º–Ω–µ–Ω–∏–µ —Ñ–æ–Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã /tours

**–ü—Ä–æ–±–ª–µ–º–∞:** –§–æ–Ω hero-—Å–µ–∫—Ü–∏–∏ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ `/tours` –±—ã–ª —Å–ª–∏—à–∫–æ–º —è—Ä–∫–∏–º –∏ –æ—Ç–≤–ª–µ–∫–∞–ª –æ—Ç –∫–æ–Ω—Ç–µ–Ω—Ç–∞.

**–†–µ—à–µ–Ω–∏–µ:** –ó–∞—Ç–µ–º–Ω–µ–Ω –≥—Ä–∞–¥–∏–µ–Ω—Ç —Ñ–æ–Ω–∞ –∏ —É–º–µ–Ω—å—à–µ–Ω–∞ –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç—å —Å–≤–µ—Ç–æ–≤—ã—Ö —ç—Ñ—Ñ–µ–∫—Ç–æ–≤ –¥–ª—è –±–æ–ª–µ–µ —Å–ø–æ–∫–æ–π–Ω–æ–≥–æ –∏ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ–≥–æ –≤–∏–¥–∞.

**–ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ –∫–æ–¥–µ:**

**–§–∞–π–ª:** `app/tours/page.tsx`

**–ë–´–õ–û (—è—Ä–∫–∏–π —Ñ–æ–Ω):**
```tsx
{/* Hero —Å–µ–∫—Ü–∏—è */}
<div className="relative overflow-hidden">
  {/* –û—Å–Ω–æ–≤–Ω–æ–π –≥—Ä–∞–¥–∏–µ–Ω—Ç - –±–æ–ª–µ–µ –º—è–≥–∫–∏–π */}
  <div className="absolute inset-0 bg-gradient-to-br from-emerald-400 via-teal-400 to-emerald-500"></div>
  
  {/* –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Å–ª–æ–∏ –¥–ª—è –≥–ª—É–±–∏–Ω—ã */}
  <div className="absolute inset-0 bg-gradient-to-t from-emerald-600/20 via-transparent to-transparent"></div>
  
  {/* –¢–æ–Ω–∫–∏–π –ø–∞—Ç—Ç–µ—Ä–Ω */}
  <div className="absolute inset-0 opacity-[0.03] bg-[radial-gradient(circle_at_1px_1px,_rgb(255,255,255)_1px,_transparent_0)] bg-[length:40px_40px]"></div>
  
  {/* –ú—è–≥–∫–∏–µ —Å–≤–µ—Ç–æ–≤—ã–µ —ç—Ñ—Ñ–µ–∫—Ç—ã */}
  <div className="absolute top-0 left-1/4 w-96 h-96 bg-emerald-300/20 rounded-full blur-3xl"></div>
  <div className="absolute bottom-0 right-1/4 w-96 h-96 bg-teal-300/20 rounded-full blur-3xl"></div>
```

**–°–¢–ê–õ–û (—Ç–µ–º–Ω–µ–µ –∏ —Å–ø–æ–∫–æ–π–Ω–µ–µ):**
```tsx
{/* Hero —Å–µ–∫—Ü–∏—è */}
<div className="relative overflow-hidden">
  {/* –û—Å–Ω–æ–≤–Ω–æ–π –≥—Ä–∞–¥–∏–µ–Ω—Ç - —Ç–µ–º–Ω–µ–µ –∏ —Å–ø–æ–∫–æ–π–Ω–µ–µ */}
  <div className="absolute inset-0 bg-gradient-to-br from-emerald-600 via-emerald-700 to-teal-700"></div>
  
  {/* –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Å–ª–æ–∏ –¥–ª—è –≥–ª—É–±–∏–Ω—ã */}
  <div className="absolute inset-0 bg-gradient-to-t from-emerald-800/30 via-transparent to-transparent"></div>
  
  {/* –¢–æ–Ω–∫–∏–π –ø–∞—Ç—Ç–µ—Ä–Ω */}
  <div className="absolute inset-0 opacity-[0.05] bg-[radial-gradient(circle_at_1px_1px,_rgb(255,255,255)_1px,_transparent_0)] bg-[length:40px_40px]"></div>
  
  {/* –ú—è–≥–∫–∏–µ —Å–≤–µ—Ç–æ–≤—ã–µ —ç—Ñ—Ñ–µ–∫—Ç—ã - —Ç–µ–º–Ω–µ–µ */}
  <div className="absolute top-0 left-1/4 w-96 h-96 bg-emerald-500/10 rounded-full blur-3xl"></div>
  <div className="absolute bottom-0 right-1/4 w-96 h-96 bg-teal-600/10 rounded-full blur-3xl"></div>
```

**–î–µ—Ç–∞–ª—å–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π:**

1. **–û—Å–Ω–æ–≤–Ω–æ–π –≥—Ä–∞–¥–∏–µ–Ω—Ç:**
   - **–ë—ã–ª–æ:** `from-emerald-400 via-teal-400 to-emerald-500` (—Å–≤–µ—Ç–ª—ã–µ –æ—Ç—Ç–µ–Ω–∫–∏ 400-500)
   - **–°—Ç–∞–ª–æ:** `from-emerald-600 via-emerald-700 to-teal-700` (—Ç–µ–º–Ω—ã–µ –æ—Ç—Ç–µ–Ω–∫–∏ 600-700)
   - **–≠—Ñ—Ñ–µ–∫—Ç:** –§–æ–Ω —Å—Ç–∞–ª –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ —Ç–µ–º–Ω–µ–µ –∏ –Ω–µ –æ—Ç–≤–ª–µ–∫–∞–µ—Ç –æ—Ç –∫–æ–Ω—Ç–µ–Ω—Ç–∞

2. **–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π —Å–ª–æ–π –≥–ª—É–±–∏–Ω—ã:**
   - **–ë—ã–ª–æ:** `from-emerald-600/20` (20% –Ω–µ–ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç–∏)
   - **–°—Ç–∞–ª–æ:** `from-emerald-800/30` (30% –Ω–µ–ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç–∏, –±–æ–ª–µ–µ —Ç–µ–º–Ω—ã–π –æ—Ç—Ç–µ–Ω–æ–∫)
   - **–≠—Ñ—Ñ–µ–∫—Ç:** –£–≤–µ–ª–∏—á–µ–Ω–∞ –≥–ª—É–±–∏–Ω–∞ –∏ –∑–∞—Ç–µ–º–Ω–µ–Ω–∏–µ –≤ –Ω–∏–∂–Ω–µ–π —á–∞—Å—Ç–∏

3. **–ü–∞—Ç—Ç–µ—Ä–Ω:**
   - **–ë—ã–ª–æ:** `opacity-[0.03]` (3% –Ω–µ–ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç–∏)
   - **–°—Ç–∞–ª–æ:** `opacity-[0.05]` (5% –Ω–µ–ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç–∏)
   - **–≠—Ñ—Ñ–µ–∫—Ç:** –ü–∞—Ç—Ç–µ—Ä–Ω —Å—Ç–∞–ª —á—É—Ç—å –±–æ–ª–µ–µ –∑–∞–º–µ—Ç–Ω—ã–º, –Ω–æ –≤—Å–µ –µ—â–µ –æ—á–µ–Ω—å —Ç–æ–Ω–∫–∏–º

4. **–°–≤–µ—Ç–æ–≤—ã–µ —ç—Ñ—Ñ–µ–∫—Ç—ã:**
   - **–ë—ã–ª–æ:** `bg-emerald-300/20` –∏ `bg-teal-300/20` (20% –Ω–µ–ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç–∏ —Å–≤–µ—Ç–ª—ã—Ö –æ—Ç—Ç–µ–Ω–∫–æ–≤)
   - **–°—Ç–∞–ª–æ:** `bg-emerald-500/10` –∏ `bg-teal-600/10` (10% –Ω–µ–ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç–∏ –±–æ–ª–µ–µ —Ç–µ–º–Ω—ã—Ö –æ—Ç—Ç–µ–Ω–∫–æ–≤)
   - **–≠—Ñ—Ñ–µ–∫—Ç:** –≠—Ñ—Ñ–µ–∫—Ç—ã —Å—Ç–∞–ª–∏ –º–µ–Ω–µ–µ –∑–∞–º–µ—Ç–Ω—ã–º–∏ –∏ –Ω–µ –ø–µ—Ä–µ–≥—Ä—É–∂–∞—é—Ç –≤–∏–∑—É–∞–ª

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- ‚úÖ –§–æ–Ω —Å—Ç–∞–ª —Ç–µ–º–Ω–µ–µ –∏ —Å–ø–æ–∫–æ–π–Ω–µ–µ
- ‚úÖ –£–ª—É—á—à–µ–Ω–∞ —á–∏—Ç–∞–µ–º–æ—Å—Ç—å –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –Ω–∞ —Ñ–æ–Ω–µ
- ‚úÖ –ë–æ–ª–µ–µ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –∏ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π –≤–∏–¥
- ‚úÖ –ú–µ–Ω—å—à–µ –≤–∏–∑—É–∞–ª—å–Ω–æ–≥–æ —à—É–º–∞ –∏ –æ—Ç–≤–ª–µ—á–µ–Ω–∏—è –≤–Ω–∏–º–∞–Ω–∏—è

**–§–∞–π–ª—ã:**
- `app/tours/page.tsx` - –∏–∑–º–µ–Ω–µ–Ω –≥—Ä–∞–¥–∏–µ–Ω—Ç –∏ —ç—Ñ—Ñ–µ–∫—Ç—ã hero-—Å–µ–∫—Ü–∏–∏ (—Å—Ç—Ä–æ–∫–∏ 239-252)

---

---

## üí¨ –°–∏—Å—Ç–µ–º–∞ –∫–æ–º–Ω–∞—Ç —Ç—É—Ä–æ–≤ —Å —á–∞—Ç–æ–º –∏ –≥–∞–ª–µ—Ä–µ–µ–π (–î–µ–∫–∞–±—Ä—å 2024)

### –û–ø–∏—Å–∞–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–∞

–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –∫–æ–º–Ω–∞—Ç –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç—É—Ä–∞, –≥–¥–µ —É—á–∞—Å—Ç–Ω–∏–∫–∏ –º–æ–≥—É—Ç –æ–±—â–∞—Ç—å—Å—è, –¥–µ–ª–∏—Ç—å—Å—è —Ñ–æ—Ç–æ/–≤–∏–¥–µ–æ –∏ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–æ–≤–∞—Ç—å —Å –≥–∏–¥–æ–º.

### –û—Å–Ω–æ–≤–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

‚úÖ **–ö–æ–º–Ω–∞—Ç—ã —Ç—É—Ä–æ–≤** - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ –∫–æ–º–Ω–∞—Ç—ã –ø—Ä–∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–∏ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è  
‚úÖ **–ß–∞—Ç –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏** - –æ–±—â–µ–Ω–∏–µ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –∏ –≥–∏–¥–∞  
‚úÖ **–ì–∞–ª–µ—Ä–µ—è –º–µ–¥–∏–∞** - –∑–∞–≥—Ä—É–∑–∫–∞ –∏ –ø—Ä–æ—Å–º–æ—Ç—Ä —Ñ–æ—Ç–æ/–≤–∏–¥–µ–æ –≤–æ –≤—Ä–µ–º—è —Ç—É—Ä–∞  
‚úÖ **–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ –≥–∏–¥–æ–≤** - –∞–¥–º–∏–Ω –º–æ–∂–µ—Ç –Ω–∞–∑–Ω–∞—á–∏—Ç—å –≥–∏–¥–∞ –¥–ª—è –≥—Ä—É–ø–ø—ã  
‚úÖ **–ü–∞–Ω–µ–ª—å –≥–∏–¥–∞** - –æ—Ç–¥–µ–ª—å–Ω–∞—è –ø–∞–Ω–µ–ª—å –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ç—É—Ä–∞–º–∏  
‚úÖ **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∞—Ä—Ö–∏–≤–∞—Ü–∏—è** - –º–µ–¥–∏–∞ –∞—Ä—Ö–∏–≤–∏—Ä—É–µ—Ç—Å—è –ø–æ—Å–ª–µ –æ–∫–æ–Ω—á–∞–Ω–∏—è —Ç—É—Ä–∞  
‚úÖ **–í—Ä–µ–º–µ–Ω–Ω–∞—è –≥–∞–ª–µ—Ä–µ—è** - –º–µ–¥–∏–∞ –¥–æ—Å—Ç—É–ø–Ω–æ —Ç–æ–ª—å–∫–æ –≤–æ –≤—Ä–µ–º—è —Ç—É—Ä–∞, –∑–∞—Ç–µ–º –∞—Ä—Ö–∏–≤–∏—Ä—É–µ—Ç—Å—è  

---

### 1. –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

**–ú–∏–≥—Ä–∞—Ü–∏—è:** `supabase/migrations/013_tour_rooms.sql`

#### –¢–∞–±–ª–∏—Ü—ã:

**1. `tour_rooms` - –ö–æ–º–Ω–∞—Ç—ã —Ç—É—Ä–æ–≤**
```sql
CREATE TABLE tour_rooms (
  id UUID PRIMARY KEY,
  tour_id UUID NOT NULL REFERENCES tours(id),
  guide_id UUID REFERENCES profiles(id), -- –ù–∞–∑–Ω–∞—á–µ–Ω–Ω—ã–π –≥–∏–¥
  created_by UUID REFERENCES profiles(id),
  is_active BOOLEAN DEFAULT TRUE,
  created_at TIMESTAMP,
  updated_at TIMESTAMP,
  CONSTRAINT unique_tour_room UNIQUE(tour_id) -- –û–¥–Ω–∞ –∫–æ–º–Ω–∞—Ç–∞ –Ω–∞ —Ç—É—Ä
);
```

**2. `tour_room_participants` - –£—á–∞—Å—Ç–Ω–∏–∫–∏ –∫–æ–º–Ω–∞—Ç—ã**
```sql
CREATE TABLE tour_room_participants (
  id UUID PRIMARY KEY,
  room_id UUID NOT NULL REFERENCES tour_rooms(id),
  user_id UUID NOT NULL REFERENCES profiles(id),
  booking_id UUID REFERENCES bookings(id),
  joined_at TIMESTAMP,
  CONSTRAINT unique_participant UNIQUE(room_id, user_id)
);
```

**3. `tour_room_messages` - –°–æ–æ–±—â–µ–Ω–∏—è –≤ —á–∞—Ç–µ**
```sql
CREATE TABLE tour_room_messages (
  id UUID PRIMARY KEY,
  room_id UUID NOT NULL REFERENCES tour_rooms(id),
  user_id UUID NOT NULL REFERENCES profiles(id),
  message TEXT NOT NULL,
  created_at TIMESTAMP,
  deleted_at TIMESTAMP -- –ú—è–≥–∫–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ
);
```

**4. `tour_room_media` - –ú–µ–¥–∏–∞ –≤ –≥–∞–ª–µ—Ä–µ–µ**
```sql
CREATE TABLE tour_room_media (
  id UUID PRIMARY KEY,
  room_id UUID NOT NULL REFERENCES tour_rooms(id),
  user_id UUID NOT NULL REFERENCES profiles(id),
  media_type media_type NOT NULL, -- 'image' –∏–ª–∏ 'video'
  media_url TEXT NOT NULL, -- URL –≤ S3
  media_path TEXT NOT NULL, -- –ü—É—Ç—å –≤ S3
  thumbnail_url TEXT, -- –ü—Ä–µ–≤—å—é –¥–ª—è –≤–∏–¥–µ–æ
  file_name TEXT,
  file_size BIGINT,
  mime_type TEXT,
  is_temporary BOOLEAN DEFAULT TRUE, -- –í—Ä–µ–º–µ–Ω–Ω–æ–µ –¥–æ –æ–∫–æ–Ω—á–∞–Ω–∏—è —Ç—É—Ä–∞
  archived_at TIMESTAMP, -- –î–∞—Ç–∞ –∞—Ä—Ö–∏–≤–∞—Ü–∏–∏
  created_at TIMESTAMP
);
```

---

### 2. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ –∫–æ–º–Ω–∞—Ç

**–¢—Ä–∏–≥–≥–µ—Ä:** –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞–µ—Ç –∫–æ–º–Ω–∞—Ç—É –∏ –¥–æ–±–∞–≤–ª—è–µ—Ç —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –ø—Ä–∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–∏ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è.

```sql
CREATE FUNCTION create_tour_room_on_booking()
RETURNS TRIGGER AS $$
BEGIN
  -- –°–æ–∑–¥–∞–µ–º –∫–æ–º–Ω–∞—Ç—É –µ—Å–ª–∏ –µ–µ –µ—â–µ –Ω–µ—Ç
  INSERT INTO tour_rooms (tour_id, created_by)
  VALUES (NEW.tour_id, NEW.user_id)
  ON CONFLICT (tour_id) DO NOTHING;
  
  -- –î–æ–±–∞–≤–ª—è–µ–º —É—á–∞—Å—Ç–Ω–∏–∫–∞ –≤ –∫–æ–º–Ω–∞—Ç—É
  INSERT INTO tour_room_participants (room_id, user_id, booking_id)
  SELECT id, NEW.user_id, NEW.id
  FROM tour_rooms
  WHERE tour_id = NEW.tour_id
  ON CONFLICT (room_id, user_id) DO NOTHING;
  
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trigger_create_tour_room
  AFTER INSERT ON bookings
  FOR EACH ROW
  WHEN (NEW.status = 'confirmed')
  EXECUTE FUNCTION create_tour_room_on_booking();
```

**–§–∞–π–ª:** `supabase/migrations/013_tour_rooms.sql`

---

### 3. API Endpoints –¥–ª—è –∫–æ–º–Ω–∞—Ç —Ç—É—Ä–æ–≤

#### GET `/api/tour-rooms?tour_id={tour_id}`
–ü–æ–ª—É—á–∏—Ç—å –∫–æ–º–Ω–∞—Ç—É –¥–ª—è —Ç—É—Ä–∞ (—Å–æ–∑–¥–∞–µ—Ç –µ—Å–ª–∏ –Ω–µ—Ç).

**–ö–æ–¥:**
```typescript
// app/api/tour-rooms/route.ts
export async function GET(request: NextRequest) {
  const tourId = searchParams.get('tour_id');
  
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º confirmed –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
  const { data: booking } = await serviceClient
    .from('bookings')
    .select('id, status')
    .eq('tour_id', tourId)
    .eq('user_id', user.id)
    .eq('status', 'confirmed')
    .single();
  
  // –ò—â–µ–º –∏–ª–∏ —Å–æ–∑–¥–∞–µ–º –∫–æ–º–Ω–∞—Ç—É
  let { data: room } = await serviceClient
    .from('tour_rooms')
    .select('*, tour:tours(...), guide:profiles(...)')
    .eq('tour_id', tourId)
    .single();
  
  if (!room && booking) {
    // –°–æ–∑–¥–∞–µ–º –∫–æ–º–Ω–∞—Ç—É
    const { data: newRoom } = await serviceClient
      .from('tour_rooms')
      .insert({ tour_id: tourId, created_by: user.id })
      .select()
      .single();
    
    room = newRoom;
  }
  
  return NextResponse.json({ success: true, room });
}
```

#### PATCH `/api/tour-rooms?room_id={room_id}`
–û–±–Ω–æ–≤–∏—Ç—å –∫–æ–º–Ω–∞—Ç—É (–Ω–∞–∑–Ω–∞—á–∏—Ç—å –≥–∏–¥–∞) - —Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–æ–≤.

**–ö–æ–¥:**
```typescript
export async function PATCH(request: NextRequest) {
  const { guide_id, is_active } = await request.json();
  
  const { data: room } = await serviceClient
    .from('tour_rooms')
    .update({ guide_id, is_active })
    .eq('id', roomId)
    .select()
    .single();
  
  return NextResponse.json({ success: true, room });
}
```

---

### 4. API –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏–π –≤ —á–∞—Ç–µ

#### GET `/api/tour-rooms/[room_id]/messages`
–ü–æ–ª—É—á–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è –∫–æ–º–Ω–∞—Ç—ã —Å –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π.

**–ö–æ–¥:**
```typescript
// app/api/tour-rooms/[room_id]/messages/route.ts
export async function GET(request: NextRequest, { params }) {
  const { room_id } = await params;
  const page = parseInt(searchParams.get('page') || '1');
  const limit = 50;
  
  const { data: messages } = await serviceClient
    .from('tour_room_messages')
    .select('*, user:profiles(id, first_name, last_name, avatar_url)')
    .eq('room_id', room_id)
    .is('deleted_at', null)
    .order('created_at', { ascending: false })
    .range((page - 1) * limit, page * limit - 1);
  
  return NextResponse.json({ messages: messages.reverse() });
}
```

#### POST `/api/tour-rooms/[room_id]/messages`
–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –∫–æ–º–Ω–∞—Ç—É.

**–ö–æ–¥:**
```typescript
export async function POST(request: NextRequest, { params }) {
  const { room_id } = await params;
  const { message } = await request.json();
  
  const { data: newMessage } = await serviceClient
    .from('tour_room_messages')
    .insert({
      room_id,
      user_id: user.id,
      message
    })
    .select('*, user:profiles(...)')
    .single();
  
  return NextResponse.json({ success: true, message: newMessage });
}
```

#### DELETE `/api/tour-rooms/[room_id]/messages/[message_id]`
–£–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ (–º—è–≥–∫–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ).

**–ö–æ–¥:**
```typescript
// app/api/tour-rooms/[room_id]/messages/[message_id]/route.ts
export async function DELETE(request: NextRequest, { params }) {
  const { message_id } = await params;
  
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∞–≤–∞ (–≤–ª–∞–¥–µ–ª–µ—Ü, –≥–∏–¥ –∏–ª–∏ –∞–¥–º–∏–Ω)
  const { data: message } = await serviceClient
    .from('tour_room_messages')
    .select('*, room:tour_rooms(guide_id)')
    .eq('id', message_id)
    .single();
  
  const canDelete = 
    message.user_id === user.id ||
    message.room.guide_id === user.id ||
    isAdmin;
  
  if (!canDelete) {
    return NextResponse.json({ error: '–ù–µ—Ç –ø—Ä–∞–≤' }, { status: 403 });
  }
  
  await serviceClient
    .from('tour_room_messages')
    .update({ deleted_at: new Date().toISOString() })
    .eq('id', message_id);
  
  return NextResponse.json({ success: true });
}
```

---

### 5. API –¥–ª—è –º–µ–¥–∏–∞ –≥–∞–ª–µ—Ä–µ–∏

#### GET `/api/tour-rooms/[room_id]/media`
–ü–æ–ª—É—á–∏—Ç—å –º–µ–¥–∏–∞ –∫–æ–º–Ω–∞—Ç—ã —Å —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π (temporary/archived/all).

**–ö–æ–¥:**
```typescript
// app/api/tour-rooms/[room_id]/media/route.ts
export async function GET(request: NextRequest, { params }) {
  const { room_id } = await params;
  const filter = searchParams.get('filter') || 'all'; // temporary, archived, all
  
  let query = serviceClient
    .from('tour_room_media')
    .select('*, user:profiles(id, first_name, last_name, avatar_url)')
    .eq('room_id', room_id)
    .order('created_at', { ascending: false });
  
  if (filter === 'temporary') {
    query = query.eq('is_temporary', true).is('archived_at', null);
  } else if (filter === 'archived') {
    query = query.not('archived_at', 'is', null);
  }
  
  const { data: media } = await query;
  return NextResponse.json({ media });
}
```

#### POST `/api/tour-rooms/[room_id]/media`
–ó–∞–≥—Ä—É–∑–∏—Ç—å –º–µ–¥–∏–∞ (—Ñ–æ—Ç–æ/–≤–∏–¥–µ–æ) –≤ –∫–æ–º–Ω–∞—Ç—É.

**–ö–æ–¥:**
```typescript
export async function POST(request: NextRequest, { params }) {
  const { room_id } = await params;
  const formData = await request.formData();
  const file = formData.get('file') as File;
  
  // –ó–∞–≥—Ä—É–∂–∞–µ–º –≤ S3
  const filePath = `tour-rooms/${room_id}/${Date.now()}-${file.name}`;
  const uploadResult = await uploadToS3(file, filePath);
  
  // –°–æ—Ö—Ä–∞–Ω—è–µ–º –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –≤ –ë–î
  const { data: media } = await serviceClient
    .from('tour_room_media')
    .insert({
      room_id,
      user_id: user.id,
      media_type: file.type.startsWith('video/') ? 'video' : 'image',
      media_url: uploadResult.url,
      media_path: filePath,
      file_name: file.name,
      file_size: file.size,
      mime_type: file.type,
      is_temporary: true
    })
    .select()
    .single();
  
  return NextResponse.json({ success: true, media });
}
```

---

### 6. –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞

#### `TourRoom.tsx` - –ì–ª–∞–≤–Ω—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –∫–æ–º–Ω–∞—Ç—ã
```typescript
// components/tour-rooms/TourRoom.tsx
export function TourRoom({ roomId, initialRoom }: TourRoomProps) {
  const [activeTab, setActiveTab] = useState<'chat' | 'gallery' | 'participants'>('chat');
  
  return (
    <div>
      {/* –í–∫–ª–∞–¥–∫–∏ */}
      <div className="flex border-b">
        <button onClick={() => setActiveTab('chat')}>–ß–∞—Ç</button>
        <button onClick={() => setActiveTab('gallery')}>–ì–∞–ª–µ—Ä–µ—è</button>
        <button onClick={() => setActiveTab('participants')}>–£—á–∞—Å—Ç–Ω–∏–∫–∏</button>
      </div>
      
      {/* –ö–æ–Ω—Ç–µ–Ω—Ç */}
      {activeTab === 'chat' && <TourRoomChat roomId={room.id} />}
      {activeTab === 'gallery' && <TourRoomGallery roomId={room.id} />}
      {activeTab === 'participants' && <TourRoomParticipants roomId={room.id} />}
    </div>
  );
}
```

#### `TourRoomChat.tsx` - –ö–æ–º–ø–æ–Ω–µ–Ω—Ç —á–∞—Ç–∞
```typescript
// components/tour-rooms/TourRoomChat.tsx
export function TourRoomChat({ roomId }: { roomId: string }) {
  const [messages, setMessages] = useState([]);
  const [newMessage, setNewMessage] = useState('');
  
  // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π
  useEffect(() => {
    const loadMessages = async () => {
      const response = await fetch(`/api/tour-rooms/${roomId}/messages`);
      const data = await response.json();
      setMessages(data.messages || []);
    };
    loadMessages();
  }, [roomId]);
  
  // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
  const sendMessage = async () => {
    await fetch(`/api/tour-rooms/${roomId}/messages`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ message: newMessage })
    });
    setNewMessage('');
    // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è
  };
  
  return (
    <div>
      {/* –°–ø–∏—Å–æ–∫ —Å–æ–æ–±—â–µ–Ω–∏–π */}
      <div>
        {messages.map(msg => (
          <div key={msg.id}>
            <img src={msg.user.avatar_url} />
            <span>{msg.user.first_name} {msg.user.last_name}</span>
            <p>{msg.message}</p>
          </div>
        ))}
      </div>
      
      {/* –§–æ—Ä–º–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ */}
      <input value={newMessage} onChange={(e) => setNewMessage(e.target.value)} />
      <button onClick={sendMessage}>–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
    </div>
  );
}
```

#### `TourRoomGallery.tsx` - –ö–æ–º–ø–æ–Ω–µ–Ω—Ç –≥–∞–ª–µ—Ä–µ–∏
```typescript
// components/tour-rooms/TourRoomGallery.tsx
export function TourRoomGallery({ roomId, tourEndDate }: Props) {
  const [media, setMedia] = useState([]);
  const [filter, setFilter] = useState<'temporary' | 'archived' | 'all'>('temporary');
  
  // –ó–∞–≥—Ä—É–∑–∫–∞ –º–µ–¥–∏–∞
  useEffect(() => {
    const loadMedia = async () => {
      const response = await fetch(`/api/tour-rooms/${roomId}/media?filter=${filter}`);
      const data = await response.json();
      setMedia(data.media || []);
    };
    loadMedia();
  }, [roomId, filter]);
  
  // –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞
  const uploadFile = async (file: File) => {
    const formData = new FormData();
    formData.append('file', file);
    
    await fetch(`/api/tour-rooms/${roomId}/media`, {
      method: 'POST',
      body: formData
    });
  };
  
  return (
    <div>
      {/* –§–∏–ª—å—Ç—Ä—ã */}
      <select value={filter} onChange={(e) => setFilter(e.target.value)}>
        <option value="temporary">–í—Ä–µ–º–µ–Ω–Ω—ã–µ</option>
        <option value="archived">–ê—Ä—Ö–∏–≤–Ω—ã–µ</option>
        <option value="all">–í—Å–µ</option>
      </select>
      
      {/* –°–µ—Ç–∫–∞ –º–µ–¥–∏–∞ */}
      <div className="grid grid-cols-3 gap-4">
        {media.map(item => (
          <div key={item.id}>
            {item.media_type === 'image' ? (
              <img src={item.media_url} />
            ) : (
              <video src={item.media_url} controls />
            )}
          </div>
        ))}
      </div>
      
      {/* –ó–∞–≥—Ä—É–∑–∫–∞ */}
      <input type="file" onChange={(e) => uploadFile(e.target.files[0])} />
    </div>
  );
}
```

---

### 7. –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ –≥–∏–¥–æ–≤ –≤ –∞–¥–º–∏–Ω–∫–µ

**–°—Ç—Ä–∞–Ω–∏—Ü–∞:** `/admin/tour-rooms`

**–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª:**
- –ü—Ä–æ—Å–º–æ—Ç—Ä –≤—Å–µ—Ö –∫–æ–º–Ω–∞—Ç —Ç—É—Ä–æ–≤
- –ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é —Ç—É—Ä–∞, –≥–æ—Ä–æ–¥—É, –≥–∏–¥—É
- –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ/–∏–∑–º–µ–Ω–µ–Ω–∏–µ –≥–∏–¥–∞ –¥–ª—è –∫–æ–º–Ω–∞—Ç—ã
- –ü–µ—Ä–µ—Ö–æ–¥ –≤ –∫–æ–º–Ω–∞—Ç—É —Ç—É—Ä–∞

**–ö–æ–¥:**
```typescript
// app/admin/tour-rooms/page.tsx
export default function TourRoomsPage() {
  const [rooms, setRooms] = useState([]);
  const [selectedRoom, setSelectedRoom] = useState(null);
  
  // –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ –≥–∏–¥–∞
  const assignGuide = async (roomId: string, userId: string | null) => {
    await fetch(`/api/tour-rooms?room_id=${roomId}`, {
      method: 'PATCH',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ guide_id: userId })
    });
  };
  
  return (
    <div>
      {rooms.map(room => (
        <div key={room.id}>
          <h3>{room.tour.title}</h3>
          {room.guide && <p>–ì–∏–¥: {room.guide.first_name} {room.guide.last_name}</p>}
          <button onClick={() => setSelectedRoom(room.id)}>
            {room.guide ? '–ò–∑–º–µ–Ω–∏—Ç—å –≥–∏–¥–∞' : '–ù–∞–∑–Ω–∞—á–∏—Ç—å –≥–∏–¥–∞'}
          </button>
        </div>
      ))}
    </div>
  );
}
```

**API:** `app/api/admin/tour-rooms/route.ts` - –ø–æ–ª—É—á–µ–Ω–∏–µ –≤—Å–µ—Ö –∫–æ–º–Ω–∞—Ç –¥–ª—è –∞–¥–º–∏–Ω–æ–≤

---

### 8. –ü–∞–Ω–µ–ª—å –≥–∏–¥–∞

**–°—Ç—Ä–∞–Ω–∏—Ü–∞:** `/guide`

**–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª:**
- –ü—Ä–æ—Å–º–æ—Ç—Ä –≤—Å–µ—Ö —Ç—É—Ä–æ–≤, –≥–¥–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∑–Ω–∞—á–µ–Ω –≥–∏–¥–æ–º
- –°—Ç–∞—Ç—É—Å —Ç—É—Ä–∞ (–ø—Ä–µ–¥—Å—Ç–æ–∏—Ç/–∏–¥–µ—Ç/–∑–∞–≤–µ—Ä—à–µ–Ω)
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
- –ë—ã—Å—Ç—Ä—ã–π –ø–µ—Ä–µ—Ö–æ–¥ –≤ –∫–æ–º–Ω–∞—Ç—É —Ç—É—Ä–∞

**–ö–æ–¥:**
```typescript
// app/guide/page.tsx
export default function GuidePanel() {
  const [rooms, setRooms] = useState([]);
  
  useEffect(() => {
    const loadRooms = async () => {
      const response = await fetch('/api/guide/rooms');
      const data = await response.json();
      setRooms(data.rooms || []);
    };
    loadRooms();
  }, []);
  
  return (
    <div>
      {rooms.map(room => (
        <div key={room.id}>
          <h2>{room.tour.title}</h2>
          <p>–£—á–∞—Å—Ç–Ω–∏–∫–æ–≤: {room.participants_count}</p>
          <Link href={`/tour-rooms/${room.id}`}>–û—Ç–∫—Ä—ã—Ç—å –∫–æ–º–Ω–∞—Ç—É</Link>
        </div>
      ))}
    </div>
  );
}
```

**API:** `app/api/guide/rooms/route.ts` - –ø–æ–ª—É—á–µ–Ω–∏–µ –∫–æ–º–Ω–∞—Ç –≥–¥–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —è–≤–ª—è–µ—Ç—Å—è –≥–∏–¥–æ–º

**–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ:** –°—Å—ã–ª–∫–∞ "–ü–∞–Ω–µ–ª—å –≥–∏–¥–∞" –ø–æ—è–≤–ª—è–µ—Ç—Å—è –≤ –º–µ–Ω—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏, –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —è–≤–ª—è–µ—Ç—Å—è –≥–∏–¥–æ–º —Ö–æ—Ç—è –±—ã –≤ –æ–¥–Ω–æ–π –∫–æ–º–Ω–∞—Ç–µ.

---

### 9. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∞—Ä—Ö–∏–≤–∞—Ü–∏—è –º–µ–¥–∏–∞

**–¢—Ä–∏–≥–≥–µ—Ä:** –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∞—Ä—Ö–∏–≤–∏—Ä—É–µ—Ç –≤—Ä–µ–º–µ–Ω–Ω–æ–µ –º–µ–¥–∏–∞ –ø–æ—Å–ª–µ –æ–∫–æ–Ω—á–∞–Ω–∏—è —Ç—É—Ä–∞.

```sql
-- supabase/migrations/013_tour_rooms.sql
CREATE FUNCTION archive_tour_room_media()
RETURNS TRIGGER AS $$
BEGIN
  -- –ï—Å–ª–∏ —Ç—É—Ä –∑–∞–∫–æ–Ω—á–∏–ª—Å—è, –∞—Ä—Ö–∏–≤–∏—Ä—É–µ–º –≤—Å–µ –≤—Ä–µ–º–µ–Ω–Ω–æ–µ –º–µ–¥–∏–∞
  IF NEW.end_date IS NOT NULL AND NEW.end_date < NOW() THEN
    UPDATE tour_room_media
    SET is_temporary = FALSE,
        archived_at = NOW()
    WHERE room_id IN (
      SELECT id FROM tour_rooms WHERE tour_id = NEW.id
    )
    AND is_temporary = TRUE
    AND archived_at IS NULL;
  END IF;
  
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trigger_archive_media_on_upload
  AFTER UPDATE ON tours
  FOR EACH ROW
  WHEN (OLD.end_date IS DISTINCT FROM NEW.end_date)
  EXECUTE FUNCTION archive_tour_room_media();
```

---

### 10. –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞—Ç —Ç—É—Ä–æ–≤ –ø—Ä–∏ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–∏

**–ü—Ä–æ–±–ª–µ–º–∞:** –ú–æ–∂–Ω–æ –±—ã–ª–æ –∑–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å —Ç—É—Ä, –∫–æ—Ç–æ—Ä—ã–π —É–∂–µ –∑–∞–∫–æ–Ω—á–∏–ª—Å—è.

**–†–µ—à–µ–Ω–∏–µ:** –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞—Ç –Ω–∞ –≤—Å–µ—Ö —É—Ä–æ–≤–Ω—è—Ö.

#### API `/api/bookings` (POST)
```typescript
// app/api/bookings/route.ts
// –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ç—É—Ä –µ—â–µ –Ω–µ –Ω–∞—á–∞–ª—Å—è
if (new Date(tour.start_date) < new Date()) {
  return NextResponse.json(
    { error: '–≠—Ç–æ—Ç —Ç—É—Ä —É–∂–µ –Ω–∞—á–∞–ª—Å—è –∏–ª–∏ –∑–∞–≤–µ—Ä—à–µ–Ω –∏ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –¥–ª—è –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è' },
    { status: 400 }
  );
}
```

#### –°—Ç—Ä–∞–Ω–∏—Ü–∞ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è `/booking`
```typescript
// app/booking/page.tsx
// –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–∞—Ç—ã —Ç—É—Ä–∞
const now = new Date();
const startDate = new Date(tour.start_date);
const endDate = tour.end_date ? new Date(tour.end_date) : null;

if (startDate <= now || (endDate && endDate <= now)) {
  redirect(`/tours/${tour.slug}`);
}
```

#### –°—Ç—Ä–∞–Ω–∏—Ü–∞ —Ç—É—Ä–∞ `/tours/[slug]`
```typescript
// app/tours/[slug]/page.tsx
const isTourExpired = startDate <= now || (endDate && endDate <= now);
const isTourStarted = startDate <= now;

{isTourExpired ? (
  <div>–¢—É—Ä —É–∂–µ –∑–∞–∫–æ–Ω—á–∏–ª—Å—è</div>
) : isTourStarted ? (
  <div>–¢—É—Ä —É–∂–µ –Ω–∞—á–∞–ª—Å—è</div>
) : (
  <Link href={`/booking?tour=${t.id}`}>–ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å</Link>
)}
```

---

### 11. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Å–±—Ä–æ—Å —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –ø–æ—Å–ª–µ –æ–∫–æ–Ω—á–∞–Ω–∏—è —Ç—É—Ä–∞

**–ú–∏–≥—Ä–∞—Ü–∏—è:** `supabase/migrations/014_reset_tour_participants.sql`

**–ü—Ä–æ–±–ª–µ–º–∞:** –ü–æ—Å–ª–µ –æ–∫–æ–Ω—á–∞–Ω–∏—è —Ç—É—Ä–∞ `current_participants` –Ω–µ —Å–±—Ä–∞—Å—ã–≤–∞–ª—Å—è, –Ω–µ–ª—å–∑—è –±—ã–ª–æ —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä —Ç—É—Ä–∞.

**–†–µ—à–µ–Ω–∏–µ:** –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Å–±—Ä–æ—Å —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –¥–∞—Ç –∏–ª–∏ –ø–æ—Å–ª–µ –æ–∫–æ–Ω—á–∞–Ω–∏—è —Ç—É—Ä–∞.

```sql
-- –§—É–Ω–∫—Ü–∏—è —Å–±—Ä–æ—Å–∞ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
CREATE FUNCTION reset_completed_tour_participants()
RETURNS INTEGER AS $$
BEGIN
  UPDATE tours
  SET current_participants = 0
  WHERE end_date IS NOT NULL
    AND end_date < NOW()
    AND current_participants > 0
    AND status = 'active';
  
  RETURN ROW_COUNT;
END;
$$ LANGUAGE plpgsql;

-- –¢—Ä–∏–≥–≥–µ—Ä –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Å–±—Ä–æ—Å–∞
CREATE TRIGGER trigger_reset_participants_on_date_change
  BEFORE UPDATE ON tours
  FOR EACH ROW
  WHEN (
    (OLD.end_date IS DISTINCT FROM NEW.end_date) OR
    (NEW.end_date IS NOT NULL AND NEW.end_date < NOW() AND NEW.current_participants > 0)
  )
  EXECUTE FUNCTION check_and_reset_tour_on_date_change();
```

**–õ–æ–≥–∏–∫–∞:**
- –ï—Å–ª–∏ –∞–¥–º–∏–Ω –∏–∑–º–µ–Ω–∏–ª `end_date` –Ω–∞ –±—É–¥—É—â—É—é –¥–∞—Ç—É ‚Üí —Å–±—Ä–æ—Å —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ (–Ω–æ–≤—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä)
- –ï—Å–ª–∏ —Ç—É—Ä –∑–∞–≤–µ—Ä—à–∏–ª—Å—è (`end_date < NOW()`) ‚Üí –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Å–±—Ä–æ—Å —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤

---

### 12. –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã—Ö —Ç—É—Ä–æ–≤

**–ü—Ä–æ–±–ª–µ–º–∞:** –ó–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ —Ç—É—Ä—ã –æ—Ç–æ–±—Ä–∞–∂–∞–ª–∏—Å—å –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ `/tours`.

**–†–µ—à–µ–Ω–∏–µ:** –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –Ω–∞ —É—Ä–æ–≤–Ω–µ –ë–î –∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.

```typescript
// app/api/tours/filter/route.ts
const now = new Date().toISOString();
let query = supabase
  .from('tours')
  .select(`...`)
  .eq('status', 'active')
  .or(`end_date.is.null,end_date.gte.${now}`); // –ò—Å–∫–ª—é—á–∞–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ

// –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –Ω–∞ —É—Ä–æ–≤–Ω–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
const activeTours = tours.filter((tour) => {
  if (!tour.end_date) return true;
  return new Date(tour.end_date) >= new Date();
});
```

**–§–∞–π–ª—ã:**
- `app/api/tours/filter/route.ts`
- `components/home/FeaturedTours.tsx`

---

### –§–∞–π–ª—ã —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

**–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö:**
- `supabase/migrations/013_tour_rooms.sql` - —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –∫–æ–º–Ω–∞—Ç, —á–∞—Ç–∞, –≥–∞–ª–µ—Ä–µ–∏
- `supabase/migrations/014_reset_tour_participants.sql` - —Å–±—Ä–æ—Å —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤

**API:**
- `app/api/tour-rooms/route.ts` - –ø–æ–ª—É—á–µ–Ω–∏–µ/—Å–æ–∑–¥–∞–Ω–∏–µ –∫–æ–º–Ω–∞—Ç
- `app/api/tour-rooms/[room_id]/messages/route.ts` - —Å–æ–æ–±—â–µ–Ω–∏—è —á–∞—Ç–∞
- `app/api/tour-rooms/[room_id]/messages/[message_id]/route.ts` - —É–¥–∞–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π
- `app/api/tour-rooms/[room_id]/media/route.ts` - –º–µ–¥–∏–∞ –≥–∞–ª–µ—Ä–µ—è
- `app/api/tour-rooms/[room_id]/media/[media_id]/route.ts` - —É–¥–∞–ª–µ–Ω–∏–µ –º–µ–¥–∏–∞
- `app/api/tour-rooms/[room_id]/participants/route.ts` - —É—á–∞—Å—Ç–Ω–∏–∫–∏
- `app/api/admin/tour-rooms/route.ts` - —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–º–Ω–∞—Ç–∞–º–∏ (–∞–¥–º–∏–Ω)
- `app/api/guide/rooms/route.ts` - –∫–æ–º–Ω–∞—Ç—ã –≥–∏–¥–∞

**–ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:**
- `components/tour-rooms/TourRoom.tsx` - –≥–ª–∞–≤–Ω—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –∫–æ–º–Ω–∞—Ç—ã
- `components/tour-rooms/TourRoomChat.tsx` - –∫–æ–º–ø–æ–Ω–µ–Ω—Ç —á–∞—Ç–∞
- `components/tour-rooms/TourRoomGallery.tsx` - –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –≥–∞–ª–µ—Ä–µ–∏
- `components/tour-rooms/TourRoomParticipants.tsx` - —Å–ø–∏—Å–æ–∫ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤

**–°—Ç—Ä–∞–Ω–∏—Ü—ã:**
- `app/tour-rooms/[room_id]/page.tsx` - —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –∫–æ–º–Ω–∞—Ç—ã —Ç—É—Ä–∞
- `app/admin/tour-rooms/page.tsx` - —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–º–Ω–∞—Ç–∞–º–∏ (–∞–¥–º–∏–Ω)
- `app/guide/page.tsx` - –ø–∞–Ω–µ–ª—å –≥–∏–¥–∞

**–¢–∏–ø—ã:**
- `types/index.ts` - –¥–æ–±–∞–≤–ª–µ–Ω—ã `TourRoom`, `TourRoomMessage`, `TourRoomMedia`, `TourRoomParticipant`

---

## üöÄ –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ (–î–µ–∫–∞–±—Ä—å 2024)

### –ü—Ä–æ–±–ª–µ–º–∞: –ú–µ–¥–ª–µ–Ω–Ω–∞—è —Ä–∞–±–æ—Ç–∞ —Å–∞–π—Ç–∞

–°–∞–π—Ç —Ä–∞–±–æ—Ç–∞–ª –æ—á–µ–Ω—å –º–µ–¥–ª–µ–Ω–Ω–æ –∏–∑-–∑–∞ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –ø—Ä–æ–±–ª–µ–º –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏:
1. N+1 –ø—Ä–æ–±–ª–µ–º–∞ –≤ –∑–∞–ø—Ä–æ—Å–∞—Ö –∫ –ë–î
2. –ú–µ–¥–ª–µ–Ω–Ω—ã–µ `count: 'exact'` –∑–∞–ø—Ä–æ—Å—ã
3. –ó–∞–≥—Ä—É–∑–∫–∞ –≤—Å–µ—Ö –ø–æ–ª–µ–π (`select('*')`) –≤–º–µ—Å—Ç–æ –Ω—É–∂–Ω—ã—Ö
4. –õ–∏—à–Ω–∏–µ –∑–∞–ø—Ä–æ—Å—ã –∫ API –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
5. –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è

### –†–µ—à–µ–Ω–∏–µ: –ö–æ–º–ø–ª–µ–∫—Å–Ω–∞—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è

#### 1. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ N+1 –ø—Ä–æ–±–ª–µ–º–∞ –≤ `/api/admin/tour-rooms`

**–ü—Ä–æ–±–ª–µ–º–∞:** –î–ª—è –∫–∞–∂–¥–æ–π –∫–æ–º–Ω–∞—Ç—ã –≤—ã–ø–æ–ª–Ω—è–ª—Å—è –æ—Ç–¥–µ–ª—å–Ω—ã–π –∑–∞–ø—Ä–æ—Å –¥–ª—è –ø–æ–¥—Å—á–µ—Ç–∞ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤.

**–ë—ã–ª–æ (–º–µ–¥–ª–µ–Ω–Ω–æ):**
```typescript
// N –∑–∞–ø—Ä–æ—Å–æ–≤ - –æ—á–µ–Ω—å –º–µ–¥–ª–µ–Ω–Ω–æ!
const roomsWithCounts = await Promise.all(
  rooms.map(async (room) => {
    const { count } = await serviceClient
      .from('tour_room_participants')
      .select('*', { count: 'exact', head: true })
      .eq('room_id', room.id);
    return { ...room, participants_count: count || 0 };
  })
);
```

**–°—Ç–∞–ª–æ (–±—ã—Å—Ç—Ä–æ):**
```typescript
// 1 –∑–∞–ø—Ä–æ—Å –¥–ª—è –≤—Å–µ—Ö –∫–æ–º–Ω–∞—Ç - –±—ã—Å—Ç—Ä–æ!
const roomIds = rooms.map((r: any) => r.id);
const { data: participantsData } = await serviceClient
  .from('tour_room_participants')
  .select('room_id')
  .in('room_id', roomIds);

// –ü–æ–¥—Å—á–µ—Ç –≤ –ø–∞–º—è—Ç–∏
const participantsCounts = participantsData.reduce((acc, p) => {
  acc[p.room_id] = (acc[p.room_id] || 0) + 1;
  return acc;
}, {});
```

**–§–∞–π–ª:** `app/api/admin/tour-rooms/route.ts`

---

#### 2. –£–±—Ä–∞–Ω –º–µ–¥–ª–µ–Ω–Ω—ã–π `count: 'exact'` –∏–∑ `/api/tours/filter`

**–ü—Ä–æ–±–ª–µ–º–∞:** `count: 'exact'` –≤—ã–ø–æ–ª–Ω—è–µ—Ç –ø–æ–ª–Ω—ã–π –ø–æ–¥—Å—á–µ—Ç –≤—Å–µ—Ö —Å—Ç—Ä–æ–∫, —á—Ç–æ –æ—á–µ–Ω—å –º–µ–¥–ª–µ–Ω–Ω–æ –Ω–∞ –±–æ–ª—å—à–∏—Ö —Ç–∞–±–ª–∏—Ü–∞—Ö.

**–ë—ã–ª–æ:**
```typescript
.select(`...`, { count: 'exact' })
const { data: tours, error, count } = await query;
```

**–°—Ç–∞–ª–æ:**
```typescript
.select(`...`) // –ë–µ–∑ count
// –ü—Ä–∏–±–ª–∏–∑–∏—Ç–µ–ª—å–Ω—ã–π –ø–æ–¥—Å—á–µ—Ç –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø–∞–≥–∏–Ω–∞—Ü–∏–∏
const hasMore = activeTours.length === limit;
const estimatedTotal = hasMore ? (page * limit) + 1 : activeTours.length;
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –£—Å–∫–æ—Ä–µ–Ω–∏–µ –≤ 10-100 —Ä–∞–∑ –¥–ª—è –±–æ–ª—å—à–∏—Ö —Ç–∞–±–ª–∏—Ü.

**–§–∞–π–ª:** `app/api/tours/filter/route.ts`

---

#### 3. –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω `FeaturedTours` - –≤—ã–±–æ—Ä —Ç–æ–ª—å–∫–æ –Ω—É–∂–Ω—ã—Ö –ø–æ–ª–µ–π

**–ü—Ä–æ–±–ª–µ–º–∞:** `select('*')` –∑–∞–≥—Ä—É–∂–∞–µ—Ç –≤—Å–µ –ø–æ–ª—è, –≤–∫–ª—é—á–∞—è –±–æ–ª—å—à–∏–µ —Ç–µ–∫—Å—Ç–æ–≤—ã–µ –ø–æ–ª—è.

**–ë—ã–ª–æ:**
```typescript
const { data: tours } = await supabase
  .from('tours')
  .select('*') // –ó–∞–≥—Ä—É–∂–∞–µ—Ç –í–°–ï –ø–æ–ª—è
```

**–°—Ç–∞–ª–æ:**
```typescript
const { data: tours } = await supabase
  .from('tours')
  .select(`
    id, title, slug, short_desc, cover_image,
    price_per_person, start_date, end_date,
    max_participants, current_participants,
    tour_type, category
  `) // –¢–æ–ª—å–∫–æ –Ω—É–∂–Ω—ã–µ –ø–æ–ª—è
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ú–µ–Ω—å—à–µ –¥–∞–Ω–Ω—ã—Ö –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è –ø–æ —Å–µ—Ç–∏, –±—ã—Å—Ç—Ä–µ–µ –ø–∞—Ä—Å–∏–Ω–≥.

**–§–∞–π–ª:** `components/home/FeaturedTours.tsx`

---

#### 4. –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω Admin Dashboard - count —Ç–æ–ª—å–∫–æ –ø–æ `id`

**–ü—Ä–æ–±–ª–µ–º–∞:** `select('*', { count: 'exact' })` –∑–∞–≥—Ä—É–∂–∞–µ—Ç –≤—Å–µ –ø–æ–ª—è –¥–ª—è –ø–æ–¥—Å—á–µ—Ç–∞.

**–ë—ã–ª–æ:**
```typescript
supabase.from('profiles').select('*', { count: 'exact', head: true })
supabase.from('tours').select('*', { count: 'exact', head: true })
// ... –∏ —Ç.–¥.
```

**–°—Ç–∞–ª–æ:**
```typescript
supabase.from('profiles').select('id', { count: 'exact', head: true })
supabase.from('tours').select('id', { count: 'exact', head: true })
// ... —Ç–æ–ª—å–∫–æ id –¥–ª—è –ø–æ–¥—Å—á–µ—Ç–∞
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ú–µ–Ω—å—à–µ –¥–∞–Ω–Ω—ã—Ö –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è, –±—ã—Å—Ç—Ä–µ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ.

**–§–∞–π–ª:** `app/admin/page.tsx`

---

#### 5. –£–±—Ä–∞–Ω—ã –ª–∏—à–Ω–∏–µ –∑–∞–ø—Ä–æ—Å—ã –∫ `/api/log` –≤ `UserMenu`

**–ü—Ä–æ–±–ª–µ–º–∞:** –ö–∞–∂–¥—ã–π —Ä–µ–Ω–¥–µ—Ä –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞ –æ—Ç–ø—Ä–∞–≤–ª—è–ª –∑–∞–ø—Ä–æ—Å—ã –Ω–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ, –∑–∞–º–µ–¥–ª—è—è –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å.

**–ë—ã–ª–æ:**
```typescript
fetch('/api/log', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ tag: 'UserMenu', ... })
}).catch(() => {});
// –ú–Ω–æ–∂–µ—Å—Ç–≤–æ —Ç–∞–∫–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –Ω–∞ –∫–∞–∂–¥–æ–º —Ä–µ–Ω–¥–µ—Ä–µ
```

**–°—Ç–∞–ª–æ:**
```typescript
// –£–±—Ä–∞–Ω–æ –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ - –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–∫–ª—é—á–µ–Ω–æ
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –£–±—Ä–∞–Ω—ã –≤—Å–µ –ª–∏—à–Ω–∏–µ HTTP –∑–∞–ø—Ä–æ—Å—ã, –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å —Ä–∞–±–æ—Ç–∞–µ—Ç –±—ã—Å—Ç—Ä–µ–µ.

**–§–∞–π–ª:** `components/layout/UserMenu.tsx`

---

#### 6. –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω –∑–∞–ø—Ä–æ—Å —Ç—É—Ä–∞ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ `[slug]`

**–ë—ã–ª–æ:**
```typescript
const { data: tour } = await supabase
  .from('tours')
  .select('*') // –í—Å–µ –ø–æ–ª—è
```

**–°—Ç–∞–ª–æ:**
```typescript
const { data: tour } = await supabase
  .from('tours')
  .select(`
    id, title, slug, description, short_desc, full_desc,
    cover_image, price_per_person, start_date, end_date,
    max_participants, current_participants, tour_type,
    category, yandex_map_data, city:cities(id, name)
  `) // –¢–æ–ª—å–∫–æ –Ω—É–∂–Ω—ã–µ –ø–æ–ª—è
```

**–§–∞–π–ª:** `app/tours/[slug]/page.tsx`

---

#### 7. –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–∞ –∑–∞–≥—Ä—É–∑–∫–∞ –∫–æ–º–Ω–∞—Ç –≤ `UserBookings`

**–ü—Ä–æ–±–ª–µ–º–∞:** –ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –∫–æ–º–Ω–∞—Ç –≤ —Ü–∏–∫–ª–µ.

**–ë—ã–ª–æ:**
```typescript
for (const booking of confirmedBookings) {
  await fetch(`/api/tour-rooms?tour_id=${booking.tour_id}`);
}
```

**–°—Ç–∞–ª–æ:**
```typescript
const roomPromises = confirmedBookings.map(async (booking) => {
  return await fetch(`/api/tour-rooms?tour_id=${booking.tour_id}`);
});
await Promise.all(roomPromises); // –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –í—Å–µ –∫–æ–º–Ω–∞—Ç—ã –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ, –∞ –Ω–µ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ.

**–§–∞–π–ª:** `components/profile/UserBookings.tsx`

---

#### 8. –î–æ–±–∞–≤–ª–µ–Ω–æ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ API `/api/tours/filter`

**–î–æ–±–∞–≤–ª–µ–Ω–æ:**
```typescript
// –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞ –Ω–∞ 30 —Å–µ–∫—É–Ω–¥ –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
export const revalidate = 30;
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ü–æ–≤—Ç–æ—Ä–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã —Å —Ç–µ–º–∏ –∂–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏ –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç—Å—è –∏–∑ –∫—ç—à–∞.

**–§–∞–π–ª:** `app/api/tours/filter/route.ts`

---

#### 9. –î–æ–±–∞–≤–ª–µ–Ω—ã –∏–Ω–¥–µ–∫—Å—ã –ë–î –¥–ª—è —É—Å–∫–æ—Ä–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤

**–°–æ–∑–¥–∞–Ω–∞ –º–∏–≥—Ä–∞—Ü–∏—è:** `supabase/migrations/015_performance_indexes.sql`

**–î–æ–±–∞–≤–ª–µ–Ω–Ω—ã–µ –∏–Ω–¥–µ–∫—Å—ã:**
- `idx_tours_status_end_date` - –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –∞–∫—Ç–∏–≤–Ω—ã—Ö —Ç—É—Ä–æ–≤ –ø–æ –¥–∞—Ç–µ
- `idx_tours_title_trgm` - GIN –∏–Ω–¥–µ–∫—Å –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é
- `idx_tour_room_participants_room_id` - –¥–ª—è –ø–æ–¥—Å—á–µ—Ç–∞ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
- `idx_bookings_user_id` - –¥–ª—è –ø–æ–∏—Å–∫–∞ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- `idx_cities_name_trgm` - –¥–ª—è –ø–æ–∏—Å–∫–∞ –≥–æ—Ä–æ–¥–æ–≤
- –ò –¥—Ä—É–≥–∏–µ –∏–Ω–¥–µ–∫—Å—ã –¥–ª—è —á–∞—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö –ø–æ–ª–µ–π

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –£—Å–∫–æ—Ä–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ 10-100 —Ä–∞–∑ –±–ª–∞–≥–æ–¥–∞—Ä—è –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º –∏–Ω–¥–µ–∫—Å–∞–º.

---

### –ò—Ç–æ–≥–æ–≤—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

‚úÖ **–£—Å—Ç—Ä–∞–Ω–µ–Ω–∞ N+1 –ø—Ä–æ–±–ª–µ–º–∞** - –≤–º–µ—Å—Ç–æ N –∑–∞–ø—Ä–æ—Å–æ–≤ —Ç–µ–ø–µ—Ä—å 1 –∑–∞–ø—Ä–æ—Å  
‚úÖ **–£–±—Ä–∞–Ω –º–µ–¥–ª–µ–Ω–Ω—ã–π count** - —É—Å–∫–æ—Ä–µ–Ω–∏–µ –≤ 10-100 —Ä–∞–∑  
‚úÖ **–û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω—ã SELECT –∑–∞–ø—Ä–æ—Å—ã** - –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –Ω—É–∂–Ω—ã–µ –ø–æ–ª—è  
‚úÖ **–£–±—Ä–∞–Ω—ã –ª–∏—à–Ω–∏–µ –∑–∞–ø—Ä–æ—Å—ã** - –Ω–µ—Ç –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ `/api/log`  
‚úÖ **–î–æ–±–∞–≤–ª–µ–Ω–æ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ** - –ø–æ–≤—Ç–æ—Ä–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –±—ã—Å—Ç—Ä–µ–µ  
‚úÖ **–î–æ–±–∞–≤–ª–µ–Ω—ã –∏–Ω–¥–µ–∫—Å—ã –ë–î** - —É—Å–∫–æ—Ä–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ 10-100 —Ä–∞–∑  
‚úÖ **–ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞** - –≤–º–µ—Å—Ç–æ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ–π  

### –§–∞–π–ª—ã –∏–∑–º–µ–Ω–µ–Ω–∏–π

- `app/api/admin/tour-rooms/route.ts` - –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ N+1 –ø—Ä–æ–±–ª–µ–º–∞
- `app/api/tours/filter/route.ts` - —É–±—Ä–∞–Ω count, –¥–æ–±–∞–≤–ª–µ–Ω–æ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ
- `components/home/FeaturedTours.tsx` - –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω SELECT
- `app/admin/page.tsx` - –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω count
- `components/layout/UserMenu.tsx` - —É–±—Ä–∞–Ω—ã –∑–∞–ø—Ä–æ—Å—ã –∫ /api/log
- `app/tours/[slug]/page.tsx` - –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω SELECT
- `components/profile/UserBookings.tsx` - –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞
- `supabase/migrations/015_performance_indexes.sql` - –¥–æ–±–∞–≤–ª–µ–Ω—ã –∏–Ω–¥–µ–∫—Å—ã

---

---

## üéØ –ü–∞–Ω–µ–ª—å –≥–∏–¥–∞ –∏ —Å–∏—Å—Ç–µ–º–∞ —á–∞—Ç–∞ –≤ –∫–æ–º–Ω–∞—Ç–∞—Ö —Ç—É—Ä–æ–≤

### üìã –û–±–∑–æ—Ä

–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –¥–ª—è –≥–∏–¥–æ–≤ —Å –ø–∞–Ω–µ–ª—å—é —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∏ real-time —á–∞—Ç–æ–º –≤ –∫–æ–º–Ω–∞—Ç–∞—Ö —Ç—É—Ä–æ–≤. –ì–∏–¥—ã –º–æ–≥—É—Ç —É–ø—Ä–∞–≤–ª—è—Ç—å –Ω–∞–∑–Ω–∞—á–µ–Ω–Ω—ã–º–∏ –∏–º —Ç—É—Ä–∞–º–∏, –æ–±—â–∞—Ç—å—Å—è —Å —É—á–∞—Å—Ç–Ω–∏–∫–∞–º–∏ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏, –∑–∞–≥—Ä—É–∂–∞—Ç—å –º–µ–¥–∏–∞ –∏ –ø—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤.

### üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

#### 1. –†–æ–ª—å –≥–∏–¥–∞ –≤ —Å–∏—Å—Ç–µ–º–µ

**–ú–∏–≥—Ä–∞—Ü–∏—è:** `supabase/migrations/016_add_guide_role.sql`

```sql
-- –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ä–æ–ª–∏ 'guide' –≤ enum user_role
ALTER TYPE user_role ADD VALUE IF NOT EXISTS 'guide';
```

**–ö–æ–º–∞–Ω–¥–∞ –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –º–∏–≥—Ä–∞—Ü–∏–∏:**
```bash
# –í Supabase Dashboard –∏–ª–∏ —á–µ—Ä–µ–∑ CLI
supabase migration up
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –í —Å–∏—Å—Ç–µ–º–µ –ø–æ—è–≤–∏–ª–∞—Å—å –Ω–æ–≤–∞—è —Ä–æ–ª—å `guide`, –∫–æ—Ç–æ—Ä–∞—è –ø–æ–∑–≤–æ–ª—è–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º –±—ã—Ç—å –Ω–∞–∑–Ω–∞—á–µ–Ω–Ω—ã–º–∏ –≥–∏–¥–∞–º–∏ –¥–ª—è —Ç—É—Ä–æ–≤.

#### 2. –î–æ—Å—Ç—É–ø –≥–∏–¥–æ–≤ –∫ –∫–æ–º–Ω–∞—Ç–∞–º —Ç—É—Ä–æ–≤

**–ú–∏–≥—Ä–∞—Ü–∏—è:** `supabase/migrations/017_add_guide_access_to_rooms.sql`

–≠—Ç–∞ –º–∏–≥—Ä–∞—Ü–∏—è –æ–±–Ω–æ–≤–ª—è–µ—Ç RLS (Row Level Security) –ø–æ–ª–∏—Ç–∏–∫–∏ –¥–ª—è —Å–ª–µ–¥—É—é—â–∏—Ö —Ç–∞–±–ª–∏—Ü:
- `tour_rooms` - –≥–∏–¥—ã –º–æ–≥—É—Ç –≤–∏–¥–µ—Ç—å –∫–æ–º–Ω–∞—Ç—ã, –≥–¥–µ –æ–Ω–∏ –Ω–∞–∑–Ω–∞—á–µ–Ω—ã
- `tour_room_participants` - –≥–∏–¥—ã –º–æ–≥—É—Ç –≤–∏–¥–µ—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
- `tour_room_messages` - –≥–∏–¥—ã –º–æ–≥—É—Ç –≤–∏–¥–µ—Ç—å –∏ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è
- `tour_room_media` - –≥–∏–¥—ã –º–æ–≥—É—Ç –≤–∏–¥–µ—Ç—å –∏ –∑–∞–≥—Ä—É–∂–∞—Ç—å –º–µ–¥–∏–∞

**–ö–æ–º–∞–Ω–¥–∞ –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è:**
```bash
supabase migration up
```

**–ö–ª—é—á–µ–≤—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è:**
- –ì–∏–¥—ã –∏–º–µ—é—Ç –¥–æ—Å—Ç—É–ø –∫ –∫–æ–º–Ω–∞—Ç–∞–º, –≥–¥–µ `guide_id = auth.uid()`
- –ì–∏–¥—ã –º–æ–≥—É—Ç –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è –≤ —Å–≤–æ–∏ –∫–æ–º–Ω–∞—Ç—ã
- –ì–∏–¥—ã –º–æ–≥—É—Ç –∑–∞–≥—Ä—É–∂–∞—Ç—å –º–µ–¥–∏–∞ –≤ —Å–≤–æ–∏ –∫–æ–º–Ω–∞—Ç—ã
- –ê–¥–º–∏–Ω—ã –º–æ–≥—É—Ç –Ω–∞–∑–Ω–∞—á–∞—Ç—å –≥–∏–¥–æ–≤ —á–µ—Ä–µ–∑ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å

### üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ–∞–π–ª–æ–≤

#### –ü–∞–Ω–µ–ª—å –≥–∏–¥–∞

**–§–∞–π–ª:** `app/guide/page.tsx`

**–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å:**
- –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤—Å–µ—Ö –∫–æ–º–Ω–∞—Ç, –≥–¥–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∑–Ω–∞—á–µ–Ω –≥–∏–¥–æ–º
- –°—Ç–∞—Ç—É—Å—ã —Ç—É—Ä–æ–≤ (–ò–¥–µ—Ç —Å–µ–π—á–∞—Å, –ó–∞–≤–µ—Ä—à–µ–Ω, –ü—Ä–µ–¥—Å—Ç–æ–∏—Ç)
- –°—á–µ—Ç—á–∏–∫ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
- –°—á–µ—Ç—á–∏–∫ –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
- –ü–µ—Ä–µ—Ö–æ–¥ –≤ –∫–æ–º–Ω–∞—Ç—É —Ç—É—Ä–∞

**API Endpoint:** `GET /api/guide/rooms`

**–§–∞–π–ª:** `app/api/guide/rooms/route.ts`

**–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è:**
- –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ N+1 –ø—Ä–æ–±–ª–µ–º–∞ –ø—Ä–∏ –ø–æ–¥—Å—á–µ—Ç–µ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
- –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
- –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤

#### –ö–æ–º–ø–æ–Ω–µ–Ω—Ç —á–∞—Ç–∞

**–§–∞–π–ª:** `components/tour-rooms/TourRoomChat.tsx`

**–¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏:**
- **Pusher** –¥–ª—è real-time –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
- **React Hooks** –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º
- **react-hot-toast** –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
- **XSS –∑–∞—â–∏—Ç–∞** —á–µ—Ä–µ–∑ `escapeHtml` –∏ `sanitizeText`

**–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å:**
- Real-time –æ—Ç–ø—Ä–∞–≤–∫–∞ –∏ –ø–æ–ª—É—á–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π
- –ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –≤ —Å–æ–æ–±—â–µ–Ω–∏—è
- –£–¥–∞–ª–µ–Ω–∏–µ —Å–≤–æ–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
- –£—Å–ª–æ–≤–Ω–∞—è –ø—Ä–æ–∫—Ä—É—Ç–∫–∞ (–Ω–µ –ø—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)
- –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∞–≤–∞—Ç–∞—Ä–æ–≤ –∏ –∏–º–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ —Å–æ–æ–±—â–µ–Ω–∏–π

### üîß –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞

#### 1. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π

```bash
npm install pusher pusher-js react-hot-toast
```

**–í–µ—Ä—Å–∏–∏:**
- `pusher`: ^5.2.0
- `pusher-js`: ^8.4.0
- `react-hot-toast`: –ø–æ—Å–ª–µ–¥–Ω—è—è –≤–µ—Ä—Å–∏—è

#### 2. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Pusher

**–°–æ–∑–¥–∞–Ω–∏–µ –∞–∫–∫–∞—É–Ω—Ç–∞:**
1. –ó–∞–π–¥–∏—Ç–µ –Ω–∞ [pusher.com](https://pusher.com)
2. –°–æ–∑–¥–∞–π—Ç–µ –±–µ—Å–ø–ª–∞—Ç–Ω—ã–π –∞–∫–∫–∞—É–Ω—Ç
3. –°–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—ã–π Channels app
4. –í—ã–±–µ—Ä–∏—Ç–µ –∫–ª–∞—Å—Ç–µ—Ä (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è `eu` –¥–ª—è –†–æ—Å—Å–∏–∏)

**–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤ `.env.local`:**
```env
PUSHER_APP_ID=your-app-id
NEXT_PUBLIC_PUSHER_KEY=your-key
PUSHER_SECRET=your-secret
NEXT_PUBLIC_PUSHER_CLUSTER=eu
```

**–ì–¥–µ –ø–æ–ª—É—á–∏—Ç—å:**
- App ID ‚Üí `PUSHER_APP_ID`
- Key ‚Üí `NEXT_PUBLIC_PUSHER_KEY`
- Secret ‚Üí `PUSHER_SECRET` (‚ö†Ô∏è –¥–µ—Ä–∂–∏—Ç–µ –≤ —Å–µ–∫—Ä–µ—Ç–µ!)
- Cluster ‚Üí `NEXT_PUBLIC_PUSHER_CLUSTER`

**–ë–µ—Å–ø–ª–∞—Ç–Ω—ã–π –ø–ª–∞–Ω:**
- –î–æ 200,000 —Å–æ–æ–±—â–µ–Ω–∏–π/–¥–µ–Ω—å
- 100 –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π
- –ü—É–±–ª–∏—á–Ω—ã–µ –∫–∞–Ω–∞–ª—ã (–±–µ–∑ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏)

#### 3. –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

```bash
# –í Supabase Dashboard:
# SQL Editor ‚Üí New Query ‚Üí –í—Å—Ç–∞–≤–∏—Ç—å —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –º–∏–≥—Ä–∞—Ü–∏–π

# –ò–ª–∏ —á–µ—Ä–µ–∑ CLI:
supabase migration up
```

**–ü–æ—Ä—è–¥–æ–∫ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è:**
1. `016_add_guide_role.sql` - –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ä–æ–ª–∏ guide
2. `017_add_guide_access_to_rooms.sql` - –¥–æ—Å—Ç—É–ø –≥–∏–¥–æ–≤ –∫ –∫–æ–º–Ω–∞—Ç–∞–º

### üí¨ –†–µ–∞–ª–∏–∑–∞—Ü–∏—è —á–∞—Ç–∞

#### –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ real-time —á–∞—Ç–∞

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    CLIENT (Browser)                     ‚îÇ
‚îÇ                                                         ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     ‚îÇ
‚îÇ  ‚îÇ  TourRoomChat Component                      ‚îÇ     ‚îÇ
‚îÇ  ‚îÇ  - Pusher Client (pusher-js)                ‚îÇ     ‚îÇ
‚îÇ  ‚îÇ  - –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ –∫–∞–Ω–∞–ª: tour-room-{roomId}    ‚îÇ     ‚îÇ
‚îÇ  ‚îÇ  - –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–±—ã—Ç–∏–π: new-message           ‚îÇ     ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                            ‚îÇ WebSocket
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    PUSHER CLOUD                         ‚îÇ
‚îÇ  - –ü—É–±–ª–∏—á–Ω—ã–µ –∫–∞–Ω–∞–ª—ã (–±–µ–∑ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏)                  ‚îÇ
‚îÇ  - –ö–ª–∞—Å—Ç–µ—Ä: eu/us/ap                                    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                            ‚îÇ HTTP POST
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ              SERVER (Next.js API)                       ‚îÇ
‚îÇ                                                         ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     ‚îÇ
‚îÇ  ‚îÇ  /api/pusher/trigger                         ‚îÇ     ‚îÇ
‚îÇ  ‚îÇ  - –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–∞                          ‚îÇ     ‚îÇ
‚îÇ  ‚îÇ  - –°–æ–∑–¥–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ –ë–î                   ‚îÇ     ‚îÇ
‚îÇ  ‚îÇ  - –¢—Ä–∏–≥–≥–µ—Ä Pusher —Å–æ–±—ã—Ç–∏—è                    ‚îÇ     ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                            ‚îÇ SQL
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ              SUPABASE (PostgreSQL)                      ‚îÇ
‚îÇ  - tour_room_messages                                   ‚îÇ
‚îÇ  - RLS –ø–æ–ª–∏—Ç–∏–∫–∏ –¥–ª—è –≥–∏–¥–æ–≤                               ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

#### API Endpoints

**1. –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è:**
```
POST /api/pusher/trigger
Content-Type: application/json

{
  "roomId": "uuid",
  "message": "—Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è" | null,
  "imageUrl": "url –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è" | null,
  "imagePath": "s3 –ø—É—Ç—å" | null
}
```

**–ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–∞:**
- –£—á–∞—Å—Ç–Ω–∏–∫ –∫–æ–º–Ω–∞—Ç—ã (`tour_room_participants`)
- –ì–∏–¥ –∫–æ–º–Ω–∞—Ç—ã (`tour_rooms.guide_id`)
- –ê–¥–º–∏–Ω (`tour_admin` –∏–ª–∏ `super_admin`)

**2. –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π:**
```
GET /api/tour-rooms/{room_id}/messages?limit=100&page=1
```

**3. –ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è:**
```
POST /api/tour-rooms/{room_id}/messages/upload-image
Content-Type: multipart/form-data

file: File
```

**4. –£–¥–∞–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è:**
```
DELETE /api/tour-rooms/{room_id}/messages/{message_id}
```

#### –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —á–∞—Ç–∞

**TourRoomChat.tsx** - –æ—Å–Ω–æ–≤–Ω–æ–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç —á–∞—Ç–∞

**–°–æ—Å—Ç–æ—è–Ω–∏–µ:**
- `messages` - –º–∞—Å—Å–∏–≤ —Å–æ–æ–±—â–µ–Ω–∏–π
- `newMessage` - —Ç–µ–∫—Å—Ç –Ω–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
- `connected` - —Å—Ç–∞—Ç—É—Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ Pusher
- `selectedImage` - –≤—ã–±—Ä–∞–Ω–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏
- `uploadingImage` - —Å—Ç–∞—Ç—É—Å –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è

**–ú–µ—Ç–æ–¥—ã:**
- `loadMessages()` - –∑–∞–≥—Ä—É–∑–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –∏–∑ –ë–î
- `sendMessage()` - –æ—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è —á–µ—Ä–µ–∑ Pusher
- `uploadImage()` - –∑–∞–≥—Ä—É–∑–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ S3
- `deleteMessage()` - —É–¥–∞–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è

**Pusher —Å–æ–±—ã—Ç–∏—è:**
- `new-message` - –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –∫–æ–º–Ω–∞—Ç–µ
- `message-deleted` - —Å–æ–æ–±—â–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ
- `pusher:subscription_succeeded` - —É—Å–ø–µ—à–Ω–∞—è –ø–æ–¥–ø–∏—Å–∫–∞
- `pusher:subscription_error` - –æ—à–∏–±–∫–∞ –ø–æ–¥–ø–∏—Å–∫–∏

### üé® UI/UX –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏

#### –î–∏–∑–∞–π–Ω —á–∞—Ç–∞

**–°—Ç–∏–ª—å:** Messenger-style (–∫–∞–∫ –≤ –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä–∞—Ö)

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
- –°–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å–ø—Ä–∞–≤–∞ (–∑–µ–ª–µ–Ω—ã–µ)
- –°–æ–æ–±—â–µ–Ω–∏—è –¥—Ä—É–≥–∏—Ö —Å–ª–µ–≤–∞ (–±–µ–ª—ã–µ)
- –ê–≤–∞—Ç–∞—Ä—ã –¥–ª—è –¥—Ä—É–≥–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- –ü–æ–∫–∞–∑ –∏–º–µ–Ω–∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è
- –í—Ä–µ–º–µ–Ω–Ω—ã–µ –º–µ—Ç–∫–∏ —Å –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–º –≤—Ä–µ–º–µ–Ω–µ–º
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–∫—Ä—ã—Ç–∏–µ –ø–æ–≤—Ç–æ—Ä—è—é—â–∏—Ö—Å—è —ç–ª–µ–º–µ–Ω—Ç–æ–≤

**–£—Å–ª–æ–≤–Ω–∞—è –ø—Ä–æ–∫—Ä—É—Ç–∫–∞:**
- –ü—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã - –ø—Ä–æ–∫—Ä—É—Ç–∫–∞ –≤–≤–µ—Ä—Ö (—Å—Ç–∞—Ä—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è)
- –ü—Ä–∏ –Ω–æ–≤–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏ - –Ω–µ –ø—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–∞–º —Ä–µ—à–∞–µ—Ç, –Ω—É–∂–Ω–æ –ª–∏ –ø—Ä–æ–∫—Ä—É—á–∏–≤–∞—Ç—å

#### –ó–∞—â–∏—Ç–∞ –æ—Ç XSS

**–ò—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:**
- `escapeHtml()` - —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ HTML —Å–∏–º–≤–æ–ª–æ–≤
- `sanitizeText()` - —Å–∞–Ω–∏—Ç–∏–∑–∞—Ü–∏—è —Ç–µ–∫—Å—Ç–∞ –ø–µ—Ä–µ–¥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º

**–ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ:**
- –í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ —ç–∫—Ä–∞–Ω–∏—Ä—É—é—Ç—Å—è –ø–µ—Ä–µ–¥ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º
- –¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏–π —Å–∞–Ω–∏—Ç–∏–∑–∏—Ä—É–µ—Ç—Å—è –ø–µ—Ä–µ–¥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –≤ –ë–î

### üìä –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö

#### –¢–∞–±–ª–∏—Ü–∞ tour_room_messages

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞:**
```sql
CREATE TABLE tour_room_messages (
  id UUID PRIMARY KEY,
  room_id UUID REFERENCES tour_rooms(id),
  user_id UUID REFERENCES profiles(id),
  message TEXT, -- –ú–æ–∂–µ—Ç –±—ã—Ç—å NULL (—Ç–æ–ª—å–∫–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ)
  image_url TEXT, -- URL –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
  image_path TEXT, -- –ü—É—Ç—å –≤ S3 –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è
  created_at TIMESTAMP,
  deleted_at TIMESTAMP
);
```

**–ú–∏–≥—Ä–∞—Ü–∏—è:** `supabase/migrations/018_add_message_images_and_auto_delete.sql`

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
- `message` –º–æ–∂–µ—Ç –±—ã—Ç—å `NULL` (—Ç–æ–ª—å–∫–æ —Ñ–æ—Ç–æ)
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –ø–æ—Å–ª–µ –æ–∫–æ–Ω—á–∞–Ω–∏—è —Ç—É—Ä–∞
- –¢—Ä–∏–≥–≥–µ—Ä—ã –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ –ø–æ–ª–µ–π `image_url` –∏ `image_path`

### üîê –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

#### RLS –ø–æ–ª–∏—Ç–∏–∫–∏ –¥–ª—è –≥–∏–¥–æ–≤

**–ü—Ä–æ—Å–º–æ—Ç—Ä –∫–æ–º–Ω–∞—Ç:**
```sql
CREATE POLICY "Participants and guides can view room"
  ON tour_rooms FOR SELECT
  USING (
    EXISTS (SELECT 1 FROM tour_room_participants WHERE ...)
    OR guide_id = auth.uid()
    OR EXISTS (SELECT 1 FROM profiles WHERE role IN ('tour_admin', 'super_admin'))
  );
```

**–û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π:**
```sql
CREATE POLICY "Participants and guides can send messages"
  ON tour_room_messages FOR INSERT
  WITH CHECK (
    EXISTS (SELECT 1 FROM tour_room_participants WHERE ...)
    OR EXISTS (SELECT 1 FROM tour_rooms WHERE guide_id = auth.uid())
    OR EXISTS (SELECT 1 FROM profiles WHERE role IN ('tour_admin', 'super_admin'))
  );
```

#### –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –≤ API

–í—Å–µ API endpoints –ø—Ä–æ–≤–µ—Ä—è—é—Ç –¥–æ—Å—Ç—É–ø:
1. –£—á–∞—Å—Ç–Ω–∏–∫ –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å?
2. –ì–∏–¥ –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å?
3. –ê–¥–º–∏–Ω –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å?

–¢–æ–ª—å–∫–æ –ø—Ä–∏ –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ–º –æ—Ç–≤–µ—Ç–µ –Ω–∞ –æ–¥–∏–Ω –∏–∑ –≤–æ–ø—Ä–æ—Å–æ–≤ –¥–æ—Å—Ç—É–ø —Ä–∞–∑—Ä–µ—à–∞–µ—Ç—Å—è.

### üìù –ö–æ–º–∞–Ω–¥—ã –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏

#### –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
```bash
npm install pusher pusher-js react-hot-toast
```

#### –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π
```bash
# –í Supabase Dashboard
# SQL Editor ‚Üí New Query ‚Üí –í—Å—Ç–∞–≤–∏—Ç—å SQL –∏–∑ –º–∏–≥—Ä–∞—Ü–∏–π

# –ò–ª–∏ —á–µ—Ä–µ–∑ Supabase CLI
supabase migration up
```

#### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã
```bash
# –ó–∞–ø—É—Å–∫ dev —Å–µ—Ä–≤–µ—Ä–∞
npm run dev

# –û—Ç–∫—Ä—ã—Ç—å –≤ –±—Ä–∞—É–∑–µ—Ä–µ
# http://localhost:3000/guide - –ø–∞–Ω–µ–ª—å –≥–∏–¥–∞
# http://localhost:3000/tour-rooms/{room_id} - –∫–æ–º–Ω–∞—Ç–∞ —Ç—É—Ä–∞ —Å —á–∞—Ç–æ–º
```

### üêõ –†–µ—à–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

#### 1. –ë–µ—Å–∫–æ–Ω–µ—á–Ω–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ Socket.io
**–ü—Ä–æ–±–ª–µ–º–∞:** Socket.io –Ω–µ —Ä–∞–±–æ—Ç–∞–ª –≤ Next.js App Router  
**–†–µ—à–µ–Ω–∏–µ:** –ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞ Pusher —Å –ø—É–±–ª–∏—á–Ω—ã–º–∏ –∫–∞–Ω–∞–ª–∞–º–∏

#### 2. –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ç–æ–ª—å–∫–æ —Ñ–æ—Ç–æ
**–ü—Ä–æ–±–ª–µ–º–∞:** `message` –±—ã–ª `NOT NULL` –≤ –ë–î  
**–†–µ—à–µ–Ω–∏–µ:** –ò–∑–º–µ–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–∏ –¥–ª—è —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è `NULL` –∑–Ω–∞—á–µ–Ω–∏–π

#### 3. –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
**–ü—Ä–æ–±–ª–µ–º–∞:** –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω—è–ª–∏—Å—å –∏ –≤ —á–∞—Ç, –∏ –≤ –≥–∞–ª–µ—Ä–µ—é  
**–†–µ—à–µ–Ω–∏–µ:** –°–æ–∑–¥–∞–Ω –æ—Ç–¥–µ–ª—å–Ω—ã–π endpoint `/api/tour-rooms/{room_id}/messages/upload-image`

#### 4. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–∫—Ä—É—Ç–∫–∞
**–ü—Ä–æ–±–ª–µ–º–∞:** –°—Ç—Ä–∞–Ω–∏—Ü–∞ –ø—Ä–æ–∫—Ä—É—á–∏–≤–∞–ª–∞—Å—å –≤–Ω–∏–∑ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ  
**–†–µ—à–µ–Ω–∏–µ:** –£—Å–ª–æ–≤–Ω–∞—è –ø—Ä–æ–∫—Ä—É—Ç–∫–∞ - —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–Ω–∏–∑—É

### üìà –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

**–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:**
- –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–æ—Å—Ç—É–ø–∞
- –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –≥–∏–¥–∞ –≤ `localStorage`
- –õ–µ–Ω–∏–≤–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π (–ø–æ 100 —à—Ç—É–∫)
- –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ SELECT –∑–∞–ø—Ä–æ—Å—ã (—Ç–æ–ª—å–∫–æ –Ω—É–∂–Ω—ã–µ –ø–æ–ª—è)

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- –í—Ä–µ–º—è –∑–∞–≥—Ä—É–∑–∫–∏ –ø–∞–Ω–µ–ª–∏ –≥–∏–¥–∞: < 500ms
- –í—Ä–µ–º—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è: < 200ms
- Real-time –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è: < 100ms

### üéØ –ò—Ç–æ–≥–∏

‚úÖ **–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ:**
- –ü–∞–Ω–µ–ª—å –≥–∏–¥–∞ —Å —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ–º –∫–æ–º–Ω–∞—Ç–∞–º–∏
- Real-time —á–∞—Ç —Å Pusher
- –ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –≤ —Å–æ–æ–±—â–µ–Ω–∏—è
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –ø–æ—Å–ª–µ —Ç—É—Ä–∞
- –ó–∞—â–∏—Ç–∞ –æ—Ç XSS –∞—Ç–∞–∫
- –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –∫ –ë–î
- –°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π UI/UX –¥–∏–∑–∞–π–Ω

‚úÖ **–¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏:**
- Pusher –¥–ª—è real-time
- Supabase –¥–ª—è –ë–î
- Next.js –¥–ª—è API
- React –¥–ª—è UI
- S3 –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –º–µ–¥–∏–∞

‚úÖ **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:**
- RLS –ø–æ–ª–∏—Ç–∏–∫–∏ –¥–ª—è –≥–∏–¥–æ–≤
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –≤ API
- XSS –∑–∞—â–∏—Ç–∞
- –°–∞–Ω–∏—Ç–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö

---

**–ê–≤—Ç–æ—Ä:** Daniel (Garten555)  
**–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞:** 27.10.2024  
**–¢–µ–∫—É—â–∞—è –≤–µ—Ä—Å–∏—è:** 2.6.0 (DEVELOPMENT)  
**–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ:** –î–µ–∫–∞–±—Ä—å 2024

